<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Turing.jl – Implementing samplers</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../tutorials/docs-07-for-developers-variational-inference/index.html" rel="prev">
<link href="../../assets/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<style>
  a {
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../theming/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://turinglang.org/" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/turing-logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="https://turinglang.org/">
    <span class="navbar-title">Turing.jl</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/docs-00-getting-started/"> 
<span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/00-introduction/"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/library/"> 
<span class="menu-text">Library API</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/news/"> 
<span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/team/"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://x.com/TuringLang" title="Turing Twitter" class="quarto-navigation-tool px-1" aria-label="Turing Twitter"><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/TuringLang/Turing.jl" title="Turing GitHub" class="quarto-navigation-tool px-1" aria-label="Turing GitHub"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../tutorials/docs-00-getting-started/index.html">Documentation</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html">For Developers (Inference)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-17-implementing-samplers/index.html">Implementing Samplers</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../tutorials/docs-00-getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using Turing - Modelling Syntax and Interface</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-00-getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-14-using-turing-quick-start/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick Start</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-12-using-turing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-09-using-turing-advanced/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Usage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-10-using-turing-autodiff/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-13-using-turing-performance-tips/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Performance Tips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-11-using-turing-dynamichmc/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using DynamicHMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-15-using-turing-sampler-viz/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-16-using-turing-external-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">External Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Using Turing - Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/00-introduction/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Turing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/01-gaussian-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/02-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/03-bayesian-neural-network/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/04-hidden-markov-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hidden Markov Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/05-linear-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/06-infinite-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Infinite Mixture Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/07-poisson-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Poisson Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/08-multinomial-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/09-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/10-bayesian-differential-equations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Differential Equations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/11-probabilistic-pca/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/13-seasonal-time-series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Time Series Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/15-gaussian-processes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Gaussian Processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/12-gplvm/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Process Latent Variable Models</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">For Developers (PPL)</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-01-contributing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Contribute</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-05-for-developers-compiler/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Turing Compiler Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/14-minituring/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Compiler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-06-for-developers-interface/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interface Guide</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">For Developers (Inference)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How Turing implements AbstractMCMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-17-implementing-samplers/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Implementing Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#quick-overview-of-mala" id="toc-quick-overview-of-mala" class="nav-link active" data-scroll-target="#quick-overview-of-mala">Quick overview of MALA</a></li>
  <li><a href="#what-we-need-from-a-model-logdensityproblems.jl" id="toc-what-we-need-from-a-model-logdensityproblems.jl" class="nav-link" data-scroll-target="#what-we-need-from-a-model-logdensityproblems.jl">What we need from a model: LogDensityProblems.jl</a></li>
  <li><a href="#implementing-mala-in-abstractmcmc.jl" id="toc-implementing-mala-in-abstractmcmc.jl" class="nav-link" data-scroll-target="#implementing-mala-in-abstractmcmc.jl">Implementing MALA in AbstractMCMC.jl</a></li>
  <li><a href="#using-our-sampler-with-turing.jl" id="toc-using-our-sampler-with-turing.jl" class="nav-link" data-scroll-target="#using-our-sampler-with-turing.jl">Using our sampler with Turing.jl</a>
  <ul class="collapse">
  <li><a href="#models-with-constrained-parameters" id="toc-models-with-constrained-parameters" class="nav-link" data-scroll-target="#models-with-constrained-parameters">Models with constrained parameters</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-17-implementing-samplers/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../tutorials/docs-00-getting-started/index.html">Documentation</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html">For Developers (Inference)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-17-implementing-samplers/index.html">Implementing Samplers</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Implementing samplers</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this tutorial, we’ll go through step-by-step how to implement a “simple” sampler in <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> in such a way that it can be easily applied to Turing.jl models.</p>
<p>In particular, we’re going to implement a version of <strong>Metropolis-adjusted Langevin (MALA)</strong>.</p>
<p>Note that we will implement this sampler in the <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> framework, completely “ignoring” Turing.jl until the very end of the tutorial, at which point we’ll use a single line of code to make the resulting sampler available to Turing.jl. This is to really drive home the point that one can implement samplers in a way that is accessible to all of Turing.jl’s users without having to use Turing.jl yourself.</p>
<section id="quick-overview-of-mala" class="level2">
<h2 class="anchored" data-anchor-id="quick-overview-of-mala">Quick overview of MALA</h2>
<p>We can view MALA as a single step of the leapfrog intergrator with resampling of momentum <span class="math inline">\(p\)</span> at every step. To make that statement a bit more concrete, we first define the <em>extended</em> target <span class="math inline">\(\bar{\gamma}(x, p)\)</span> as</p>
<p><span class="math display">\[\begin{equation*}
\log \bar{\gamma}(x, p) \propto \log \gamma(x) + \log \gamma_{\mathcal{N}(0, M)}(p)
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(\gamma_{\mathcal{N}(0, M)}\)</span> denotes the density for a zero-centered Gaussian with covariance matrix <span class="math inline">\(M\)</span>. We then consider targeting this joint distribution over both <span class="math inline">\(x\)</span> and <span class="math inline">\(p\)</span> as follows. First we define the map</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  L_{\epsilon}: \quad &amp; \mathbb{R}^d \times \mathbb{R}^d \to \mathbb{R}^d \times \mathbb{R}^d \\
  &amp; (x, p) \mapsto (\tilde{x}, \tilde{p}) := L_{\epsilon}(x, p)
\end{split}
\end{equation*}\]</span></p>
<p>as</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  p_{1 / 2} &amp;:= p + \frac{\epsilon}{2} \nabla \log \gamma(x) \\
  \tilde{x} &amp;:= x + \epsilon M^{-1} p_{1 /2 } \\
  p_1 &amp;:= p_{1 / 2} + \frac{\epsilon}{2} \nabla \log \gamma(\tilde{x}) \\
  \tilde{p} &amp;:= - p_1
\end{split}
\end{equation*}\]</span></p>
<p>This might be familiar for some readers as a single step of the Leapfrog integrator. We then define the MALA kernel as follows: given the current iterate <span class="math inline">\(x_i\)</span>, we sample the next iterate <span class="math inline">\(x_{i + 1}\)</span> as</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  p &amp;\sim \mathcal{N}(0, M) \\
  (\tilde{x}, \tilde{p}) &amp;:= L_{\epsilon}(x_i, p) \\
  \alpha &amp;:= \min \left\{ 1, \frac{\bar{\gamma}(\tilde{x}, \tilde{p})}{\bar{\gamma}(x_i, p)} \right\} \\
  x_{i + 1} &amp;:=
  \begin{cases}
    \tilde{x} \quad &amp; \text{ with prob. } \alpha \\
    x_i       \quad &amp; \text{ with prob. } 1 - \alpha
  \end{cases}
\end{split}
\end{equation*}\]</span></p>
<p>i.e.&nbsp;we accept the proposal <span class="math inline">\(\tilde{x}\)</span> with probability <span class="math inline">\(\alpha\)</span> and reject it, thus sticking with our current iterate, with probability <span class="math inline">\(1 - \alpha\)</span>.</p>
</section>
<section id="what-we-need-from-a-model-logdensityproblems.jl" class="level2">
<h2 class="anchored" data-anchor-id="what-we-need-from-a-model-logdensityproblems.jl">What we need from a model: <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a></h2>
<p>There are a few things we need from the “target” / “model” / density that we want to sample from:</p>
<ol type="1">
<li>We need access to log-density <em>evaluations</em> <span class="math inline">\(\log \gamma(x)\)</span> so we can compute the acceptance ratio involving <span class="math inline">\(\log \bar{\gamma}(x, p)\)</span>.</li>
<li>We need access to log-density <em>gradients</em> <span class="math inline">\(\nabla \log \gamma(x)\)</span> so we can compute the Leapfrog steps <span class="math inline">\(L_{\epsilon}(x, p)\)</span>.</li>
<li>We also need access to the “size” of the model so we can determine the size of <span class="math inline">\(M\)</span>.</li>
</ol>
<p>Luckily for us, there is a package called <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> which provides an interface for <em>exactly</em> this!</p>
<p>To demonstrate how one can implement the “<a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface”<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> we will use a simple Gaussian model as an example:</p>
<div id="4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogDensityProblems</span>: LogDensityProblems;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's define some type that represents the model.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IsotropicNormalModel{M<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean of the isotropic Gaussian"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    mean<span class="op">::</span><span class="dt">M</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Specifies what input length the model expects.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">dimension</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> <span class="fu">length</span>(model.mean)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Implementation of the log-density evaluation of the model.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> LogDensityProblems.<span class="fu">logdensity</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>, x<span class="op">::</span><span class="dt">AbstractVector{&lt;:Real}</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span> <span class="fu">sum</span>(abs2, x <span class="op">.-</span> model.mean) <span class="op">/</span> <span class="fl">2</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us all of the properties we want for our MALA sampler with the exception of the computation of the <em>gradient</em> <span class="math inline">\(\nabla \log \gamma(x)\)</span>. There is the method <code>LogDensityProblems.logdensity_and_gradient</code> which should return a 2-tuple where the first entry is the evaluation of the logdensity <span class="math inline">\(\log \gamma(x)\)</span> and the second entry is the gradient <span class="math inline">\(\nabla \log \gamma(x)\)</span>.</p>
<p>There are two ways to “implement” this method: 1) we implement it by hand, which is feasible in the case of our <code>IsotropicNormalModel</code>, or b) we defer the implementation of this to a automatic differentiation backend.</p>
<p>To implement it by hand we can simply do</p>
<div id="6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell LogDensityProblems.jl that first-order, i.e. gradient information, is available.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">capabilities</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> LogDensityProblems.<span class="fu">LogDensityOrder</span><span class="dt">{1}</span>()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement `logdensity_and_gradient`.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>, x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    logγ_x <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x <span class="op">=</span> <span class="op">-</span>x <span class="op">.*</span> (x <span class="op">-</span> model.mean)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> logγ_x, ∇logγ_x</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s just try it out:</p>
<div id="8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate the problem.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">IsotropicNormalModel</span>([<span class="op">-</span><span class="fl">5</span>., <span class="fl">0</span>., <span class="fl">5</span>.])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create some example input that we can test on.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>x_example <span class="op">=</span> <span class="fu">randn</span>(LogDensityProblems.<span class="fu">dimension</span>(model))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate!</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">logdensity</span>(model, x_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-29.887780959851725</code></pre>
</div>
</div>
<p>To defer it to an automatic differentiation backend, we can do</p>
<div id="10" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell LogDensityProblems.jl we only have access to 0-th order information.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">capabilities</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> LogDensityProblems.<span class="fu">LogDensityOrder</span><span class="dt">{0}</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `LogDensityProblemsAD`'s `ADgradient` in combination with some AD backend to implement `logdensity_and_gradient`.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogDensityProblemsAD</span>, <span class="bu">ADTypes</span>, <span class="bu">ForwardDiff</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>model_with_grad <span class="op">=</span> <span class="fu">ADgradient</span>(<span class="fu">AutoForwardDiff</span>(), model)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">logdensity</span>(model_with_grad, x_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-29.887780959851725</code></pre>
</div>
</div>
<p>We’ll continue with the second approach in this tutorial since this is typically what one does in practice, because there are better hobbies to spend time on than deriving gradients by hand.</p>
<p>At this point, one might wonder how we’re going to tie this back to Turing.jl in the end. Effectively, when working with inference methods that only require log-density evaluations and / or higher-order information of the log-density, Turing.jl actually converts the user-provided <code>Model</code> into an object implementing the above methods for <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>. As a result, most samplers provided by Turing.jl are actually implemented to work with <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>, enabling their use both <em>within</em> Turing.jl and <em>outside</em> of Turing.jl! Morever, there exists similar conversions for Stan through BridgeStan and Stan<a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>, which means that a sampler supporting the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface can easily be used on both Turing.jl <em>and</em> Stan models (in addition to user-provided models, as our <code>IsotropicNormalModel</code> above)!</p>
<p>Anyways, let’s move on to actually implementing the sampler.</p>
</section>
<section id="implementing-mala-in-abstractmcmc.jl" class="level2">
<h2 class="anchored" data-anchor-id="implementing-mala-in-abstractmcmc.jl">Implementing MALA in <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a></h2>
<p>Now that we’ve established that a model implementing the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface provides us with all the information we need from <span class="math inline">\(\log \gamma(x)\)</span>, we can address the question: given an object that implements the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface, how can we define a sampler for it?</p>
<p>We’re going to do this by making our sampler a sub-type of <code>AbstractMCMC.AbstractSampler</code> in addition to implementing a few methods from <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a>. Why? Because it gets us <em>a lot</em> of functionality for free, as we will see later.</p>
<p>Moreover, <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> provides a very natural interface for MCMC algorithms.</p>
<p>First, we’ll define our <code>MALA</code> type</p>
<div id="12" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">AbstractMCMC</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALA{T,A} <span class="op">&lt;:</span><span class="dt"> AbstractMCMC.AbstractSampler</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stepsize used in the leapfrog step"</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    ϵ_init<span class="op">::</span><span class="dt">T</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariance matrix used for the momentum"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    M_init<span class="op">::</span><span class="dt">A</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how we’ve added the suffix <code>_init</code> to both the stepsize and the covariance matrix. We’ve done this because a <code>AbstractMCMC.AbstractSampler</code> should be <em>immutable</em>. Of course there might be many scenarios where we want to allow something like the stepsize and / or the covariance matrix to vary between iterations, e.g.&nbsp;during the burn-in / adaptation phase of the sampling process we might want to adjust the parameters using statistics computed from these initial iterations. But information which can change between iterations <u>should not go in the sampler itself</u>! Instead, this information should go in the sampler <em>state</em>.</p>
<p>The sampler state should at the very least contain all the necessary information to perform the next MCMC iteration, but usually contains further information, e.g.&nbsp;quantities and statistics useful for evaluating whether the sampler has converged.</p>
<p>We will use the following sampler state for our <code>MALA</code> sampler:</p>
<div id="14" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALAState{A<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"current position"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">::</span><span class="dt">A</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This might seem overly redundant: we’re defining a type <code>MALAState</code> and it only contains a simple vector of reals. In this particular case we indeed could have dropped this and simply used a <code>AbstractVector{&lt;:Real}</code> as our sampler state, but typically, as we will see later, one wants to include other quantities in the sampler state. For example, if we also wanted to adapt the parameters of our <code>MALA</code>, e.g.&nbsp;alter the stepsize depending on acceptance rates, in which case we should also put <code>ϵ</code> in the state, but for now we’ll keep things simple.</p>
<p>We currently have two things:</p>
<ol type="1">
<li>A <code>AbstractMCMC.AbstractSampler</code> implementation called <code>MALA</code>.</li>
<li>A state <code>MALAState</code> for our sampler <code>MALA</code>.</li>
</ol>
<p>That means that we’re ready to implement the only thing that really matters: <code>AbstractMCMC.step</code>.</p>
<p><code>AbstractMCMC.step</code> defines the MCMC iteration of our <code>MALA</code> given the current <code>MALAState</code>. Specifically, the signature of the function is as follows:</p>
<div id="16" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The RNG to ensure reprodicibility.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The model that defines our target.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">::</span><span class="dt">AbstractMCMC.AbstractModel</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sampler for which we're taking a `step`.</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">AbstractMCMC.AbstractSampler</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The current sampler `state`.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    state;</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional keyword arguments that we may or may not need.</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, there is a specific <code>AbstractMCMC.AbstractModel</code> which is used to indicate that the model that is provided implements the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface: <code>AbstractMCMC.LogDensityModel</code>.</p>
<p>Since, as we discussed earlier, in our case we’re indeed going to work with types that support the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface, we’ll define <code>AbstractMCMC.step</code> for such a <code>AbstractMCMC.LogDensityModel</code>.</p>
<p>Note that <code>AbstractMCMC.LogDensityModel</code> has no other purpose; it has a single field called <code>logdensity</code>, and it does nothing else. But by wrapping the model in <code>AbstractMCMC.LogDensityModel</code>, it allows samplers which wants to work with <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> to define their <code>AbstractMCMC.step</code> on this type without running into method ambiguities.</p>
<p>All in all, that means that the signature for our <code>AbstractMCMC.step</code> is going to be the following:</p>
<div id="18" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `LogDensityModel` so we know we're working with LogDensityProblems.jl model.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Our sampler.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Our sampler state.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    state<span class="op">::</span><span class="dt">MALAState</span>;</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great! Now let’s actually implement the full <code>AbstractMCMC.step</code> for our <code>MALA</code>.</p>
<p>Let’s remind ourselves what we’re going to do:</p>
<ol type="1">
<li>Sample a new momentum <span class="math inline">\(p\)</span>.</li>
<li>Compute the log-density of the extended target <span class="math inline">\(\log \bar{\gamma}(x, p)\)</span>.</li>
<li>Take a single leapfrog step <span class="math inline">\((\tilde{x}, \tilde{p}) = L_{\epsilon}(x, p)\)</span>.</li>
<li>Accept or reject the proposed <span class="math inline">\((\tilde{x}, \tilde{p})\)</span>.</li>
</ol>
<p>All in all, this results in the following:</p>
<div id="20" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>: Random</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span>  <span class="co"># so we get the `MvNormal`</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    model_wrapper<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    state<span class="op">::</span><span class="dt">MALAState</span>;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the wrapped model which implements LogDensityProblems.jl.</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_wrapper.logdensity</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's just extract the sampler parameters to make our lives easier.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    ϵ <span class="op">=</span> sampler.ϵ_init</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sampler.M_init</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the current parameters.</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> state.x</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample the momentum.</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    p_dist <span class="op">=</span> <span class="fu">MvNormal</span>(<span class="fu">zeros</span>(LogDensityProblems.<span class="fu">dimension</span>(model)), M)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">rand</span>(rng, p_dist)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propose using a single leapfrog step.</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    x̃, p̃ <span class="op">=</span> <span class="fu">leapfrog_step</span>(model, x, p, ϵ, M)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accept or reject proposal.</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    logp <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x) <span class="op">+</span> <span class="fu">logpdf</span>(p_dist, p)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    logp̃ <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x̃) <span class="op">+</span> <span class="fu">logpdf</span>(p_dist, p̃)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    logα <span class="op">=</span> logp̃ <span class="op">-</span> logp</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    state_new <span class="op">=</span> <span class="cf">if</span> <span class="fu">log</span>(<span class="fu">rand</span>(rng)) <span class="op">&lt;</span> logα</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Accept.</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">MALAState</span>(x̃)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reject.</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">MALAState</span>(x)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the "sample" and the sampler state.</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> state_new.x, state_new</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fairly straight-forward.</p>
<p>Of course, we haven’t defined the <code>leapfrog_step</code> method yet, so let’s do that:</p>
<div id="22" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">leapfrog_step</span>(model, x, p, ϵ, M)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update momentum `p` using "position" `x`.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x <span class="op">=</span> <span class="fu">last</span>(LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model, x))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    p1 <span class="op">=</span> p <span class="op">+</span> (ϵ <span class="op">/</span> <span class="fl">2</span>) <span class="op">.*</span> ∇logγ_x</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the "position" `x` using momentum `p1`.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    x̃ <span class="op">=</span> x <span class="op">+</span> ϵ <span class="op">.*</span> (M <span class="op">\</span> p1)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update momentum `p1` using position `x̃`</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x̃ <span class="op">=</span> <span class="fu">last</span>(LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model, x̃))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> p <span class="op">+</span> (ϵ <span class="op">/</span> <span class="fl">2</span>) <span class="op">.*</span> ∇logγ_x̃</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flip momentum `p2`.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    p̃ <span class="op">=</span> <span class="op">-</span>p2</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x̃, p̃</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>leapfrog_step (generic function with 1 method)</code></pre>
</div>
</div>
<p>With all of this, we’re technically ready to sample!</p>
<div id="24" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>, <span class="bu">LinearAlgebra</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> <span class="fu">MALA</span>(<span class="fl">1</span>, I)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> <span class="fu">MALAState</span>(<span class="fu">zeros</span>(LogDensityProblems.<span class="fu">dimension</span>(model)))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>x_next, state_next <span class="op">=</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    rng,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    AbstractMCMC.<span class="fu">LogDensityModel</span>(model),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    sampler,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    state</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.0, 0.0, 0.0], MALAState{Vector{Float64}}([0.0, 0.0, 0.0]))</code></pre>
</div>
</div>
<p>Great, it works!</p>
<p>And I promised we would get quite some functionality for free if we implemented <code>AbstractMCMC.step</code>, and so we can now simply call <code>sample</code> to perform standard MCMC sampling:</p>
<div id="26" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform 1000 iterations with our `MALA` sampler.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model_with_grad, sampler, <span class="fl">10_000</span>; initial_state<span class="op">=</span>state, progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate into a matrix.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>samples_matrix <span class="op">=</span> <span class="fu">stack</span>(samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×10000 Matrix{Float64}:
 -1.83127  -3.53778  -4.68964   -5.28583   …  -5.43938  -5.97026   -4.53712
 -3.21861  -2.40644  -0.778736  -0.731019     -1.69233  -0.542542  -1.6297
  1.80414   1.96681   3.88003    4.38973       5.05671   4.72192    5.08464</code></pre>
</div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the marginal means and standard deviations.</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hcat</span>(<span class="fu">mean</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>), <span class="fu">std</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×2 Matrix{Float64}:
 -5.01676   1.04231
  0.038474  1.05219
  4.99449   1.0413</code></pre>
</div>
</div>
<p>Let’s visualize the samples</p>
<div id="30" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StatsPlots</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">transpose</span>(samples_matrix[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">:</span><span class="kw">end</span>]), alpha<span class="op">=</span><span class="fl">0.5</span>, legend<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip630">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip630)" d="M0 1920 L2688 1920 L2688 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip631">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip630)" d="M151.747 1800.78 L2640.76 1800.78 L2640.76 47.2441 L151.747 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip632">
    <rect x="151" y="47" width="2490" height="1755"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="219.84,1800.78 219.84,47.2441 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="807.458,1800.78 807.458,47.2441 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1395.08,1800.78 1395.08,47.2441 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1982.69,1800.78 1982.69,47.2441 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2570.31,1800.78 2570.31,47.2441 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="219.84,1800.78 219.84,1781.88 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="807.458,1800.78 807.458,1781.88 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1395.08,1800.78 1395.08,1781.88 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1982.69,1800.78 1982.69,1781.88 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2570.31,1800.78 2570.31,1781.88 "></polyline>
<path clip-path="url(#clip630)" d="M219.84 1834 Q216.229 1834 214.4 1837.57 Q212.595 1841.11 212.595 1848.24 Q212.595 1855.34 214.4 1858.91 Q216.229 1862.45 219.84 1862.45 Q223.474 1862.45 225.28 1858.91 Q227.108 1855.34 227.108 1848.24 Q227.108 1841.11 225.28 1837.57 Q223.474 1834 219.84 1834 M219.84 1830.3 Q225.65 1830.3 228.706 1834.9 Q231.784 1839.49 231.784 1848.24 Q231.784 1856.96 228.706 1861.57 Q225.65 1866.15 219.84 1866.15 Q214.03 1866.15 210.951 1861.57 Q207.896 1856.96 207.896 1848.24 Q207.896 1839.49 210.951 1834.9 Q214.03 1830.3 219.84 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M771.15 1861.55 L787.47 1861.55 L787.47 1865.48 L765.525 1865.48 L765.525 1861.55 Q768.187 1858.79 772.771 1854.16 Q777.377 1849.51 778.558 1848.17 Q780.803 1845.65 781.683 1843.91 Q782.585 1842.15 782.585 1840.46 Q782.585 1837.71 780.641 1835.97 Q778.72 1834.23 775.618 1834.23 Q773.419 1834.23 770.965 1835 Q768.535 1835.76 765.757 1837.31 L765.757 1832.59 Q768.581 1831.46 771.035 1830.88 Q773.488 1830.3 775.525 1830.3 Q780.896 1830.3 784.09 1832.98 Q787.285 1835.67 787.285 1840.16 Q787.285 1842.29 786.474 1844.21 Q785.687 1846.11 783.581 1848.7 Q783.002 1849.37 779.9 1852.59 Q776.798 1855.78 771.15 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M797.331 1830.92 L815.687 1830.92 L815.687 1834.86 L801.613 1834.86 L801.613 1843.33 Q802.632 1842.98 803.65 1842.82 Q804.669 1842.64 805.687 1842.64 Q811.474 1842.64 814.854 1845.81 Q818.233 1848.98 818.233 1854.4 Q818.233 1859.97 814.761 1863.08 Q811.289 1866.15 804.97 1866.15 Q802.794 1866.15 800.525 1865.78 Q798.28 1865.41 795.872 1864.67 L795.872 1859.97 Q797.956 1861.11 800.178 1861.66 Q802.4 1862.22 804.877 1862.22 Q808.882 1862.22 811.22 1860.11 Q813.558 1858.01 813.558 1854.4 Q813.558 1850.78 811.22 1848.68 Q808.882 1846.57 804.877 1846.57 Q803.002 1846.57 801.127 1846.99 Q799.275 1847.4 797.331 1848.28 L797.331 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M837.446 1834 Q833.835 1834 832.007 1837.57 Q830.201 1841.11 830.201 1848.24 Q830.201 1855.34 832.007 1858.91 Q833.835 1862.45 837.446 1862.45 Q841.081 1862.45 842.886 1858.91 Q844.715 1855.34 844.715 1848.24 Q844.715 1841.11 842.886 1837.57 Q841.081 1834 837.446 1834 M837.446 1830.3 Q843.256 1830.3 846.312 1834.9 Q849.391 1839.49 849.391 1848.24 Q849.391 1856.96 846.312 1861.57 Q843.256 1866.15 837.446 1866.15 Q831.636 1866.15 828.557 1861.57 Q825.502 1856.96 825.502 1848.24 Q825.502 1839.49 828.557 1834.9 Q831.636 1830.3 837.446 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M1354.69 1830.92 L1373.05 1830.92 L1373.05 1834.86 L1358.98 1834.86 L1358.98 1843.33 Q1360 1842.98 1361.01 1842.82 Q1362.03 1842.64 1363.05 1842.64 Q1368.84 1842.64 1372.22 1845.81 Q1375.6 1848.98 1375.6 1854.4 Q1375.6 1859.97 1372.12 1863.08 Q1368.65 1866.15 1362.33 1866.15 Q1360.16 1866.15 1357.89 1865.78 Q1355.64 1865.41 1353.24 1864.67 L1353.24 1859.97 Q1355.32 1861.11 1357.54 1861.66 Q1359.76 1862.22 1362.24 1862.22 Q1366.25 1862.22 1368.58 1860.11 Q1370.92 1858.01 1370.92 1854.4 Q1370.92 1850.78 1368.58 1848.68 Q1366.25 1846.57 1362.24 1846.57 Q1360.37 1846.57 1358.49 1846.99 Q1356.64 1847.4 1354.69 1848.28 L1354.69 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M1394.81 1834 Q1391.2 1834 1389.37 1837.57 Q1387.56 1841.11 1387.56 1848.24 Q1387.56 1855.34 1389.37 1858.91 Q1391.2 1862.45 1394.81 1862.45 Q1398.44 1862.45 1400.25 1858.91 Q1402.08 1855.34 1402.08 1848.24 Q1402.08 1841.11 1400.25 1837.57 Q1398.44 1834 1394.81 1834 M1394.81 1830.3 Q1400.62 1830.3 1403.68 1834.9 Q1406.75 1839.49 1406.75 1848.24 Q1406.75 1856.96 1403.68 1861.57 Q1400.62 1866.15 1394.81 1866.15 Q1389 1866.15 1385.92 1861.57 Q1382.87 1856.96 1382.87 1848.24 Q1382.87 1839.49 1385.92 1834.9 Q1389 1830.3 1394.81 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M1424.97 1834 Q1421.36 1834 1419.53 1837.57 Q1417.73 1841.11 1417.73 1848.24 Q1417.73 1855.34 1419.53 1858.91 Q1421.36 1862.45 1424.97 1862.45 Q1428.61 1862.45 1430.41 1858.91 Q1432.24 1855.34 1432.24 1848.24 Q1432.24 1841.11 1430.41 1837.57 Q1428.61 1834 1424.97 1834 M1424.97 1830.3 Q1430.78 1830.3 1433.84 1834.9 Q1436.92 1839.49 1436.92 1848.24 Q1436.92 1856.96 1433.84 1861.57 Q1430.78 1866.15 1424.97 1866.15 Q1419.16 1866.15 1416.08 1861.57 Q1413.03 1856.96 1413.03 1848.24 Q1413.03 1839.49 1416.08 1834.9 Q1419.16 1830.3 1424.97 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M1940.97 1830.92 L1963.19 1830.92 L1963.19 1832.91 L1950.65 1865.48 L1945.76 1865.48 L1957.57 1834.86 L1940.97 1834.86 L1940.97 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M1972.36 1830.92 L1990.71 1830.92 L1990.71 1834.86 L1976.64 1834.86 L1976.64 1843.33 Q1977.66 1842.98 1978.68 1842.82 Q1979.7 1842.64 1980.72 1842.64 Q1986.5 1842.64 1989.88 1845.81 Q1993.26 1848.98 1993.26 1854.4 Q1993.26 1859.97 1989.79 1863.08 Q1986.32 1866.15 1980 1866.15 Q1977.82 1866.15 1975.55 1865.78 Q1973.31 1865.41 1970.9 1864.67 L1970.9 1859.97 Q1972.98 1861.11 1975.21 1861.66 Q1977.43 1862.22 1979.9 1862.22 Q1983.91 1862.22 1986.25 1860.11 Q1988.59 1858.01 1988.59 1854.4 Q1988.59 1850.78 1986.25 1848.68 Q1983.91 1846.57 1979.9 1846.57 Q1978.03 1846.57 1976.15 1846.99 Q1974.3 1847.4 1972.36 1848.28 L1972.36 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M2012.47 1834 Q2008.86 1834 2007.03 1837.57 Q2005.23 1841.11 2005.23 1848.24 Q2005.23 1855.34 2007.03 1858.91 Q2008.86 1862.45 2012.47 1862.45 Q2016.11 1862.45 2017.91 1858.91 Q2019.74 1855.34 2019.74 1848.24 Q2019.74 1841.11 2017.91 1837.57 Q2016.11 1834 2012.47 1834 M2012.47 1830.3 Q2018.28 1830.3 2021.34 1834.9 Q2024.42 1839.49 2024.42 1848.24 Q2024.42 1856.96 2021.34 1861.57 Q2018.28 1866.15 2012.47 1866.15 Q2006.66 1866.15 2003.59 1861.57 Q2000.53 1856.96 2000.53 1848.24 Q2000.53 1839.49 2003.59 1834.9 Q2006.66 1830.3 2012.47 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M2514.84 1861.55 L2522.48 1861.55 L2522.48 1835.18 L2514.17 1836.85 L2514.17 1832.59 L2522.43 1830.92 L2527.11 1830.92 L2527.11 1861.55 L2534.75 1861.55 L2534.75 1865.48 L2514.84 1865.48 L2514.84 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M2554.19 1834 Q2550.58 1834 2548.75 1837.57 Q2546.94 1841.11 2546.94 1848.24 Q2546.94 1855.34 2548.75 1858.91 Q2550.58 1862.45 2554.19 1862.45 Q2557.82 1862.45 2559.63 1858.91 Q2561.46 1855.34 2561.46 1848.24 Q2561.46 1841.11 2559.63 1837.57 Q2557.82 1834 2554.19 1834 M2554.19 1830.3 Q2560 1830.3 2563.06 1834.9 Q2566.13 1839.49 2566.13 1848.24 Q2566.13 1856.96 2563.06 1861.57 Q2560 1866.15 2554.19 1866.15 Q2548.38 1866.15 2545.3 1861.57 Q2542.25 1856.96 2542.25 1848.24 Q2542.25 1839.49 2545.3 1834.9 Q2548.38 1830.3 2554.19 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M2584.35 1834 Q2580.74 1834 2578.91 1837.57 Q2577.11 1841.11 2577.11 1848.24 Q2577.11 1855.34 2578.91 1858.91 Q2580.74 1862.45 2584.35 1862.45 Q2587.99 1862.45 2589.79 1858.91 Q2591.62 1855.34 2591.62 1848.24 Q2591.62 1841.11 2589.79 1837.57 Q2587.99 1834 2584.35 1834 M2584.35 1830.3 Q2590.16 1830.3 2593.22 1834.9 Q2596.3 1839.49 2596.3 1848.24 Q2596.3 1856.96 2593.22 1861.57 Q2590.16 1866.15 2584.35 1866.15 Q2578.54 1866.15 2575.46 1861.57 Q2572.41 1856.96 2572.41 1848.24 Q2572.41 1839.49 2575.46 1834.9 Q2578.54 1830.3 2584.35 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M2614.51 1834 Q2610.9 1834 2609.07 1837.57 Q2607.27 1841.11 2607.27 1848.24 Q2607.27 1855.34 2609.07 1858.91 Q2610.9 1862.45 2614.51 1862.45 Q2618.15 1862.45 2619.95 1858.91 Q2621.78 1855.34 2621.78 1848.24 Q2621.78 1841.11 2619.95 1837.57 Q2618.15 1834 2614.51 1834 M2614.51 1830.3 Q2620.32 1830.3 2623.38 1834.9 Q2626.46 1839.49 2626.46 1848.24 Q2626.46 1856.96 2623.38 1861.57 Q2620.32 1866.15 2614.51 1866.15 Q2608.7 1866.15 2605.62 1861.57 Q2602.57 1856.96 2602.57 1848.24 Q2602.57 1839.49 2605.62 1834.9 Q2608.7 1830.3 2614.51 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,1540.92 2640.76,1540.92 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,1232.06 2640.76,1232.06 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,923.194 2640.76,923.194 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,614.331 2640.76,614.331 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,305.468 2640.76,305.468 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1800.78 151.747,47.2441 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1540.92 170.644,1540.92 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1232.06 170.644,1232.06 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,923.194 170.644,923.194 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,614.331 170.644,614.331 "></polyline>
<polyline clip-path="url(#clip630)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,305.468 170.644,305.468 "></polyline>
<path clip-path="url(#clip630)" d="M49.5521 1541.37 L79.2279 1541.37 L79.2279 1545.31 L49.5521 1545.31 L49.5521 1541.37 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M99.8991 1539.06 Q96.7509 1539.06 94.8991 1541.21 Q93.0704 1543.36 93.0704 1547.11 Q93.0704 1550.84 94.8991 1553.01 Q96.7509 1555.17 99.8991 1555.17 Q103.047 1555.17 104.876 1553.01 Q106.728 1550.84 106.728 1547.11 Q106.728 1543.36 104.876 1541.21 Q103.047 1539.06 99.8991 1539.06 M109.181 1524.4 L109.181 1528.66 Q107.422 1527.83 105.617 1527.39 Q103.834 1526.95 102.075 1526.95 Q97.4454 1526.95 94.9917 1530.08 Q92.5612 1533.2 92.2139 1539.52 Q93.5797 1537.51 95.6398 1536.44 Q97.7 1535.35 100.177 1535.35 Q105.385 1535.35 108.394 1538.52 Q111.427 1541.67 111.427 1547.11 Q111.427 1552.44 108.279 1555.65 Q105.131 1558.87 99.8991 1558.87 Q93.9037 1558.87 90.7325 1554.29 Q87.5612 1549.68 87.5612 1540.95 Q87.5612 1532.76 91.45 1527.9 Q95.3389 1523.02 101.89 1523.02 Q103.649 1523.02 105.431 1523.36 Q107.237 1523.71 109.181 1524.4 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M50.3623 1232.51 L80.0381 1232.51 L80.0381 1236.44 L50.3623 1236.44 L50.3623 1232.51 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M104.297 1230.7 Q107.654 1231.42 109.529 1233.69 Q111.427 1235.96 111.427 1239.29 Q111.427 1244.41 107.908 1247.21 Q104.39 1250.01 97.9083 1250.01 Q95.7324 1250.01 93.4176 1249.57 Q91.126 1249.15 88.6723 1248.3 L88.6723 1243.78 Q90.6167 1244.92 92.9315 1245.49 Q95.2463 1246.07 97.7695 1246.07 Q102.168 1246.07 104.459 1244.34 Q106.774 1242.6 106.774 1239.29 Q106.774 1236.24 104.621 1234.52 Q102.492 1232.79 98.6722 1232.79 L94.6445 1232.79 L94.6445 1228.94 L98.8574 1228.94 Q102.306 1228.94 104.135 1227.58 Q105.964 1226.19 105.964 1223.6 Q105.964 1220.93 104.066 1219.52 Q102.191 1218.09 98.6722 1218.09 Q96.7509 1218.09 94.5519 1218.5 Q92.3528 1218.92 89.7139 1219.8 L89.7139 1215.63 Q92.376 1214.89 94.6908 1214.52 Q97.0287 1214.15 99.0889 1214.15 Q104.413 1214.15 107.515 1216.58 Q110.617 1218.99 110.617 1223.11 Q110.617 1225.98 108.973 1227.97 Q107.33 1229.94 104.297 1230.7 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M99.4824 908.993 Q95.8713 908.993 94.0426 912.558 Q92.2371 916.099 92.2371 923.229 Q92.2371 930.335 94.0426 933.9 Q95.8713 937.442 99.4824 937.442 Q103.117 937.442 104.922 933.9 Q106.751 930.335 106.751 923.229 Q106.751 916.099 104.922 912.558 Q103.117 908.993 99.4824 908.993 M99.4824 905.289 Q105.293 905.289 108.348 909.895 Q111.427 914.479 111.427 923.229 Q111.427 931.956 108.348 936.562 Q105.293 941.145 99.4824 941.145 Q93.6723 941.145 90.5936 936.562 Q87.538 931.956 87.538 923.229 Q87.538 914.479 90.5936 909.895 Q93.6723 905.289 99.4824 905.289 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M104.297 612.977 Q107.654 613.694 109.529 615.963 Q111.427 618.231 111.427 621.565 Q111.427 626.68 107.908 629.481 Q104.39 632.282 97.9083 632.282 Q95.7324 632.282 93.4176 631.842 Q91.126 631.426 88.6723 630.569 L88.6723 626.055 Q90.6167 627.19 92.9315 627.768 Q95.2463 628.347 97.7695 628.347 Q102.168 628.347 104.459 626.611 Q106.774 624.875 106.774 621.565 Q106.774 618.509 104.621 616.796 Q102.492 615.06 98.6722 615.06 L94.6445 615.06 L94.6445 611.218 L98.8574 611.218 Q102.306 611.218 104.135 609.852 Q105.964 608.463 105.964 605.87 Q105.964 603.208 104.066 601.796 Q102.191 600.361 98.6722 600.361 Q96.7509 600.361 94.5519 600.778 Q92.3528 601.194 89.7139 602.074 L89.7139 597.907 Q92.376 597.167 94.6908 596.796 Q97.0287 596.426 99.0889 596.426 Q104.413 596.426 107.515 598.857 Q110.617 601.264 110.617 605.384 Q110.617 608.255 108.973 610.245 Q107.33 612.213 104.297 612.977 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip630)" d="M99.8991 303.605 Q96.7509 303.605 94.8991 305.757 Q93.0704 307.91 93.0704 311.66 Q93.0704 315.387 94.8991 317.563 Q96.7509 319.716 99.8991 319.716 Q103.047 319.716 104.876 317.563 Q106.728 315.387 106.728 311.66 Q106.728 307.91 104.876 305.757 Q103.047 303.605 99.8991 303.605 M109.181 288.952 L109.181 293.211 Q107.422 292.378 105.617 291.938 Q103.834 291.498 102.075 291.498 Q97.4454 291.498 94.9917 294.623 Q92.5612 297.748 92.2139 304.068 Q93.5797 302.054 95.6398 300.989 Q97.7 299.901 100.177 299.901 Q105.385 299.901 108.394 303.072 Q111.427 306.22 111.427 311.66 Q111.427 316.984 108.279 320.202 Q105.131 323.419 99.8991 323.419 Q93.9037 323.419 90.7325 318.836 Q87.5612 314.229 87.5612 305.503 Q87.5612 297.308 91.45 292.447 Q95.3389 287.563 101.89 287.563 Q103.649 287.563 105.431 287.91 Q107.237 288.257 109.181 288.952 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip632)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,1111.73 224.541,1403.13 226.891,1556.47 229.242,1407.21 231.592,1497.1 233.943,1251.44 236.293,1340.08 238.644,1378.08 240.994,1358.51 243.345,1325.36 245.695,1421.28 248.046,1395.16 250.396,1477.92 252.747,1528.45 255.097,1428.64 257.448,1519.43 259.798,1465.85 262.148,1613.97 264.499,1526.39 266.849,1517.45 269.2,1548.41 271.55,1308.04 273.901,1340.54 276.251,1597.43 278.602,1327.36 280.952,1406.56 283.303,1426.44 285.653,1376.53 288.004,1474.53 290.354,1565.34 292.705,1400.46 295.055,1601.2 297.406,1543.14 299.756,1473.45 302.107,1495.89 304.457,1407.27 306.807,1297.23 309.158,1461.52 311.508,1471.45 313.859,1410.95 316.209,1241.05 318.56,1477.46 320.91,1538.06 323.261,1525.05 325.611,1317.78 327.962,1286.67 330.312,1479.6 332.663,1330.42 335.013,1409.53 337.364,1285.44 339.714,1367.59 342.065,1348.12 344.415,1449.07 346.765,1304.53 349.116,1418.59 351.466,1571.95 353.817,1405.4 356.167,1427.84 358.518,1507.21 360.868,1497.77 363.219,1411.59 365.569,1439.21 367.92,1390.52 370.27,1373.13 372.621,1575.36 374.971,1633.02 377.322,1471.65 379.672,1401.88 382.023,1539.23 384.373,1480.72 386.724,1453.19 389.074,1685.97 391.424,1554.42 393.775,1464.98 396.125,1487.38 398.476,1497.37 400.826,1482.95 403.177,1454.94 405.527,1446.1 407.878,1510.22 410.228,1297.34 412.579,1400.35 414.929,1563.82 417.28,1514.6 419.63,1438.9 421.981,1368.98 424.331,1616.82 426.682,1381.19 429.032,1383.99 431.382,1408.51 433.733,1561.63 436.083,1370.34 438.434,1414.08 440.784,1360.75 443.135,1237.73 445.485,1467.54 447.836,1585.56 450.186,1650.09 452.537,1452.81 454.887,1283.35 457.238,1441.49 459.588,1436.45 461.939,1408.94 464.289,1470.36 466.64,1368.83 468.99,1339.34 471.341,1212.49 473.691,1102.25 476.041,1430.74 478.392,1393.98 480.742,1368.19 483.093,1583.34 485.443,1475.76 487.794,1330.19 490.144,1374.49 492.495,1340.25 494.845,1377.91 497.196,1497.23 499.546,1550.45 501.897,1536.77 504.247,1566.59 506.598,1333.96 508.948,1410.19 511.299,1470.09 513.649,1336.61 515.999,1452.46 518.35,1539 520.7,1374.36 523.051,1487.77 525.401,1389.16 527.752,1610.4 530.102,1349.17 532.453,1619.5 534.803,1596.42 537.154,1310.37 539.504,1609.16 541.855,1373.15 544.205,1471.17 546.556,1440.07 548.906,1538.39 551.257,1441.67 553.607,1600.23 555.958,1560.56 558.308,1452.05 560.658,1712.72 563.009,1435.62 565.359,1212.99 567.71,1528.39 570.06,1447.03 572.411,1523.24 574.761,1656.39 577.112,1590.33 579.462,1557.39 581.813,1464.93 584.163,1437.83 586.514,1383.34 588.864,1558.07 591.215,1280.5 593.565,1441.25 595.916,1407.11 598.266,1494.1 600.616,1480.54 602.967,1477.66 605.317,1328.42 607.668,1500.77 610.018,1353.86 612.369,1627.16 614.719,1388.51 617.07,1316.46 619.42,1366.77 621.771,1658.29 624.121,1453.54 626.472,1523.66 628.822,1303.68 631.173,1645.24 633.523,1513.94 635.874,1312.43 638.224,1431.45 640.575,1509.31 642.925,1375.59 645.275,1420.18 647.626,1330.84 649.976,1586.22 652.327,1445.47 654.677,1378.06 657.028,1541.98 659.378,1483.1 661.729,1352.8 664.079,1416.01 666.43,1551.94 668.78,1351.98 671.131,1678.63 673.481,1271.78 675.832,1535.65 678.182,1322.4 680.533,1469.75 682.883,1361.92 685.233,1656.54 687.584,1441.56 689.934,1388.64 692.285,1306.06 694.635,1249.84 696.986,1418.51 699.336,1450.77 701.687,1551.53 704.037,1467.39 706.388,1289.47 708.738,1611.26 711.089,1434.79 713.439,1355.32 715.79,1374.91 718.14,1456.93 720.491,1429.18 722.841,1541.96 725.192,1252.22 727.542,1499.81 729.892,1551.69 732.243,1255.76 734.593,1592.91 736.944,1660.94 739.294,1398.1 741.645,1485.75 743.995,1502.23 746.346,1288.53 748.696,1378.82 751.047,1332.86 753.397,1503.23 755.748,1322.77 758.098,1544.91 760.449,1251.57 762.799,1488.25 765.15,1578.25 767.5,1442.06 769.85,1256.5 772.201,1457.61 774.551,1505.27 776.902,1405.05 779.252,1550.22 781.603,1376.31 783.953,1602.96 786.304,1462.23 788.654,1598.51 791.005,1478.45 793.355,1511.84 795.706,1476.43 798.056,1584.93 800.407,1395.6 802.757,1244.86 805.108,1379.08 807.458,1570.06 809.809,1351.31 812.159,1572.05 814.509,1333.87 816.86,1278.05 819.21,1423.97 821.561,1327.24 823.911,1610.56 826.262,1446.9 828.612,1306.27 830.963,1304.66 833.313,1249.64 835.664,1476.04 838.014,1502.97 840.365,1460.27 842.715,1398.23 845.066,1449.05 847.416,1477.94 849.767,1539.36 852.117,1479.01 854.467,1431.8 856.818,1179.38 859.168,1370.27 861.519,1290.85 863.869,1238.28 866.22,1343.95 868.57,1366.38 870.921,1518.16 873.271,1427.45 875.622,1483.03 877.972,1256.07 880.323,1346.92 882.673,1418.05 885.024,1397.7 887.374,1639.35 889.725,1601.2 892.075,1493.37 894.426,1395.75 896.776,1390.28 899.126,1391.19 901.477,1590.72 903.827,1462.91 906.178,1532.67 908.528,1682.32 910.879,1445.23 913.229,1448.06 915.58,1494.71 917.93,1407.11 920.281,1230.72 922.631,1347.41 924.982,1430.73 927.332,1492.36 929.683,1363.59 932.033,1420.64 934.384,1385.57 936.734,1443.99 939.084,1108.76 941.435,1295.98 943.785,1487.67 946.136,1443.96 948.486,1410.65 950.837,1537.45 953.187,1378.22 955.538,1480.45 957.888,1452.71 960.239,1334.84 962.589,1513.54 964.94,1342.66 967.29,1198.08 969.641,1483.41 971.991,1498.51 974.342,1406.55 976.692,1516.07 979.043,1503.43 981.393,1572.58 983.743,1509.06 986.094,1365.46 988.444,1436.78 990.795,1570.63 993.145,1496.41 995.496,1474.52 997.846,1546.48 1000.2,1499.47 1002.55,1355.67 1004.9,1530.56 1007.25,1380.88 1009.6,1550.85 1011.95,1407.82 1014.3,1467.73 1016.65,1361.42 1019,1422.24 1021.35,1276.92 1023.7,1514.83 1026.05,1363.67 1028.4,1637.57 1030.75,1333.18 1033.1,1341.64 1035.45,1342.34 1037.8,1358.09 1040.15,1455.51 1042.51,1596.53 1044.86,1461.91 1047.21,1531.7 1049.56,1430.68 1051.91,1503.97 1054.26,1318.02 1056.61,1352.98 1058.96,1357.58 1061.31,1576.02 1063.66,1555.16 1066.01,1317.05 1068.36,1417.75 1070.71,1424.22 1073.06,1343.09 1075.41,1382.65 1077.76,1678.24 1080.11,1256.89 1082.46,1571.61 1084.81,1306.21 1087.16,1473.88 1089.51,1429.57 1091.87,1478.44 1094.22,1430.35 1096.57,1429.27 1098.92,1404.13 1101.27,1362.79 1103.62,1547.75 1105.97,1495.65 1108.32,1506.06 1110.67,1536.31 1113.02,1266.88 1115.37,1489.13 1117.72,1328.3 1120.07,1559.88 1122.42,1566.23 1124.77,1446.15 1127.12,1612.4 1129.47,1564.46 1131.82,1398.63 1134.17,1389.35 1136.52,1491.41 1138.87,1440.07 1141.23,1546.42 1143.58,1426.8 1145.93,1388.16 1148.28,1547.79 1150.63,1334.54 1152.98,1226.49 1155.33,1550.12 1157.68,1503.27 1160.03,1480.35 1162.38,1395.76 1164.73,1393.68 1167.08,1410.94 1169.43,1421.67 1171.78,1300.05 1174.13,1260.61 1176.48,1377.39 1178.83,1504.02 1181.18,1387.18 1183.53,1451.18 1185.88,1651.04 1188.23,1493.42 1190.59,1433.66 1192.94,1331.96 1195.29,1479.44 1197.64,1408.73 1199.99,1514.85 1202.34,1700.37 1204.69,1547.47 1207.04,1572.31 1209.39,1602.54 1211.74,1548.07 1214.09,1367.96 1216.44,1403.96 1218.79,1378.26 1221.14,1615.79 1223.49,1416.29 1225.84,1321.38 1228.19,1444.14 1230.54,1407.65 1232.89,1409.94 1235.24,1531.76 1237.59,1491.77 1239.94,1336.59 1242.3,1297.38 1244.65,1319.35 1247,1502.65 1249.35,1330.56 1251.7,1452.58 1254.05,1373.29 1256.4,1600.8 1258.75,1518.35 1261.1,1269.28 1263.45,1570.79 1265.8,1341.28 1268.15,1494.4 1270.5,1430.92 1272.85,1465.94 1275.2,1435.25 1277.55,1646.45 1279.9,1426.52 1282.25,1622.71 1284.6,1418.38 1286.95,1675.47 1289.3,1499.03 1291.66,1483.38 1294.01,1238.65 1296.36,1271.65 1298.71,1330.52 1301.06,1556.23 1303.41,1434.89 1305.76,1388.28 1308.11,1498.58 1310.46,1727.35 1312.81,1487.04 1315.16,1469.41 1317.51,1403.82 1319.86,1506 1322.21,1539.27 1324.56,1287.1 1326.91,1458.84 1329.26,1537.48 1331.61,1538.77 1333.96,1497 1336.31,1544.8 1338.66,1533.4 1341.02,1506.96 1343.37,1488.92 1345.72,1469.92 1348.07,1474.91 1350.42,1468.61 1352.77,1502.71 1355.12,1363.97 1357.47,1382.81 1359.82,1441.4 1362.17,1514.24 1364.52,1542.07 1366.87,1496.17 1369.22,1587 1371.57,1503.39 1373.92,1435.17 1376.27,1203.61 1378.62,1355.38 1380.97,1406.97 1383.32,1519.2 1385.67,1502.15 1388.02,1412.7 1390.38,1523.73 1392.73,1345.24 1395.08,1431.1 1397.43,1456.27 1399.78,1311.87 1402.13,1602.09 1404.48,1292.9 1406.83,1597 1409.18,1424.22 1411.53,1314.86 1413.88,1491.02 1416.23,1429.14 1418.58,1415.2 1420.93,1532.4 1423.28,1509.45 1425.63,1337.59 1427.98,1435.38 1430.33,1374.96 1432.68,1635.41 1435.03,1465.21 1437.38,1496.44 1439.74,1541.18 1442.09,1423.44 1444.44,1709.86 1446.79,1526.46 1449.14,1530.95 1451.49,1324.47 1453.84,1295.27 1456.19,1424.36 1458.54,1300.9 1460.89,1505.84 1463.24,1283.16 1465.59,1466.43 1467.94,1599.13 1470.29,1457.91 1472.64,1384.52 1474.99,1359.32 1477.34,1427.01 1479.69,1527.97 1482.04,1579.17 1484.39,1531.09 1486.74,1315.84 1489.1,1365.43 1491.45,1717.31 1493.8,1340.71 1496.15,1288.5 1498.5,1432.24 1500.85,1382.66 1503.2,1527.98 1505.55,1513.64 1507.9,1532.79 1510.25,1600.97 1512.6,1419.89 1514.95,1390.42 1517.3,1414.36 1519.65,1393.83 1522,1332.79 1524.35,1372.17 1526.7,1491.18 1529.05,1408.56 1531.4,1394.5 1533.75,1566.6 1536.1,1283.03 1538.45,1536.46 1540.81,1592.85 1543.16,1465.45 1545.51,1486.25 1547.86,1220.78 1550.21,1453.78 1552.56,1470.86 1554.91,1462.02 1557.26,1477.51 1559.61,1497.19 1561.96,1435.82 1564.31,1393.41 1566.66,1431.72 1569.01,1547.44 1571.36,1511.37 1573.71,1519.42 1576.06,1361.61 1578.41,1520.8 1580.76,1423.68 1583.11,1450.7 1585.46,1545.96 1587.81,1514.36 1590.17,1486.46 1592.52,1540.46 1594.87,1320.75 1597.22,1346.38 1599.57,1555.82 1601.92,1630.18 1604.27,1363.48 1606.62,1454.2 1608.97,1359.64 1611.32,1418.37 1613.67,1402.22 1616.02,1529.17 1618.37,1332.42 1620.72,1557.45 1623.07,1623.47 1625.42,1396.65 1627.77,1344.99 1630.12,1287.85 1632.47,1354.31 1634.82,1443.88 1637.17,1221.71 1639.53,1357.97 1641.88,1509.86 1644.23,1348.62 1646.58,1184.79 1648.93,1425.64 1651.28,1405.45 1653.63,1340.36 1655.98,1451.4 1658.33,1385.92 1660.68,1440.97 1663.03,1536.44 1665.38,1471.14 1667.73,1541.99 1670.08,1484.9 1672.43,1603.08 1674.78,1451.8 1677.13,1387.91 1679.48,1382.66 1681.83,1234.43 1684.18,1517.72 1686.53,1290.93 1688.89,1544.94 1691.24,1573.41 1693.59,1326.37 1695.94,1250.94 1698.29,1423.43 1700.64,1450.62 1702.99,1523.54 1705.34,1359.28 1707.69,1349.88 1710.04,1363.57 1712.39,1415.77 1714.74,1427.37 1717.09,1502.28 1719.44,1479.94 1721.79,1337.35 1724.14,1499.81 1726.49,1330.67 1728.84,1337.05 1731.19,1524.6 1733.54,1226.46 1735.89,1463.67 1738.25,1411.56 1740.6,1680.28 1742.95,1404.03 1745.3,1465.3 1747.65,1581.94 1750,1360.39 1752.35,1461.01 1754.7,1589.58 1757.05,1609.71 1759.4,1602.54 1761.75,1564.52 1764.1,1274.06 1766.45,1669 1768.8,1391.03 1771.15,1476.92 1773.5,1548.84 1775.85,1534.67 1778.2,1280.44 1780.55,1253.41 1782.9,1398.04 1785.25,1258.74 1787.6,1513.23 1789.96,1507.59 1792.31,1469.88 1794.66,1268.16 1797.01,1414.4 1799.36,1659.64 1801.71,1411.47 1804.06,1355.98 1806.41,1339.67 1808.76,1427.85 1811.11,1524.1 1813.46,1356.66 1815.81,1428.92 1818.16,1423.3 1820.51,1494.17 1822.86,1540.83 1825.21,1312.52 1827.56,1362 1829.91,1497.98 1832.26,1526.44 1834.61,1225.29 1836.96,1464.15 1839.32,1478.42 1841.67,1512.11 1844.02,1615.86 1846.37,1685.69 1848.72,1356.63 1851.07,1474.2 1853.42,1325.37 1855.77,1505.83 1858.12,1314.13 1860.47,1530.61 1862.82,1532.76 1865.17,1502.16 1867.52,1422.92 1869.87,1362.8 1872.22,1401.74 1874.57,1480.69 1876.92,1303.92 1879.27,1693.54 1881.62,1499.84 1883.97,1400.79 1886.32,1516.46 1888.68,1366.38 1891.03,1517.27 1893.38,1413.57 1895.73,1615.05 1898.08,1368.42 1900.43,1631.14 1902.78,1318.89 1905.13,1457.98 1907.48,1413.58 1909.83,1323.12 1912.18,1328.78 1914.53,1292.56 1916.88,1536.18 1919.23,1351.83 1921.58,1245.21 1923.93,1555.51 1926.28,1249.55 1928.63,1476.68 1930.98,1229.68 1933.33,1434.32 1935.68,1496.51 1938.04,1450.47 1940.39,1372.27 1942.74,1486.49 1945.09,1419.57 1947.44,1597.88 1949.79,1413.18 1952.14,1343.47 1954.49,1465.73 1956.84,1456.99 1959.19,1359.43 1961.54,1360.85 1963.89,1501.03 1966.24,1587.11 1968.59,1292.87 1970.94,1600.53 1973.29,1452.34 1975.64,1344.73 1977.99,1458.03 1980.34,1452.74 1982.69,1450.93 1985.04,1479.99 1987.4,1304.81 1989.75,1518.44 1992.1,1587.36 1994.45,1642.73 1996.8,1547.82 1999.15,1398.82 2001.5,1368.07 2003.85,1499.46 2006.2,1385.68 2008.55,1561.54 2010.9,1453.38 2013.25,1382.85 2015.6,1693.7 2017.95,1467.81 2020.3,1505.23 2022.65,1458.7 2025,1405.04 2027.35,1377.88 2029.7,1429.92 2032.05,1456.91 2034.4,1473.68 2036.76,1291.17 2039.11,1485.27 2041.46,1290.66 2043.81,1344 2046.16,1448.23 2048.51,1547.14 2050.86,1392.72 2053.21,1286.32 2055.56,1400.31 2057.91,1368.28 2060.26,1406.98 2062.61,1516.06 2064.96,1558.2 2067.31,1614.06 2069.66,1418.74 2072.01,1420.98 2074.36,1444.83 2076.71,1311.66 2079.06,1384.31 2081.41,1446.72 2083.76,1342.4 2086.11,1420.65 2088.47,1577.97 2090.82,1311.8 2093.17,1553.46 2095.52,1335.96 2097.87,1401.71 2100.22,1336.09 2102.57,1599.9 2104.92,1323.2 2107.27,1359.7 2109.62,1579.44 2111.97,1522.2 2114.32,1464.83 2116.67,1370.36 2119.02,1304.32 2121.37,1488.28 2123.72,1362.98 2126.07,1277.29 2128.42,1359.65 2130.77,1239.79 2133.12,1398.14 2135.47,1587.54 2137.83,1512.23 2140.18,1433.85 2142.53,1461.77 2144.88,1539.73 2147.23,1530.27 2149.58,1329.93 2151.93,1559.42 2154.28,1483.83 2156.63,1385.94 2158.98,1326.74 2161.33,1437.48 2163.68,1610.48 2166.03,1563.65 2168.38,1330.28 2170.73,1355.05 2173.08,1559.98 2175.43,1283.33 2177.78,1438.88 2180.13,1363.23 2182.48,1441.57 2184.83,1586.18 2187.19,1599.55 2189.54,1480.58 2191.89,1463.47 2194.24,1265.17 2196.59,1385.42 2198.94,1413.64 2201.29,1484.97 2203.64,1424.42 2205.99,1523.47 2208.34,1518.05 2210.69,1554.64 2213.04,1514.19 2215.39,1445.09 2217.74,1341.84 2220.09,1425.82 2222.44,1447.8 2224.79,1449.12 2227.14,1514.68 2229.49,1322 2231.84,1343.09 2234.19,1405.75 2236.55,1731.42 2238.9,1468.96 2241.25,1503.25 2243.6,1447.3 2245.95,1597.58 2248.3,1503.13 2250.65,1449.89 2253,1288.54 2255.35,1458.94 2257.7,1288.91 2260.05,1439.41 2262.4,1501.33 2264.75,1353.97 2267.1,1550.57 2269.45,1540.36 2271.8,1276.81 2274.15,1481.98 2276.5,1314.31 2278.85,1612.94 2281.2,1511.99 2283.55,1262.47 2285.91,1375.5 2288.26,1497.39 2290.61,1480.4 2292.96,1596.96 2295.31,1336.34 2297.66,1343.65 2300.01,1472.9 2302.36,1494.86 2304.71,1427.34 2307.06,1390.02 2309.41,1282.91 2311.76,1363.33 2314.11,1362.01 2316.46,1429.45 2318.81,1337.75 2321.16,1402 2323.51,1316.32 2325.86,1456.2 2328.21,1405.94 2330.56,1280.94 2332.91,1476.26 2335.27,1650.13 2337.62,1576.57 2339.97,1491.58 2342.32,1364.43 2344.67,1475.69 2347.02,1398.81 2349.37,1539.28 2351.72,1539.16 2354.07,1494.37 2356.42,1480.49 2358.77,1530.19 2361.12,1406.99 2363.47,1405.9 2365.82,1454.03 2368.17,1429.21 2370.52,1530.8 2372.87,1255.23 2375.22,1509.48 2377.57,1483.78 2379.92,1487.72 2382.27,1448 2384.62,1321.4 2386.98,1426.09 2389.33,1435.59 2391.68,1442.28 2394.03,1403.34 2396.38,1564.17 2398.73,1562.85 2401.08,1345.58 2403.43,1368.69 2405.78,1378.11 2408.13,1532.78 2410.48,1432.07 2412.83,1289.74 2415.18,1391.31 2417.53,1398.59 2419.88,1404.72 2422.23,1535.91 2424.58,1440.23 2426.93,1390.2 2429.28,1420.5 2431.63,1314.3 2433.98,1347.29 2436.34,1575.61 2438.69,1428.61 2441.04,1259.06 2443.39,1401.82 2445.74,1678.14 2448.09,1312 2450.44,1306.13 2452.79,1365.89 2455.14,1296.06 2457.49,1363.12 2459.84,1448.99 2462.19,1343.05 2464.54,1467.06 2466.89,1497.12 2469.24,1368.46 2471.59,1403.4 2473.94,1437.98 2476.29,1501.82 2478.64,1463.68 2480.99,1525.89 2483.34,1342.71 2485.7,1568.95 2488.05,1376.1 2490.4,1573.73 2492.75,1455.68 2495.1,1538.21 2497.45,1751.15 2499.8,1536.44 2502.15,1475.79 2504.5,1438.55 2506.85,1569.45 2509.2,1444.08 2511.55,1394.79 2513.9,1563.24 2516.25,1313.25 2518.6,1564.83 2520.95,1376.93 2523.3,1401.48 2525.65,1326.87 2528,1318.45 2530.35,1444.39 2532.7,1447.19 2535.06,1356.3 2537.41,1497.39 2539.76,1454.53 2542.11,1459.43 2544.46,1319.06 2546.81,1469 2549.16,1322.7 2551.51,1338.34 2553.86,1659.65 2556.21,1322.86 2558.56,1427.42 2560.91,1678.83 2563.26,1334.02 2565.61,1384.02 2567.96,1446.17 2570.31,1421.82 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,1254.56 224.541,927.119 226.891,946.614 229.242,807.268 231.592,803.809 233.943,949.505 236.293,705.536 238.644,826.158 240.994,907.447 243.345,848.382 245.695,780.651 248.046,1004.75 250.396,950.712 252.747,865.987 255.097,825.883 257.448,882.078 259.798,835.643 262.148,844.593 264.499,938.042 266.849,958.34 269.2,951.244 271.55,968.525 273.901,1039.11 276.251,862.034 278.602,838.401 280.952,807.267 283.303,924.547 285.653,866.078 288.004,868.224 290.354,1114.27 292.705,900.254 295.055,814.35 297.406,675.476 299.756,1116.49 302.107,1027.52 304.457,903.625 306.807,923.707 309.158,772.499 311.508,902.173 313.859,883.839 316.209,756.416 318.56,873.386 320.91,789.59 323.261,856.921 325.611,981.324 327.962,1102.46 330.312,885.507 332.663,1046.5 335.013,898.345 337.364,1033.46 339.714,927.274 342.065,889.084 344.415,923.596 346.765,877.844 349.116,837.875 351.466,748.334 353.817,886.157 356.167,806.781 358.518,1044.82 360.868,933.18 363.219,856.117 365.569,835.49 367.92,918.412 370.27,716.997 372.621,773.523 374.971,774.189 377.322,901.844 379.672,854.465 382.023,726.498 384.373,988.95 386.724,996.642 389.074,770.224 391.424,1177.59 393.775,1042.21 396.125,966.842 398.476,917.75 400.826,905.073 403.177,1024.74 405.527,739.947 407.878,848.468 410.228,866.907 412.579,932.707 414.929,987.61 417.28,849.072 419.63,874.826 421.981,851.486 424.331,1026.21 426.682,948.11 429.032,973.369 431.382,797.957 433.733,1071.82 436.083,1050.76 438.434,824.173 440.784,908.096 443.135,1205.7 445.485,945.332 447.836,1086.3 450.186,926.198 452.537,794.07 454.887,880.198 457.238,901.993 459.588,869.834 461.939,852.03 464.289,971.569 466.64,1025.51 468.99,937.098 471.341,860.647 473.691,799.017 476.041,881.777 478.392,966.538 480.742,1034.22 483.093,770.181 485.443,1019.54 487.794,939.936 490.144,891.676 492.495,1050.44 494.845,983.343 497.196,1031.19 499.546,875.098 501.897,822.457 504.247,944.216 506.598,970.461 508.948,1000.53 511.299,804.526 513.649,830.324 515.999,856.113 518.35,1008.99 520.7,910.741 523.051,793.354 525.401,1078.7 527.752,959.386 530.102,823.84 532.453,1065.08 534.803,830.974 537.154,842.318 539.504,998.079 541.855,971.449 544.205,850.611 546.556,947.619 548.906,816.991 551.257,775.06 553.607,880.43 555.958,961.564 558.308,915.343 560.658,1033.28 563.009,838.102 565.359,993.193 567.71,929.734 570.06,1132.6 572.411,736.636 574.761,746.233 577.112,940.977 579.462,932.254 581.813,939.655 584.163,845.158 586.514,993.554 588.864,921.81 591.215,1053.42 593.565,782.344 595.916,919.424 598.266,939.12 600.616,770.781 602.967,879.141 605.317,683.66 607.668,1083.42 610.018,1075.33 612.369,736.875 614.719,660.11 617.07,889.986 619.42,945.101 621.771,796.534 624.121,842.444 626.472,953.56 628.822,1045.05 631.173,893.988 633.523,957.974 635.874,942.151 638.224,875.62 640.575,901.07 642.925,833.352 645.275,1037.36 647.626,832.883 649.976,952.631 652.327,826.243 654.677,934.138 657.028,926.92 659.378,865.774 661.729,730.497 664.079,710.026 666.43,755.111 668.78,875.635 671.131,906.795 673.481,909.432 675.832,869.477 678.182,966.643 680.533,893.987 682.883,1100.82 685.233,839.983 687.584,1054.89 689.934,1046.52 692.285,864.491 694.635,1017.25 696.986,890.311 699.336,822.2 701.687,1047.62 704.037,985.852 706.388,777.947 708.738,942.963 711.089,1040.2 713.439,859.992 715.79,940.943 718.14,933.185 720.491,916.209 722.841,1130.45 725.192,931.85 727.542,776.755 729.892,848.513 732.243,966.808 734.593,1105.74 736.944,779.829 739.294,897.981 741.645,954.059 743.995,842.646 746.346,811.465 748.696,1080.35 751.047,926.692 753.397,871.057 755.748,1032.32 758.098,871.457 760.449,1104.23 762.799,916.685 765.15,1006.61 767.5,946.938 769.85,869.763 772.201,733.057 774.551,626.184 776.902,993.662 779.252,944.845 781.603,910.603 783.953,1021.11 786.304,917.228 788.654,755.602 791.005,1133.19 793.355,963.024 795.706,1122.88 798.056,949.428 800.407,884.949 802.757,861.764 805.108,953.37 807.458,981.87 809.809,760.26 812.159,723.031 814.509,821.786 816.86,817.177 819.21,836.569 821.561,802.828 823.911,964.98 826.262,1071.54 828.612,855.935 830.963,865.649 833.313,889.478 835.664,795.27 838.014,932.02 840.365,952.878 842.715,950.234 845.066,1015.71 847.416,1016.45 849.767,980.673 852.117,931.466 854.467,788.626 856.818,944.783 859.168,842.02 861.519,1100.59 863.869,821.729 866.22,899.433 868.57,762.985 870.921,940.925 873.271,1110.82 875.622,901.243 877.972,1008.1 880.323,691.048 882.673,998.187 885.024,1059.12 887.374,928.41 889.725,867.201 892.075,902.96 894.426,827.972 896.776,887.635 899.126,958.688 901.477,942.542 903.827,747.99 906.178,913.869 908.528,869.598 910.879,913.233 913.229,828.131 915.58,935.863 917.93,972.049 920.281,932.199 922.631,985.313 924.982,954.569 927.332,858.92 929.683,914.905 932.033,957.535 934.384,992.955 936.734,944.797 939.084,894.125 941.435,787.02 943.785,902.944 946.136,993.348 948.486,837.589 950.837,1075.62 953.187,864.396 955.538,889.895 957.888,948.328 960.239,853.721 962.589,963.596 964.94,948.489 967.29,1003.17 969.641,986.491 971.991,845.062 974.342,906.741 976.692,862.163 979.043,1015.13 981.393,749.062 983.743,907.476 986.094,1016.25 988.444,932.394 990.795,798.645 993.145,642.001 995.496,996.309 997.846,1074.93 1000.2,925.631 1002.55,855.345 1004.9,864.44 1007.25,1100.03 1009.6,807.291 1011.95,987.298 1014.3,1001.19 1016.65,952.995 1019,968.019 1021.35,757.118 1023.7,993.773 1026.05,907.163 1028.4,784.988 1030.75,838.023 1033.1,921.693 1035.45,939.378 1037.8,860.442 1040.15,865.524 1042.51,1034.98 1044.86,980.989 1047.21,934.724 1049.56,1000.35 1051.91,856.485 1054.26,1013.44 1056.61,901.687 1058.96,779.404 1061.31,805 1063.66,874.262 1066.01,1064.61 1068.36,806.004 1070.71,1104.27 1073.06,893.772 1075.41,961.602 1077.76,939.125 1080.11,1006.92 1082.46,870.503 1084.81,1017.04 1087.16,972.873 1089.51,755.03 1091.87,956.935 1094.22,1016.9 1096.57,963.492 1098.92,907.561 1101.27,839.957 1103.62,997.561 1105.97,762.362 1108.32,1001.5 1110.67,841.071 1113.02,911.43 1115.37,808.431 1117.72,1036.53 1120.07,925.39 1122.42,907.114 1124.77,1078.79 1127.12,778.422 1129.47,851.852 1131.82,867.922 1134.17,779.08 1136.52,1031.68 1138.87,954.088 1141.23,953.026 1143.58,875.588 1145.93,947.233 1148.28,950.063 1150.63,866.27 1152.98,926.778 1155.33,951.844 1157.68,837.019 1160.03,782.96 1162.38,990.029 1164.73,934.797 1167.08,788.145 1169.43,967.493 1171.78,936.287 1174.13,780.885 1176.48,974.553 1178.83,828.097 1181.18,1199.98 1183.53,816.221 1185.88,891.525 1188.23,907.483 1190.59,1042.12 1192.94,1007.26 1195.29,737.629 1197.64,699.743 1199.99,916.56 1202.34,941.873 1204.69,952.772 1207.04,927.534 1209.39,1071.8 1211.74,1072.66 1214.09,952.114 1216.44,750.979 1218.79,893.714 1221.14,1042.97 1223.49,936.552 1225.84,971.262 1228.19,956.607 1230.54,759.847 1232.89,933.543 1235.24,886.693 1237.59,790.034 1239.94,1078.32 1242.3,1095.8 1244.65,921.524 1247,1058.14 1249.35,1021.47 1251.7,824.578 1254.05,1067.62 1256.4,1154.46 1258.75,881.018 1261.1,972.087 1263.45,1032.38 1265.8,972.764 1268.15,938.023 1270.5,819.651 1272.85,848.45 1275.2,914.193 1277.55,832.303 1279.9,871.813 1282.25,938.557 1284.6,920.647 1286.95,916.023 1289.3,1011.39 1291.66,870.879 1294.01,1130.31 1296.36,875.794 1298.71,898.447 1301.06,840.156 1303.41,894.293 1305.76,983.955 1308.11,980.685 1310.46,816.834 1312.81,717.506 1315.16,938.184 1317.51,1096 1319.86,726.681 1322.21,991.983 1324.56,913.654 1326.91,849.639 1329.26,999.839 1331.61,777.589 1333.96,881.047 1336.31,1007.47 1338.66,889.772 1341.02,981.325 1343.37,878.452 1345.72,1050.22 1348.07,901.358 1350.42,956.702 1352.77,882.606 1355.12,897.911 1357.47,801.979 1359.82,742.648 1362.17,938.657 1364.52,948.459 1366.87,898.112 1369.22,885.015 1371.57,861.177 1373.92,752.755 1376.27,863.436 1378.62,803.265 1380.97,718.861 1383.32,962.691 1385.67,1028.34 1388.02,836.13 1390.38,944.403 1392.73,1159.99 1395.08,1033.35 1397.43,1092.64 1399.78,861.522 1402.13,805.902 1404.48,943.079 1406.83,932.767 1409.18,1265.31 1411.53,972.878 1413.88,1132.21 1416.23,937.497 1418.58,1051.71 1420.93,1043.88 1423.28,1176.29 1425.63,1039.45 1427.98,928.882 1430.33,888.026 1432.68,643.487 1435.03,868.697 1437.38,1108.98 1439.74,859.835 1442.09,974.463 1444.44,716.538 1446.79,1044.75 1449.14,872.273 1451.49,932.213 1453.84,1011.81 1456.19,985.002 1458.54,732.06 1460.89,850.927 1463.24,1005.71 1465.59,1019.6 1467.94,816.523 1470.29,783.253 1472.64,1005.53 1474.99,1176.89 1477.34,848.233 1479.69,858.047 1482.04,824.601 1484.39,844.536 1486.74,1004.54 1489.1,1086.13 1491.45,920.375 1493.8,717.525 1496.15,1156.25 1498.5,817.053 1500.85,841.52 1503.2,896.086 1505.55,1150.23 1507.9,847.785 1510.25,868.664 1512.6,839.421 1514.95,881.498 1517.3,853.28 1519.65,986.194 1522,1034.84 1524.35,1003.38 1526.7,909.162 1529.05,759.845 1531.4,930.35 1533.75,1300.48 1536.1,769.517 1538.45,1018.87 1540.81,996.439 1543.16,952.918 1545.51,826.804 1547.86,926.625 1550.21,990.262 1552.56,853.326 1554.91,1083.17 1557.26,963.077 1559.61,1002.27 1561.96,1086.95 1564.31,950.116 1566.66,929.895 1569.01,917.24 1571.36,946.388 1573.71,1035.46 1576.06,1009.49 1578.41,806.704 1580.76,808.808 1583.11,976.035 1585.46,1027.62 1587.81,1192.15 1590.17,943.605 1592.52,1057.79 1594.87,832.321 1597.22,966.695 1599.57,1008.99 1601.92,1184.96 1604.27,892.67 1606.62,1017.13 1608.97,925.247 1611.32,903.887 1613.67,957.346 1616.02,909.26 1618.37,993.191 1620.72,977.463 1623.07,790.361 1625.42,834.743 1627.77,938.407 1630.12,761.051 1632.47,1046.17 1634.82,901.99 1637.17,961.137 1639.53,757.013 1641.88,887.583 1644.23,832.541 1646.58,1108.98 1648.93,1048.47 1651.28,949.773 1653.63,941.447 1655.98,1017.83 1658.33,983.894 1660.68,874.589 1663.03,950.404 1665.38,959.113 1667.73,1041.39 1670.08,800.311 1672.43,1054.79 1674.78,769.302 1677.13,932.303 1679.48,996.826 1681.83,949.344 1684.18,946.22 1686.53,854.348 1688.89,1036.17 1691.24,934.574 1693.59,1019.33 1695.94,1012.95 1698.29,1045.57 1700.64,865.431 1702.99,1089.19 1705.34,944.505 1707.69,778.911 1710.04,907.123 1712.39,915.509 1714.74,944.637 1717.09,806.927 1719.44,863.645 1721.79,878.805 1724.14,962.496 1726.49,947.181 1728.84,860.76 1731.19,838.947 1733.54,930.248 1735.89,842.011 1738.25,823.907 1740.6,906.779 1742.95,797.187 1745.3,929.521 1747.65,827.587 1750,1057.38 1752.35,900.426 1754.7,749.336 1757.05,923.909 1759.4,935.906 1761.75,844.803 1764.1,1124.38 1766.45,962.746 1768.8,933.175 1771.15,962.747 1773.5,943.282 1775.85,816.537 1778.2,929.907 1780.55,979.712 1782.9,920.653 1785.25,1013 1787.6,933.461 1789.96,844.963 1792.31,860.867 1794.66,1116.67 1797.01,887.024 1799.36,964.215 1801.71,1060.8 1804.06,945.361 1806.41,686.368 1808.76,821.979 1811.11,741.526 1813.46,1014.65 1815.81,1012.5 1818.16,1006.36 1820.51,926.772 1822.86,896 1825.21,1041.58 1827.56,1040.6 1829.91,1047.16 1832.26,864.867 1834.61,725.93 1836.96,938.401 1839.32,1089.19 1841.67,965.281 1844.02,1014.98 1846.37,779.302 1848.72,842.482 1851.07,885.015 1853.42,1016.89 1855.77,844.286 1858.12,1186.09 1860.47,1073.57 1862.82,841.284 1865.17,965.667 1867.52,979.934 1869.87,1072.52 1872.22,1044.63 1874.57,952 1876.92,1033.94 1879.27,878.443 1881.62,1013.67 1883.97,910.201 1886.32,1077.92 1888.68,1165.98 1891.03,803.44 1893.38,901.352 1895.73,684.503 1898.08,1008.29 1900.43,903.333 1902.78,997.654 1905.13,991.31 1907.48,842.089 1909.83,850.794 1912.18,1169.03 1914.53,706.908 1916.88,1038.03 1919.23,835.315 1921.58,902.745 1923.93,951.11 1926.28,827.385 1928.63,940.312 1930.98,1002.91 1933.33,1078.24 1935.68,946.934 1938.04,852.928 1940.39,994.211 1942.74,738.374 1945.09,811.664 1947.44,864.561 1949.79,776.751 1952.14,927.341 1954.49,925.173 1956.84,898.149 1959.19,845.449 1961.54,859.31 1963.89,942.904 1966.24,904.125 1968.59,805.811 1970.94,915.286 1973.29,959.947 1975.64,908.886 1977.99,992.364 1980.34,685.558 1982.69,950.275 1985.04,956.888 1987.4,961.411 1989.75,954.671 1992.1,1000.65 1994.45,913.495 1996.8,898.23 1999.15,761.47 2001.5,1069.18 2003.85,935.529 2006.2,749.893 2008.55,1027.99 2010.9,993.742 2013.25,803.762 2015.6,937.587 2017.95,871.747 2020.3,974.659 2022.65,750.771 2025,956.926 2027.35,922.457 2029.7,929.539 2032.05,848.003 2034.4,973.241 2036.76,927.917 2039.11,819.414 2041.46,1105.09 2043.81,1078.28 2046.16,716.231 2048.51,994.267 2050.86,876.373 2053.21,846.48 2055.56,1002.72 2057.91,957.582 2060.26,1012.85 2062.61,997.374 2064.96,811.507 2067.31,813.73 2069.66,1027.09 2072.01,1095.64 2074.36,784.961 2076.71,706.837 2079.06,980.855 2081.41,895.708 2083.76,902.517 2086.11,946.801 2088.47,844.391 2090.82,864.602 2093.17,991.205 2095.52,927.943 2097.87,848.282 2100.22,847.195 2102.57,1141.19 2104.92,881.892 2107.27,864.364 2109.62,775.557 2111.97,883.09 2114.32,968.341 2116.67,1019.13 2119.02,832.082 2121.37,922.622 2123.72,882.111 2126.07,853.509 2128.42,1083.55 2130.77,792.866 2133.12,804.05 2135.47,1078.69 2137.83,920.325 2140.18,1048.73 2142.53,882.519 2144.88,1055.3 2147.23,934.512 2149.58,756.646 2151.93,998.896 2154.28,998.968 2156.63,927.672 2158.98,1027.35 2161.33,810.814 2163.68,913.872 2166.03,914.058 2168.38,908.225 2170.73,1009.84 2173.08,742.269 2175.43,849.65 2177.78,946.393 2180.13,919.609 2182.48,961.809 2184.83,886.844 2187.19,707.988 2189.54,1016.74 2191.89,1158.51 2194.24,877.118 2196.59,818.691 2198.94,948.899 2201.29,965.577 2203.64,768.62 2205.99,959.821 2208.34,811.07 2210.69,1049.05 2213.04,992.271 2215.39,907.823 2217.74,832.814 2220.09,713.729 2222.44,657.123 2224.79,798.266 2227.14,904.756 2229.49,846.481 2231.84,803.827 2234.19,773.27 2236.55,970.344 2238.9,860.571 2241.25,1027.39 2243.6,862.814 2245.95,969.008 2248.3,962.395 2250.65,835.045 2253,863.132 2255.35,1005.42 2257.7,810.624 2260.05,736.424 2262.4,584.338 2264.75,885.724 2267.1,925.088 2269.45,1201.46 2271.8,863.177 2274.15,923.856 2276.5,1015.33 2278.85,915.233 2281.2,788.526 2283.55,866.325 2285.91,1068.6 2288.26,856.717 2290.61,974.185 2292.96,821.537 2295.31,713.789 2297.66,758.994 2300.01,840.727 2302.36,770.184 2304.71,1029.83 2307.06,1083.99 2309.41,826.55 2311.76,976.905 2314.11,920.184 2316.46,900.924 2318.81,1060.96 2321.16,900.343 2323.51,915.324 2325.86,936.476 2328.21,1266.33 2330.56,806.065 2332.91,867.156 2335.27,748.886 2337.62,960.758 2339.97,921.182 2342.32,1030.89 2344.67,990.132 2347.02,865.73 2349.37,917.299 2351.72,793.51 2354.07,920.455 2356.42,841.345 2358.77,846.939 2361.12,1044.74 2363.47,1072.59 2365.82,1109.9 2368.17,811.064 2370.52,779.279 2372.87,1039.37 2375.22,787.019 2377.57,977.487 2379.92,946.437 2382.27,943.461 2384.62,738.401 2386.98,885.625 2389.33,1037.04 2391.68,919.597 2394.03,1023.33 2396.38,749.293 2398.73,926.166 2401.08,1077.23 2403.43,976.772 2405.78,1020.25 2408.13,910.103 2410.48,970.471 2412.83,965.963 2415.18,787.593 2417.53,919.71 2419.88,1057.27 2422.23,896.458 2424.58,877.381 2426.93,934.424 2429.28,982.178 2431.63,1017.13 2433.98,1140.19 2436.34,990.075 2438.69,728.972 2441.04,942.374 2443.39,875.82 2445.74,883.208 2448.09,892.921 2450.44,890.743 2452.79,1071.87 2455.14,896.766 2457.49,800.28 2459.84,803.365 2462.19,940.071 2464.54,830.286 2466.89,1053.01 2469.24,956.376 2471.59,854.012 2473.94,916.964 2476.29,771.772 2478.64,994.828 2480.99,1025.97 2483.34,1081.37 2485.7,991.606 2488.05,1044.47 2490.4,1008.19 2492.75,1033.98 2495.1,801.856 2497.45,767.626 2499.8,844.46 2502.15,905.976 2504.5,1039.23 2506.85,1045.46 2509.2,927.021 2511.55,993.004 2513.9,993.822 2516.25,809.204 2518.6,821.918 2520.95,953.133 2523.3,885.738 2525.65,894.884 2528,1063.51 2530.35,893.774 2532.7,952.432 2535.06,1009.03 2537.41,862.344 2539.76,1133.27 2542.11,932.833 2544.46,818.616 2546.81,954.675 2549.16,690.972 2551.51,891.646 2553.86,891.754 2556.21,1108.11 2558.56,845.455 2560.91,909.214 2563.26,948.521 2565.61,1102.9 2567.96,927.822 2570.31,966.436 "></polyline>
<polyline clip-path="url(#clip632)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,737.45 224.541,343.811 226.891,504.792 229.242,278.367 231.592,594.56 233.943,243.991 236.293,598.937 238.644,391.616 240.994,173.884 243.345,493.588 245.695,297.592 248.046,363.399 250.396,324.303 252.747,486.277 255.097,361.278 257.448,454.973 259.798,255.476 262.148,517.336 264.499,521.424 266.849,413.811 269.2,387.236 271.55,383.307 273.901,482.879 276.251,304.957 278.602,346.721 280.952,327.308 283.303,269.689 285.653,347.023 288.004,501.813 290.354,221.89 292.705,634.178 295.055,414.348 297.406,380.809 299.756,328.868 302.107,506.746 304.457,554.162 306.807,419.393 309.158,478.408 311.508,314.277 313.859,323.223 316.209,258.701 318.56,399.344 320.91,300.002 323.261,561.805 325.611,208.606 327.962,453.297 330.312,431.414 332.663,466.602 335.013,427.591 337.364,323.651 339.714,403.222 342.065,438.308 344.415,414.343 346.765,300.538 349.116,410.116 351.466,475.265 353.817,380.499 356.167,336.743 358.518,199.332 360.868,509.365 363.219,367.849 365.569,470.641 367.92,416.084 370.27,565.925 372.621,370.772 374.971,245.704 377.322,481.061 379.672,479.022 382.023,245.411 384.373,498.349 386.724,303.431 389.074,409.982 391.424,318.902 393.775,476.553 396.125,310.838 398.476,446.206 400.826,385.318 403.177,511.967 405.527,435.14 407.878,384.281 410.228,414.735 412.579,400.436 414.929,391.641 417.28,492.239 419.63,345.016 421.981,507.117 424.331,489.737 426.682,416.93 429.032,390.556 431.382,341.811 433.733,288.837 436.083,440.26 438.434,446.306 440.784,470.387 443.135,346.392 445.485,350.131 447.836,412.048 450.186,410.79 452.537,393.658 454.887,544.443 457.238,480.607 459.588,443.644 461.939,302.536 464.289,318.165 466.64,281.392 468.99,402.502 471.341,690.401 473.691,465.521 476.041,290.31 478.392,511.69 480.742,524.653 483.093,380.634 485.443,386.344 487.794,355.593 490.144,442.079 492.495,385.134 494.845,388.278 497.196,262.206 499.546,430.989 501.897,470.305 504.247,495.244 506.598,240.92 508.948,422.484 511.299,316.321 513.649,482.895 515.999,246.27 518.35,339.54 520.7,579.326 523.051,650.477 525.401,573.935 527.752,401.969 530.102,431.014 532.453,506.145 534.803,329.897 537.154,324.754 539.504,375.268 541.855,343.434 544.205,475.401 546.556,513.089 548.906,442.821 551.257,316.7 553.607,451.551 555.958,419.866 558.308,407.576 560.658,385.917 563.009,622.841 565.359,307.759 567.71,512.057 570.06,339.124 572.411,271.625 574.761,353.636 577.112,292.533 579.462,306.925 581.813,515.069 584.163,382.019 586.514,464.763 588.864,527.076 591.215,337.952 593.565,383.501 595.916,555.884 598.266,363.532 600.616,400.482 602.967,418.842 605.317,359.476 607.668,238.405 610.018,562.692 612.369,550.786 614.719,419.521 617.07,321.441 619.42,375.536 621.771,299.018 624.121,427.634 626.472,192.648 628.822,361.811 631.173,402.712 633.523,215.983 635.874,179.978 638.224,349.569 640.575,252.629 642.925,465.104 645.275,517.182 647.626,452.889 649.976,502.675 652.327,293.362 654.677,542.029 657.028,316.801 659.378,503.738 661.729,465.443 664.079,407.751 666.43,367.655 668.78,391.245 671.131,370.599 673.481,444.767 675.832,444.642 678.182,438.184 680.533,218.564 682.883,595.328 685.233,460.118 687.584,302.389 689.934,571.667 692.285,219.283 694.635,416.79 696.986,425.953 699.336,329.919 701.687,469.249 704.037,394.751 706.388,314.69 708.738,284.256 711.089,207.275 713.439,438.525 715.79,348.493 718.14,607.2 720.491,444.822 722.841,302.243 725.192,285.578 727.542,180.462 729.892,412.927 732.243,339.84 734.593,374.976 736.944,650.281 739.294,222.956 741.645,297.795 743.995,295.866 746.346,406.653 748.696,344.033 751.047,489.673 753.397,546.904 755.748,415.064 758.098,420.576 760.449,550.557 762.799,602.185 765.15,397.597 767.5,326.672 769.85,489.787 772.201,353.282 774.551,406.902 776.902,368.391 779.252,394.494 781.603,423.575 783.953,270.954 786.304,386.146 788.654,345.465 791.005,422.139 793.355,604.552 795.706,578.097 798.056,503.843 800.407,424.167 802.757,432.101 805.108,465.905 807.458,463.754 809.809,329.902 812.159,337.246 814.509,419.233 816.86,430.198 819.21,310.292 821.561,298.97 823.911,318.415 826.262,471.886 828.612,504.692 830.963,508.285 833.313,431.454 835.664,461.73 838.014,263.496 840.365,438.384 842.715,316.671 845.066,406.538 847.416,332.256 849.767,604.952 852.117,431.532 854.467,443.221 856.818,501.786 859.168,386.937 861.519,414.431 863.869,500.059 866.22,388.424 868.57,481.778 870.921,353.035 873.271,289.167 875.622,508.467 877.972,393.774 880.323,436.165 882.673,347.892 885.024,446.446 887.374,431.528 889.725,282.184 892.075,341.383 894.426,663.752 896.776,538.506 899.126,242.831 901.477,416.653 903.827,614.774 906.178,395.194 908.528,435.249 910.879,441.234 913.229,433.158 915.58,485.202 917.93,354.513 920.281,580.398 922.631,550.365 924.982,474.362 927.332,463.426 929.683,432.675 932.033,486.203 934.384,183.52 936.734,414.937 939.084,520.451 941.435,241.835 943.785,382.909 946.136,327.864 948.486,528.256 950.837,364.827 953.187,335.064 955.538,465.606 957.888,367.519 960.239,450.77 962.589,300.935 964.94,259.405 967.29,400.053 969.641,369.524 971.991,311.832 974.342,455.744 976.692,255.195 979.043,229.143 981.393,295.898 983.743,451.857 986.094,130.517 988.444,389.933 990.795,258.671 993.145,401.031 995.496,328.276 997.846,358.686 1000.2,604.23 1002.55,582.084 1004.9,374.209 1007.25,321.913 1009.6,297.141 1011.95,488.411 1014.3,450.098 1016.65,438.758 1019,174.621 1021.35,405.836 1023.7,404.852 1026.05,385.794 1028.4,215.676 1030.75,270.612 1033.1,465.48 1035.45,425.068 1037.8,313.155 1040.15,423.43 1042.51,374.889 1044.86,642.575 1047.21,254.283 1049.56,434.343 1051.91,435.803 1054.26,302.933 1056.61,534.445 1058.96,312.094 1061.31,474.003 1063.66,466.679 1066.01,406.046 1068.36,313.156 1070.71,525.741 1073.06,501.707 1075.41,409.777 1077.76,516.285 1080.11,278.756 1082.46,443.773 1084.81,275.03 1087.16,480.212 1089.51,550.994 1091.87,319.956 1094.22,536.011 1096.57,367.896 1098.92,440.028 1101.27,386.474 1103.62,525.591 1105.97,458.068 1108.32,652.606 1110.67,318.25 1113.02,426.897 1115.37,351.264 1117.72,377.558 1120.07,304.581 1122.42,456.069 1124.77,459.091 1127.12,459.515 1129.47,655.773 1131.82,414.149 1134.17,458.204 1136.52,561.387 1138.87,436.258 1141.23,598.329 1143.58,415.651 1145.93,532.348 1148.28,517.708 1150.63,263.92 1152.98,480.011 1155.33,436.547 1157.68,478.232 1160.03,228.587 1162.38,447.708 1164.73,214.713 1167.08,282.657 1169.43,490.999 1171.78,527.912 1174.13,376.424 1176.48,452.688 1178.83,543.714 1181.18,530.423 1183.53,518.668 1185.88,465.224 1188.23,325.245 1190.59,466.192 1192.94,507.895 1195.29,352.521 1197.64,453.552 1199.99,393.257 1202.34,395.657 1204.69,442.731 1207.04,237.953 1209.39,344.629 1211.74,325.035 1214.09,432.257 1216.44,437.395 1218.79,437.566 1221.14,399.492 1223.49,293.065 1225.84,501.618 1228.19,254.355 1230.54,637.603 1232.89,353.452 1235.24,448.917 1237.59,517.431 1239.94,246.317 1242.3,440.063 1244.65,448.465 1247,418.705 1249.35,357.412 1251.7,381.284 1254.05,440.796 1256.4,323.631 1258.75,430.564 1261.1,546.026 1263.45,311.188 1265.8,426.904 1268.15,489.619 1270.5,817.182 1272.85,421.66 1275.2,342.897 1277.55,500.166 1279.9,526.638 1282.25,358.481 1284.6,365.048 1286.95,501.429 1289.3,398.911 1291.66,418.81 1294.01,248.703 1296.36,480.79 1298.71,561.269 1301.06,324.748 1303.41,565.3 1305.76,435.755 1308.11,254.857 1310.46,396.624 1312.81,298.762 1315.16,339.249 1317.51,523.134 1319.86,518.801 1322.21,348.51 1324.56,393.325 1326.91,302.03 1329.26,430.548 1331.61,296.377 1333.96,437.614 1336.31,521.75 1338.66,356.243 1341.02,439.132 1343.37,428.685 1345.72,450.775 1348.07,570.284 1350.42,565.522 1352.77,500.107 1355.12,276.325 1357.47,386.894 1359.82,283.363 1362.17,224.039 1364.52,409.191 1366.87,548.315 1369.22,180.84 1371.57,485.295 1373.92,327.449 1376.27,442.444 1378.62,322.672 1380.97,395.74 1383.32,363.207 1385.67,267.033 1388.02,335.194 1390.38,307.377 1392.73,484.731 1395.08,477.175 1397.43,452.574 1399.78,605.528 1402.13,420.555 1404.48,478.099 1406.83,486.572 1409.18,482.249 1411.53,442.303 1413.88,320.141 1416.23,366.577 1418.58,406.831 1420.93,401.556 1423.28,145.233 1425.63,281.702 1427.98,369.366 1430.33,396.841 1432.68,157.345 1435.03,395.464 1437.38,470.183 1439.74,691.141 1442.09,331.596 1444.44,461.771 1446.79,304.898 1449.14,694.83 1451.49,543.652 1453.84,527.408 1456.19,499.675 1458.54,463.631 1460.89,383.718 1463.24,413.063 1465.59,483.993 1467.94,377.811 1470.29,538.979 1472.64,246.461 1474.99,333.361 1477.34,520.022 1479.69,541.634 1482.04,268.893 1484.39,420.17 1486.74,438.196 1489.1,555.37 1491.45,280.185 1493.8,521.701 1496.15,448.268 1498.5,489.559 1500.85,399.228 1503.2,265.984 1505.55,529.823 1507.9,208.938 1510.25,219.912 1512.6,330.435 1514.95,773.595 1517.3,410.494 1519.65,350.997 1522,417.408 1524.35,520.871 1526.7,566.577 1529.05,446.341 1531.4,346.035 1533.75,525.734 1536.1,372.744 1538.45,389.846 1540.81,366.752 1543.16,509.926 1545.51,317.384 1547.86,474.41 1550.21,270.197 1552.56,401.196 1554.91,375.403 1557.26,393.86 1559.61,376.494 1561.96,474.671 1564.31,524.011 1566.66,410.338 1569.01,469.787 1571.36,413.945 1573.71,602.996 1576.06,491.47 1578.41,432.826 1580.76,341.216 1583.11,476.784 1585.46,423.892 1587.81,487.921 1590.17,190.629 1592.52,549.551 1594.87,362 1597.22,360.438 1599.57,339.484 1601.92,547.411 1604.27,398.141 1606.62,264.749 1608.97,386.909 1611.32,414.393 1613.67,448.697 1616.02,327.879 1618.37,304.904 1620.72,452.51 1623.07,514.678 1625.42,415.973 1627.77,471.189 1630.12,285.053 1632.47,479.831 1634.82,419.003 1637.17,413.839 1639.53,472.102 1641.88,301.105 1644.23,441.164 1646.58,292.64 1648.93,446.452 1651.28,496.29 1653.63,483.65 1655.98,315.851 1658.33,458.529 1660.68,191.209 1663.03,360.815 1665.38,402.643 1667.73,278.599 1670.08,396.564 1672.43,510.721 1674.78,320.766 1677.13,414.021 1679.48,509.284 1681.83,521.722 1684.18,294.189 1686.53,449.343 1688.89,517.563 1691.24,651.792 1693.59,545.524 1695.94,528.143 1698.29,260.669 1700.64,299.86 1702.99,286.702 1705.34,643.462 1707.69,250.179 1710.04,114.629 1712.39,320.147 1714.74,357.191 1717.09,341.176 1719.44,351.377 1721.79,248.694 1724.14,451.692 1726.49,403.213 1728.84,545.005 1731.19,275.277 1733.54,341.719 1735.89,462.325 1738.25,602.089 1740.6,547.079 1742.95,305.15 1745.3,387.472 1747.65,435.728 1750,346.547 1752.35,517.005 1754.7,439.793 1757.05,551.38 1759.4,171.426 1761.75,354.348 1764.1,356.116 1766.45,213.079 1768.8,398.873 1771.15,396.997 1773.5,399.485 1775.85,419.654 1778.2,305.556 1780.55,326.269 1782.9,395.287 1785.25,398.668 1787.6,569.735 1789.96,320.435 1792.31,417.232 1794.66,317.688 1797.01,322.695 1799.36,315.876 1801.71,401.733 1804.06,305.105 1806.41,394.223 1808.76,519.057 1811.11,506.449 1813.46,488.907 1815.81,601.186 1818.16,425.008 1820.51,257.711 1822.86,219.789 1825.21,513.941 1827.56,387.246 1829.91,393.55 1832.26,287.04 1834.61,440.576 1836.96,336.597 1839.32,545.021 1841.67,351.842 1844.02,438.444 1846.37,650.446 1848.72,573.765 1851.07,232.704 1853.42,494.372 1855.77,658.263 1858.12,411.941 1860.47,404.725 1862.82,330.105 1865.17,492.638 1867.52,532.794 1869.87,594.722 1872.22,486.789 1874.57,439.083 1876.92,422.91 1879.27,246.445 1881.62,510.313 1883.97,492.219 1886.32,709.172 1888.68,552.611 1891.03,334.507 1893.38,269.935 1895.73,587.122 1898.08,535.254 1900.43,436.494 1902.78,470.566 1905.13,437.621 1907.48,536.786 1909.83,477.209 1912.18,449.702 1914.53,447.797 1916.88,593.801 1919.23,346.183 1921.58,582.505 1923.93,441.274 1926.28,306.849 1928.63,320.086 1930.98,433.756 1933.33,361.203 1935.68,446.53 1938.04,375.005 1940.39,535.907 1942.74,406.532 1945.09,242.008 1947.44,439.095 1949.79,417.866 1952.14,568.674 1954.49,457.989 1956.84,500.661 1959.19,502.082 1961.54,457.54 1963.89,429.705 1966.24,437.047 1968.59,426.271 1970.94,560.402 1973.29,281.269 1975.64,518.955 1977.99,415.011 1980.34,372.196 1982.69,474.757 1985.04,737.433 1987.4,557.095 1989.75,345.692 1992.1,446.883 1994.45,485.382 1996.8,331.282 1999.15,448.612 2001.5,338.31 2003.85,312.843 2006.2,595.534 2008.55,297.652 2010.9,575.269 2013.25,436.916 2015.6,474.707 2017.95,586.296 2020.3,201.823 2022.65,489.774 2025,349.416 2027.35,96.8724 2029.7,295.586 2032.05,393.721 2034.4,395.328 2036.76,423.766 2039.11,252.512 2041.46,435.348 2043.81,416.567 2046.16,308.017 2048.51,295.183 2050.86,485.509 2053.21,406.681 2055.56,346.689 2057.91,364.303 2060.26,366.583 2062.61,523.715 2064.96,381.823 2067.31,468.754 2069.66,545.53 2072.01,497.113 2074.36,288.502 2076.71,297.384 2079.06,560.07 2081.41,314.057 2083.76,410.764 2086.11,431.632 2088.47,446.646 2090.82,344.556 2093.17,608.817 2095.52,564.933 2097.87,388.787 2100.22,448.023 2102.57,444.783 2104.92,534.422 2107.27,422.535 2109.62,460.65 2111.97,593.488 2114.32,398.113 2116.67,299.376 2119.02,403.85 2121.37,324.262 2123.72,666.957 2126.07,482.626 2128.42,458.797 2130.77,275.943 2133.12,253.371 2135.47,417.602 2137.83,412.375 2140.18,489.839 2142.53,560.905 2144.88,428.25 2147.23,415.215 2149.58,428.082 2151.93,555.209 2154.28,418.118 2156.63,545.544 2158.98,323.843 2161.33,515.819 2163.68,372.453 2166.03,406.463 2168.38,552.311 2170.73,276.057 2173.08,396.315 2175.43,394.792 2177.78,355.551 2180.13,406.126 2182.48,585.476 2184.83,338.921 2187.19,472.721 2189.54,522.123 2191.89,421.513 2194.24,398.427 2196.59,473.818 2198.94,272.208 2201.29,242.897 2203.64,200.097 2205.99,390.319 2208.34,503.946 2210.69,383.438 2213.04,487.208 2215.39,431.204 2217.74,327.893 2220.09,359.486 2222.44,546.51 2224.79,305.491 2227.14,351.494 2229.49,580.149 2231.84,124.188 2234.19,431.918 2236.55,385.913 2238.9,263.034 2241.25,459.779 2243.6,330.969 2245.95,438.708 2248.3,433.562 2250.65,391.621 2253,500.042 2255.35,340.334 2257.7,209.895 2260.05,320.285 2262.4,330.551 2264.75,388.675 2267.1,332.831 2269.45,190.906 2271.8,451.756 2274.15,249.678 2276.5,436.924 2278.85,449.119 2281.2,356.413 2283.55,384.475 2285.91,384.239 2288.26,392.653 2290.61,524.929 2292.96,312.346 2295.31,533.034 2297.66,342.415 2300.01,349.018 2302.36,326.156 2304.71,684.384 2307.06,474.426 2309.41,483.204 2311.76,270.094 2314.11,552.918 2316.46,378.651 2318.81,487.242 2321.16,454.295 2323.51,412.319 2325.86,306.752 2328.21,406.345 2330.56,421.138 2332.91,438.308 2335.27,427.926 2337.62,321.482 2339.97,407.456 2342.32,364.79 2344.67,414.939 2347.02,619.251 2349.37,336.63 2351.72,363.241 2354.07,367.563 2356.42,451.757 2358.77,357.821 2361.12,421.251 2363.47,298.853 2365.82,408.69 2368.17,440.709 2370.52,361.166 2372.87,488.768 2375.22,259.762 2377.57,394.444 2379.92,562.46 2382.27,320.31 2384.62,170.147 2386.98,365.465 2389.33,267.277 2391.68,464.138 2394.03,428.099 2396.38,295.445 2398.73,160.966 2401.08,436.377 2403.43,650.373 2405.78,469.994 2408.13,500.375 2410.48,459.153 2412.83,416.005 2415.18,454.947 2417.53,498.426 2419.88,373.654 2422.23,464.926 2424.58,420.254 2426.93,361.073 2429.28,449.729 2431.63,307.206 2433.98,328.254 2436.34,460.053 2438.69,577.17 2441.04,387.501 2443.39,472.253 2445.74,499.147 2448.09,228.868 2450.44,530.608 2452.79,278.69 2455.14,623.978 2457.49,374.23 2459.84,361.381 2462.19,446.603 2464.54,420.496 2466.89,349.65 2469.24,286.421 2471.59,340.4 2473.94,351.662 2476.29,267.463 2478.64,442.313 2480.99,187.084 2483.34,246.243 2485.7,357.927 2488.05,429.336 2490.4,442.099 2492.75,398.523 2495.1,459.366 2497.45,379.55 2499.8,288.278 2502.15,406.635 2504.5,334.154 2506.85,292.596 2509.2,687.344 2511.55,714.812 2513.9,415.359 2516.25,505.523 2518.6,298.251 2520.95,263.827 2523.3,308.709 2525.65,574.868 2528,425.688 2530.35,361.062 2532.7,441.695 2535.06,464.038 2537.41,224.512 2539.76,373.403 2542.11,380.134 2544.46,443.381 2546.81,503.612 2549.16,335.763 2551.51,402.003 2553.86,265.225 2556.21,557.355 2558.56,435.969 2560.91,393.202 2563.26,558.691 2565.61,409.293 2567.96,493.036 2570.31,299.158 "></polyline>
</svg>
</div>
</div>
<p>Look at that! Things are working; amazin’.</p>
<p>We can also exploit <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a>’s parallel sampling capabilities:</p>
<div id="32" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run separate 4 chains for 10 000 iterations using threads to parallelize.</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>num_chains <span class="op">=</span> <span class="fl">4</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    model_with_grad,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    sampler,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MCMCThreads</span>(),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="fl">10_000</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    num_chains;</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note we need to provide an initial state for every chain.</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    initial_state<span class="op">=</span><span class="fu">fill</span>(state, num_chains),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">=</span><span class="cn">false</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>samples_array <span class="op">=</span> <span class="fu">stack</span>(<span class="fu">map</span>(stack, samples))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>┌ Warning: Only a single thread available: MCMC chains are not sampled in parallel
└ @ AbstractMCMC ~/.julia/packages/AbstractMCMC/YrmkI/src/sample.jl:310</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×10000×4 Array{Float64, 3}:
[:, :, 1] =
 -4.32802   -4.50779  -4.76583   …  -4.09346   -6.27698   -5.00886
  0.490263   2.72435   0.826382      0.331839   0.796376   0.0265048
  3.09662    4.10324   5.27108       4.48091    4.67204    5.08088

[:, :, 2] =
 -2.08848   -3.22028   -3.3027    -5.12108  …  -4.76514  -5.67061   -5.67061
  0.5807     0.865305   0.553009  -1.40961     -1.35608   0.261781   0.261781
  0.780637   2.58232    3.87382    3.96315      5.21757   5.3204     5.3204

[:, :, 3] =
 -1.17666   -3.07807   -4.30144   …  -4.30812  -6.59577   -6.04978
  0.790961  -0.780464   0.880415     -1.06467  -0.846879  -1.66139
  3.26096    4.82608    3.9747        5.57892   4.83484    3.49777

[:, :, 4] =
 -2.25546    -3.98866  -3.99563  -4.20288   …  -2.98118  -3.91256  -2.94712
  0.0380435  -1.07637  -1.42313   0.141993      0.47799  -2.08631  -0.263087
  3.08956     5.40173   4.94242   4.8736        5.43406   5.72991   5.71956</code></pre>
</div>
</div>
<p>But the fact that we have to provide the <code>AbstractMCMC.sample</code> call, etc. with an <code>initial_state</code> to get started is a bit annoying. We can avoid this by also defining a <code>AbstractMCMC.step</code> <em>without</em> the <code>state</code> argument:</p>
<div id="34" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    model_wrapper<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>;</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: No state provided!</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_wrapper.logdensity</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's just create the initial state by sampling using  a Gaussian.</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">randn</span>(rng, LogDensityProblems.<span class="fu">dimension</span>(model))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x, <span class="fu">MALAState</span>(x)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Equipped with this, we no longer need to provide the <code>initial_state</code> everywhere:</p>
<div id="36" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model_with_grad, sampler, <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>samples_matrix <span class="op">=</span> <span class="fu">stack</span>(samples)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hcat</span>(<span class="fu">mean</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>), <span class="fu">std</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×2 Matrix{Float64}:
 -4.99302    1.05589
 -0.0005731  1.03906
  5.01415    1.06666</code></pre>
</div>
</div>
</section>
<section id="using-our-sampler-with-turing.jl" class="level2">
<h2 class="anchored" data-anchor-id="using-our-sampler-with-turing.jl">Using our sampler with Turing.jl</h2>
<p>As we promised, all of this hassle of implementing our <code>MALA</code> sampler in a way that uses <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> and <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> gets us something more than <em>just</em> an “automatic” implementation of <code>AbstractMCMC.sample</code>.</p>
<p>It also enables use with Turing.jl through the <code>externalsampler</code>, but we need to do one final thing first: we need to tell Turing.jl how to extract a vector of parameters from the “sample” returned in our implementation of <code>AbstractMCMC.step</code>. In our case, the “sample” is just a <code>Vector{&lt;:Real}</code>, so we just need the following line:</p>
<div id="38" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Turing.jl.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Turing</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Overload the `getparams` method for our "sample" type, which is just a vector.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>Turing.Inference.<span class="fu">getparams</span>(<span class="op">::</span><span class="dt">Turing.Model</span>, x<span class="op">::</span><span class="dt">AbstractVector{&lt;:Real}</span>) <span class="op">=</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And with that, we’re good to go!</p>
<div id="40" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Our previous model defined as a Turing.jl model.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="fu">mvnormal_model</span>() <span class="op">=</span> x <span class="op">~</span> <span class="fu">MvNormal</span>([<span class="op">-</span><span class="fl">5</span>., <span class="fl">0</span>., <span class="fl">5</span>.], I)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate our model.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>turing_model <span class="op">=</span> <span class="fu">mvnormal_model</span>()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Call `sample` but now we're passing in a Turing.jl `model` and wrapping</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># our `MALA` sampler in the `externalsampler` to tell Turing.jl that the sampler</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># expects something that implements LogDensityProblems.jl.</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×4×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 2.69 seconds
Compute duration  = 2.69 seconds
parameters        = x[1], x[2], x[3]
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

        x[1]   -4.9986    1.0446    0.0178   3426.8146   5859.7719    0.9999   ⋯
        x[2]    0.0155    1.0407    0.0172   3652.4512   5140.0696    1.0000   ⋯
        x[3]    5.0352    1.0525    0.0176   3572.2777   5533.3741    1.0006   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

        x[1]   -7.0346   -5.7020   -4.9980   -4.2954   -2.9392
        x[2]   -2.0640   -0.6727    0.0136    0.7054    2.0561
        x[3]    2.9655    4.3403    5.0371    5.7343    7.1042
</pre>
</div>
</div>
</div>
<p>Pretty neat, eh?</p>
<section id="models-with-constrained-parameters" class="level3">
<h3 class="anchored" data-anchor-id="models-with-constrained-parameters">Models with constrained parameters</h3>
<p>One thing we’ve sort of glossed over in all of the above is that MALA, at least how we’ve implemented, requires <span class="math inline">\(x\)</span> to live in <span class="math inline">\(\mathbb{R}^d\)</span> for some <span class="math inline">\(d &gt; 0\)</span>. If some of the parameters were in fact constrained, e.g.&nbsp;we were working with a <code>Beta</code> distribution which has support on the interval <span class="math inline">\((0, 1)\)</span>, <em>not</em> on <span class="math inline">\(\mathbb{R}^d\)</span>, we could easily end up outside of the valid range <span class="math inline">\((0, 1)\)</span>.</p>
<div id="42" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="fu">beta_model</span>() <span class="op">=</span> x <span class="op">~</span> <span class="fu">Beta</span>(<span class="fl">3</span>, <span class="fl">3</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>turing_model <span class="op">=</span> <span class="fu">beta_model</span>()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×2×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 1.7 seconds
Compute duration  = 1.7 seconds
parameters        = x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

           x    0.5000    0.1925    0.0026   5120.7544   5611.3305    1.0001   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

           x    0.1406    0.3565    0.4993    0.6460    0.8555
</pre>
</div>
</div>
</div>
<p>Yep, that still works, but only because Turing.jl actually <em>transforms</em> the <code>turing_model</code> from constrained to unconstrained, so that the <code>sampler</code> provided to <code>externalsampler</code> is actually always working in unconstrained space! This is not always desirable, so we can turn this off:</p>
<div id="44" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">false</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×2×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 0.26 seconds
Compute duration  = 0.26 seconds
parameters        = x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

           x    0.9542    0.0119    0.0003   1857.7761   1857.7761    1.0004   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

           x    0.9539    0.9539    0.9539    0.9539    0.9539
</pre>
</div>
</div>
</div>
<p>The fun thing is that this still sort of works because</p>
<div id="46" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logpdf</span>(<span class="fu">Beta</span>(<span class="fl">3</span>, <span class="fl">3</span>), <span class="fl">10.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-Inf</code></pre>
</div>
</div>
<p>and so the samples that fall outside of the range are always rejected. But do notice how much worse all the diagnostics are, e.g.&nbsp;<code>ess_tail</code> is very poor compared to when we use <code>unconstrained=true</code>. Moreover, in more complex cases this won’t just result in a “nice” <code>-Inf</code> log-density value, but instead will error:</p>
<div id="48" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">demo</span>()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    σ² <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Normal</span>(), lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we end up with negative values for `σ²`, the `Normal` will error.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, σ²)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">demo</span>(), <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">false</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre>DomainError with Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}}(-1.257379896242274,1.0,0.0):
Normal: the condition σ &gt;= zero(σ) is not satisfied.
Stacktrace:
  [1] <span class="ansi-bold">#371</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [2] <span class="ansi-bold">check_args</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">utils.jl:89</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [3] <span class="ansi-bold">#Normal#370</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [4] <span class="ansi-bold">Normal</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:36</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [5] <span class="ansi-bold">Normal</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:42</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [6] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">compiler.jl:579</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [7] <span class="ansi-bold">demo</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">__model__</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">__varinfo__</span>::DynamicPPL.TypedVarInfo<span class="ansi-bright-black-fg">{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}, Vector{Set{DynamicPPL.Selector}}}}, ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}</span>, <span class="ansi-bright-black-fg">__context__</span>::DynamicPPL.DefaultContext<span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:443</span>
  [8] <span class="ansi-bold">_evaluate!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:963</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [9] <span class="ansi-bold">evaluate_threadunsafe!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:936</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [10] <span class="ansi-bold">evaluate!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:889</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [11] <span class="ansi-bold">logdensity</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">logdensityfunction.jl:94</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [12] <span class="ansi-bold">Fix1</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">./</span><span style="text-decoration:underline" class="ansi-bright-black-fg">operators.jl:1118</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [13] <span class="ansi-bold">vector_mode_dual_eval!</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">f</span>::Base.Fix1<span class="ansi-bright-black-fg">{typeof(LogDensityProblems.logdensity), LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}}</span>, <span class="ansi-bright-black-fg">cfg</span>::ForwardDiff.GradientConfig<span class="ansi-bright-black-fg">{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}</span>, <span class="ansi-bright-black-fg">x</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-cyan-fg">ForwardDiff</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">apiutils.jl:24</span>
 [14] <span class="ansi-bold">vector_mode_gradient!</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">result</span>::DiffResults.MutableDiffResult<span class="ansi-bright-black-fg">{1, Float64, Tuple{Vector{Float64}}}</span>, <span class="ansi-bright-black-fg">f</span>::Base.Fix1<span class="ansi-bright-black-fg">{typeof(LogDensityProblems.logdensity), LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}}</span>, <span class="ansi-bright-black-fg">x</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">cfg</span>::ForwardDiff.GradientConfig<span class="ansi-bright-black-fg">{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-cyan-fg">ForwardDiff</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">gradient.jl:96</span>
 [15] <span class="ansi-bold">gradient!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">gradient.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [16] <span class="ansi-bold">gradient!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">gradient.jl:35</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [17] <span class="ansi-bold">logdensity_and_gradient</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/LogDensityProblemsAD/rBlLq/ext/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">LogDensityProblemsADForwardDiffExt.jl:118</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [18] <span class="ansi-bold">leapfrog_step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">model</span>::LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity<span class="ansi-bright-black-fg">{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}</span>, <span class="ansi-bright-black-fg">x</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">p</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">ϵ</span>::Int64, <span class="ansi-bright-black-fg">M</span>::UniformScaling<span class="ansi-bright-black-fg">{Bool}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:291</span>
 [19] <span class="ansi-bold">step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model_wrapper</span>::AbstractMCMC.LogDensityModel<span class="ansi-bright-black-fg">{LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}}</span>, <span class="ansi-bright-black-fg">sampler</span>::MALA<span class="ansi-bright-black-fg">{Int64, UniformScaling{Bool}}</span>, <span class="ansi-bright-black-fg">state</span>::MALAState<span class="ansi-bright-black-fg">{Vector{Float64}}</span>; <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:262</span>
 [20] <span class="ansi-bold">step</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:244</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [21] <span class="ansi-bold">#step#108</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:90</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [22] <span class="ansi-bold">step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler_wrapper</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">state</span>::Turing.Inference.TuringState<span class="ansi-bright-black-fg">{MALAState{Vector{Float64}}, LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-green-fg">Turing.Inference</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:79</span>
 [23] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sample.jl:176</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [24] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">logging.jl:16</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [25] <span class="ansi-bold">mcmcsample</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">N</span>::Int64; <span class="ansi-bright-black-fg">progress</span>::Bool, <span class="ansi-bright-black-fg">progressname</span>::String, <span class="ansi-bright-black-fg">callback</span>::Nothing, <span class="ansi-bright-black-fg">discard_initial</span>::Int64, <span class="ansi-bright-black-fg">thinning</span>::Int64, <span class="ansi-bright-black-fg">chain_type</span>::Type, <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-yellow-fg">AbstractMCMC</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sample.jl:120</span>
 [26] <span class="ansi-bold">sample</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">N</span>::Int64; <span class="ansi-bright-black-fg">chain_type</span>::Type, <span class="ansi-bright-black-fg">resume_from</span>::Nothing, <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{progress::Bool}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">DynamicPPL</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sampler.jl:93</span>
 [27] <span class="ansi-bold">sample</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sampler.jl:83</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [28] <span class="ansi-bold">#sample#4</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:263</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [29] <span class="ansi-bold">sample</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:256</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [30] <span class="ansi-bold">#sample#3</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:253</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [31] top-level scope
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:445</span></pre>
</div>
</div>
</div>
<p>As expected, we run into a <code>DomainError</code> at some point, while if we set <code>unconstrained=true</code>, letting Turing.jl transform the model to a unconstrained form behind the scenes, everything works as expected:</p>
<div id="50" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">demo</span>(), <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">true</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×3×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 0.56 seconds
Compute duration  = 0.56 seconds
parameters        = σ², x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

          σ²    0.9081    0.5572    0.0289   314.8251   227.4617    1.0043     ⋯
           x   -0.5849    1.4315    0.2351    56.1601    25.0076    1.0131     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

          σ²    0.1079    0.4565    0.8890    1.1858    2.2468
           x   -3.3955   -1.1538   -0.1238    0.2364    1.7593
</pre>
</div>
</div>
</div>
<p>Neat!</p>
<p>Similarly, which automatic differentiation backend one should use can be specified through the <code>adtype</code> keyword argument too. For example, if we want to use <a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a> instead of the default <a href="https://github.com/JuliaDiff/ForwardDiff.jl">ReverseDiff.jl</a>:</p>
<div id="52" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ReverseDiff</span>: ReverseDiff</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify that we want to use `AutoReverseDiff`.</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">demo</span>(),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">true</span>, adtype<span class="op">=</span><span class="fu">AutoReverseDiff</span>()),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="fl">10_000</span>;</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">=</span><span class="cn">false</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×3×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 2.89 seconds
Compute duration  = 2.89 seconds
parameters        = σ², x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

          σ²    0.8763    0.7223    0.0730   137.3648    43.8822    1.0241     ⋯
           x    0.1122    1.0311    0.0946   177.5125    38.0326    1.0004     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

          σ²    0.0945    0.3104    0.6850    1.2245    3.0299
           x   -2.2374   -0.2760   -0.0025    0.4053    2.4419
</pre>
</div>
</div>
</div>
<p>Double-neat.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>At this point it’s worth maybe reminding ourselves what we did and also <em>why</em> we did it:</p>
<ol type="1">
<li>We define our models in the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface because it makes the sampler agnostic to how the underlying model is implemented.</li>
<li>We implement our sampler in the <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> interface, which just means that our sampler is a subtype of <code>AbstractMCMC.AbstractSampler</code> and we implement the MCMC transition in <code>AbstractMCMC.step</code>.</li>
<li><ol type="1">
<li>and (2) makes it so our sampler can be used with a wide range of model implementations, amongst them being models implemented in both Turing.jl and Stan. This gives you, the inference implementer, a large collection of models to test your inference method on, in addition to allowing users of Turing.jl and Stan to try out your inference method with minimal effort.</li>
</ol></li>
</ol>


</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There is no such thing as a proper interface in Julia (at least not officially), and so we use the word “interface” here to mean a few minimal methods that needs to be implemented by any type that we treat as a target model.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/turinglang\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="pagination-link" aria-label="Variational Inference">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Variational Inference</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Turing is created by <a href="http://mlg.eng.cam.ac.uk/hong/" target="_blank">Hong Ge</a>, and lovingly maintained by the <a href="https://github.com/TuringLang/Turing.jl/graphs/contributors" target="_blank">core team</a> of volunteers. <br> The contents of this website are © 2024 under the terms of the <a href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE" target="_blank">MIT License</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-17-implementing-samplers/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/TuringLang">
      <i class="bi bi-twitter" role="img" aria-label="Turing Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/TuringLang/Turing.jl">
      <i class="bi bi-github" role="img" aria-label="Turing GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>