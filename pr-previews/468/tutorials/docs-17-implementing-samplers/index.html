<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Turing.jl – Implementing samplers</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../tutorials/docs-07-for-developers-variational-inference/index.html" rel="prev">
<link href="../../assets/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<style>
  a {
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../theming/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://turinglang.org/" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/turing-logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="https://turinglang.org/">
    <span class="navbar-title">Turing.jl</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/docs-00-getting-started/"> 
<span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/00-introduction/"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/library/"> 
<span class="menu-text">Library API</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/news/"> 
<span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/team/"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://x.com/TuringLang" title="Turing Twitter" class="quarto-navigation-tool px-1" aria-label="Turing Twitter"><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/TuringLang/Turing.jl" title="Turing GitHub" class="quarto-navigation-tool px-1" aria-label="Turing GitHub"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../tutorials/docs-00-getting-started/index.html">Documentation</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html">For Developers (Inference)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-17-implementing-samplers/index.html">Implementing Samplers</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../tutorials/docs-00-getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using Turing - Modelling Syntax and Interface</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-00-getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-14-using-turing-quick-start/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick Start</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-12-using-turing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-09-using-turing-advanced/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Usage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-10-using-turing-autodiff/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-13-using-turing-performance-tips/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Performance Tips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-11-using-turing-dynamichmc/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using DynamicHMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-15-using-turing-sampler-viz/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-16-using-turing-external-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">External Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Using Turing - Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/00-introduction/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Turing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/01-gaussian-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/02-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/03-bayesian-neural-network/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/04-hidden-markov-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hidden Markov Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/05-linear-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/06-infinite-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Infinite Mixture Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/07-poisson-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Poisson Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/08-multinomial-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/09-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/10-bayesian-differential-equations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Differential Equations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/11-probabilistic-pca/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/13-seasonal-time-series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Time Series Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/15-gaussian-processes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Gaussian Processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/12-gplvm/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Process Latent Variable Models</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">For Developers (PPL)</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-01-contributing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Contribute</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-05-for-developers-compiler/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Turing Compiler Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/14-minituring/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Compiler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-06-for-developers-interface/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interface Guide</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">For Developers (Inference)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How Turing implements AbstractMCMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-17-implementing-samplers/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Implementing Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#quick-overview-of-mala" id="toc-quick-overview-of-mala" class="nav-link active" data-scroll-target="#quick-overview-of-mala">Quick overview of MALA</a></li>
  <li><a href="#what-we-need-from-a-model-logdensityproblems.jl" id="toc-what-we-need-from-a-model-logdensityproblems.jl" class="nav-link" data-scroll-target="#what-we-need-from-a-model-logdensityproblems.jl">What we need from a model: LogDensityProblems.jl</a></li>
  <li><a href="#implementing-mala-in-abstractmcmc.jl" id="toc-implementing-mala-in-abstractmcmc.jl" class="nav-link" data-scroll-target="#implementing-mala-in-abstractmcmc.jl">Implementing MALA in AbstractMCMC.jl</a></li>
  <li><a href="#using-our-sampler-with-turing.jl" id="toc-using-our-sampler-with-turing.jl" class="nav-link" data-scroll-target="#using-our-sampler-with-turing.jl">Using our sampler with Turing.jl</a>
  <ul class="collapse">
  <li><a href="#models-with-constrained-parameters" id="toc-models-with-constrained-parameters" class="nav-link" data-scroll-target="#models-with-constrained-parameters">Models with constrained parameters</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-17-implementing-samplers/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../tutorials/docs-00-getting-started/index.html">Documentation</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html">For Developers (Inference)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-17-implementing-samplers/index.html">Implementing Samplers</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Implementing samplers</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this tutorial, we’ll go through step-by-step how to implement a “simple” sampler in <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> in such a way that it can be easily applied to Turing.jl models.</p>
<p>In particular, we’re going to implement a version of <strong>Metropolis-adjusted Langevin (MALA)</strong>.</p>
<p>Note that we will implement this sampler in the <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> framework, completely “ignoring” Turing.jl until the very end of the tutorial, at which point we’ll use a single line of code to make the resulting sampler available to Turing.jl. This is to really drive home the point that one can implement samplers in a way that is accessible to all of Turing.jl’s users without having to use Turing.jl yourself.</p>
<section id="quick-overview-of-mala" class="level2">
<h2 class="anchored" data-anchor-id="quick-overview-of-mala">Quick overview of MALA</h2>
<p>We can view MALA as a single step of the leapfrog intergrator with resampling of momentum <span class="math inline">\(p\)</span> at every step. To make that statement a bit more concrete, we first define the <em>extended</em> target <span class="math inline">\(\bar{\gamma}(x, p)\)</span> as</p>
<p><span class="math display">\[\begin{equation*}
\log \bar{\gamma}(x, p) \propto \log \gamma(x) + \log \gamma_{\mathcal{N}(0, M)}(p)
\end{equation*}\]</span></p>
<p>where <span class="math inline">\(\gamma_{\mathcal{N}(0, M)}\)</span> denotes the density for a zero-centered Gaussian with covariance matrix <span class="math inline">\(M\)</span>. We then consider targeting this joint distribution over both <span class="math inline">\(x\)</span> and <span class="math inline">\(p\)</span> as follows. First we define the map</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  L_{\epsilon}: \quad &amp; \mathbb{R}^d \times \mathbb{R}^d \to \mathbb{R}^d \times \mathbb{R}^d \\
  &amp; (x, p) \mapsto (\tilde{x}, \tilde{p}) := L_{\epsilon}(x, p)
\end{split}
\end{equation*}\]</span></p>
<p>as</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  p_{1 / 2} &amp;:= p + \frac{\epsilon}{2} \nabla \log \gamma(x) \\
  \tilde{x} &amp;:= x + \epsilon M^{-1} p_{1 /2 } \\
  p_1 &amp;:= p_{1 / 2} + \frac{\epsilon}{2} \nabla \log \gamma(\tilde{x}) \\
  \tilde{p} &amp;:= - p_1
\end{split}
\end{equation*}\]</span></p>
<p>This might be familiar for some readers as a single step of the Leapfrog integrator. We then define the MALA kernel as follows: given the current iterate <span class="math inline">\(x_i\)</span>, we sample the next iterate <span class="math inline">\(x_{i + 1}\)</span> as</p>
<p><span class="math display">\[\begin{equation*}
\begin{split}
  p &amp;\sim \mathcal{N}(0, M) \\
  (\tilde{x}, \tilde{p}) &amp;:= L_{\epsilon}(x_i, p) \\
  \alpha &amp;:= \min \left\{ 1, \frac{\bar{\gamma}(\tilde{x}, \tilde{p})}{\bar{\gamma}(x_i, p)} \right\} \\
  x_{i + 1} &amp;:=
  \begin{cases}
    \tilde{x} \quad &amp; \text{ with prob. } \alpha \\
    x_i       \quad &amp; \text{ with prob. } 1 - \alpha
  \end{cases}
\end{split}
\end{equation*}\]</span></p>
<p>i.e.&nbsp;we accept the proposal <span class="math inline">\(\tilde{x}\)</span> with probability <span class="math inline">\(\alpha\)</span> and reject it, thus sticking with our current iterate, with probability <span class="math inline">\(1 - \alpha\)</span>.</p>
</section>
<section id="what-we-need-from-a-model-logdensityproblems.jl" class="level2">
<h2 class="anchored" data-anchor-id="what-we-need-from-a-model-logdensityproblems.jl">What we need from a model: <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a></h2>
<p>There are a few things we need from the “target” / “model” / density that we want to sample from:</p>
<ol type="1">
<li>We need access to log-density <em>evaluations</em> <span class="math inline">\(\log \gamma(x)\)</span> so we can compute the acceptance ratio involving <span class="math inline">\(\log \bar{\gamma}(x, p)\)</span>.</li>
<li>We need access to log-density <em>gradients</em> <span class="math inline">\(\nabla \log \gamma(x)\)</span> so we can compute the Leapfrog steps <span class="math inline">\(L_{\epsilon}(x, p)\)</span>.</li>
<li>We also need access to the “size” of the model so we can determine the size of <span class="math inline">\(M\)</span>.</li>
</ol>
<p>Luckily for us, there is a package called <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> which provides an interface for <em>exactly</em> this!</p>
<p>To demonstrate how one can implement the “<a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface”<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> we will use a simple Gaussian model as an example:</p>
<div id="4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogDensityProblems</span>: LogDensityProblems;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's define some type that represents the model.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IsotropicNormalModel{M<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean of the isotropic Gaussian"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    mean<span class="op">::</span><span class="dt">M</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Specifies what input length the model expects.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">dimension</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> <span class="fu">length</span>(model.mean)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Implementation of the log-density evaluation of the model.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> LogDensityProblems.<span class="fu">logdensity</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>, x<span class="op">::</span><span class="dt">AbstractVector{&lt;:Real}</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span> <span class="fu">sum</span>(abs2, x <span class="op">.-</span> model.mean) <span class="op">/</span> <span class="fl">2</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us all of the properties we want for our MALA sampler with the exception of the computation of the <em>gradient</em> <span class="math inline">\(\nabla \log \gamma(x)\)</span>. There is the method <code>LogDensityProblems.logdensity_and_gradient</code> which should return a 2-tuple where the first entry is the evaluation of the logdensity <span class="math inline">\(\log \gamma(x)\)</span> and the second entry is the gradient <span class="math inline">\(\nabla \log \gamma(x)\)</span>.</p>
<p>There are two ways to “implement” this method: 1) we implement it by hand, which is feasible in the case of our <code>IsotropicNormalModel</code>, or b) we defer the implementation of this to a automatic differentiation backend.</p>
<p>To implement it by hand we can simply do</p>
<div id="6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell LogDensityProblems.jl that first-order, i.e. gradient information, is available.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">capabilities</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> LogDensityProblems.<span class="fu">LogDensityOrder</span><span class="dt">{1}</span>()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement `logdensity_and_gradient`.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>, x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    logγ_x <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x <span class="op">=</span> <span class="op">-</span>x <span class="op">.*</span> (x <span class="op">-</span> model.mean)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> logγ_x, ∇logγ_x</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s just try it out:</p>
<div id="8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate the problem.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">IsotropicNormalModel</span>([<span class="op">-</span><span class="fl">5</span>., <span class="fl">0</span>., <span class="fl">5</span>.])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create some example input that we can test on.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>x_example <span class="op">=</span> <span class="fu">randn</span>(LogDensityProblems.<span class="fu">dimension</span>(model))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate!</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">logdensity</span>(model, x_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-26.692595385887802</code></pre>
</div>
</div>
<p>To defer it to an automatic differentiation backend, we can do</p>
<div id="10" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell LogDensityProblems.jl we only have access to 0-th order information.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">capabilities</span>(model<span class="op">::</span><span class="dt">IsotropicNormalModel</span>) <span class="op">=</span> LogDensityProblems.<span class="fu">LogDensityOrder</span><span class="dt">{0}</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `LogDensityProblemsAD`'s `ADgradient` in combination with some AD backend to implement `logdensity_and_gradient`.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogDensityProblemsAD</span>, <span class="bu">ADTypes</span>, <span class="bu">ForwardDiff</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>model_with_grad <span class="op">=</span> <span class="fu">ADgradient</span>(<span class="fu">AutoForwardDiff</span>(), model)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>LogDensityProblems.<span class="fu">logdensity</span>(model_with_grad, x_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-26.692595385887802</code></pre>
</div>
</div>
<p>We’ll continue with the second approach in this tutorial since this is typically what one does in practice, because there are better hobbies to spend time on than deriving gradients by hand.</p>
<p>At this point, one might wonder how we’re going to tie this back to Turing.jl in the end. Effectively, when working with inference methods that only require log-density evaluations and / or higher-order information of the log-density, Turing.jl actually converts the user-provided <code>Model</code> into an object implementing the above methods for <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>. As a result, most samplers provided by Turing.jl are actually implemented to work with <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>, enabling their use both <em>within</em> Turing.jl and <em>outside</em> of Turing.jl! Morever, there exists similar conversions for Stan through BridgeStan and Stan<a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a>, which means that a sampler supporting the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface can easily be used on both Turing.jl <em>and</em> Stan models (in addition to user-provided models, as our <code>IsotropicNormalModel</code> above)!</p>
<p>Anyways, let’s move on to actually implementing the sampler.</p>
</section>
<section id="implementing-mala-in-abstractmcmc.jl" class="level2">
<h2 class="anchored" data-anchor-id="implementing-mala-in-abstractmcmc.jl">Implementing MALA in <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a></h2>
<p>Now that we’ve established that a model implementing the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface provides us with all the information we need from <span class="math inline">\(\log \gamma(x)\)</span>, we can address the question: given an object that implements the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface, how can we define a sampler for it?</p>
<p>We’re going to do this by making our sampler a sub-type of <code>AbstractMCMC.AbstractSampler</code> in addition to implementing a few methods from <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a>. Why? Because it gets us <em>a lot</em> of functionality for free, as we will see later.</p>
<p>Moreover, <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> provides a very natural interface for MCMC algorithms.</p>
<p>First, we’ll define our <code>MALA</code> type</p>
<div id="12" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">AbstractMCMC</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALA{T,A} <span class="op">&lt;:</span><span class="dt"> AbstractMCMC.AbstractSampler</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stepsize used in the leapfrog step"</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    ϵ_init<span class="op">::</span><span class="dt">T</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariance matrix used for the momentum"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    M_init<span class="op">::</span><span class="dt">A</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how we’ve added the suffix <code>_init</code> to both the stepsize and the covariance matrix. We’ve done this because a <code>AbstractMCMC.AbstractSampler</code> should be <em>immutable</em>. Of course there might be many scenarios where we want to allow something like the stepsize and / or the covariance matrix to vary between iterations, e.g.&nbsp;during the burn-in / adaptation phase of the sampling process we might want to adjust the parameters using statistics computed from these initial iterations. But information which can change between iterations <em>should not go in the sampler itself</em>! Instead, this information should go in the sampler <em>state</em>.</p>
<p>The sampler state should at the very least contain all the necessary information to perform the next MCMC iteration, but usually contains further information, e.g.&nbsp;quantities and statistics useful for evaluating whether the sampler has converged.</p>
<p>We will use the following sampler state for our <code>MALA</code> sampler:</p>
<div id="14" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MALAState{A<span class="op">&lt;:</span><span class="dt">AbstractVector{&lt;:Real}</span>}</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"current position"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">::</span><span class="dt">A</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This might seem overly redundant: we’re defining a type <code>MALAState</code> and it only contains a simple vector of reals. In this particular case we indeed could have dropped this and simply used a <code>AbstractVector{&lt;:Real}</code> as our sampler state, but typically, as we will see later, one wants to include other quantities in the sampler state. For example, if we also wanted to adapt the parameters of our <code>MALA</code>, e.g.&nbsp;alter the stepsize depending on acceptance rates, in which case we should also put <code>ϵ</code> in the state, but for now we’ll keep things simple.</p>
<p>We currently have two things:</p>
<ol type="1">
<li>A <code>AbstractMCMC.AbstractSampler</code> implementation called <code>MALA</code>.</li>
<li>A state <code>MALAState</code> for our sampler <code>MALA</code>.</li>
</ol>
<p>That means that we’re ready to implement the only thing that really matters: <code>AbstractMCMC.step</code>.</p>
<p><code>AbstractMCMC.step</code> defines the MCMC iteration of our <code>MALA</code> given the current <code>MALAState</code>. Specifically, the signature of the function is as follows:</p>
<div id="16" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The RNG to ensure reproducibility.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The model that defines our target.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">::</span><span class="dt">AbstractMCMC.AbstractModel</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sampler for which we're taking a `step`.</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">AbstractMCMC.AbstractSampler</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The current sampler `state`.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    state;</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional keyword arguments that we may or may not need.</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, there is a specific <code>AbstractMCMC.AbstractModel</code> which is used to indicate that the model that is provided implements the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface: <code>AbstractMCMC.LogDensityModel</code>.</p>
<p>Since, as we discussed earlier, in our case we’re indeed going to work with types that support the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface, we’ll define <code>AbstractMCMC.step</code> for such a <code>AbstractMCMC.LogDensityModel</code>.</p>
<p>Note that <code>AbstractMCMC.LogDensityModel</code> has no other purpose; it has a single field called <code>logdensity</code>, and it does nothing else. But by wrapping the model in <code>AbstractMCMC.LogDensityModel</code>, it allows samplers that want to work with <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> to define their <code>AbstractMCMC.step</code> on this type without running into method ambiguities.</p>
<p>All in all, that means that the signature for our <code>AbstractMCMC.step</code> is going to be the following:</p>
<div id="18" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `LogDensityModel` so we know we're working with LogDensityProblems.jl model.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Our sampler.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Our sampler state.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    state<span class="op">::</span><span class="dt">MALAState</span>;</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great! Now let’s actually implement the full <code>AbstractMCMC.step</code> for our <code>MALA</code>.</p>
<p>Let’s remind ourselves what we’re going to do:</p>
<ol type="1">
<li>Sample a new momentum <span class="math inline">\(p\)</span>.</li>
<li>Compute the log-density of the extended target <span class="math inline">\(\log \bar{\gamma}(x, p)\)</span>.</li>
<li>Take a single leapfrog step <span class="math inline">\((\tilde{x}, \tilde{p}) = L_{\epsilon}(x, p)\)</span>.</li>
<li>Accept or reject the proposed <span class="math inline">\((\tilde{x}, \tilde{p})\)</span>.</li>
</ol>
<p>All in all, this results in the following:</p>
<div id="20" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>: Random</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span>  <span class="co"># so we get the `MvNormal`</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    model_wrapper<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    sampler<span class="op">::</span><span class="dt">MALA</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    state<span class="op">::</span><span class="dt">MALAState</span>;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the wrapped model which implements LogDensityProblems.jl.</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_wrapper.logdensity</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's just extract the sampler parameters to make our lives easier.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    ϵ <span class="op">=</span> sampler.ϵ_init</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sampler.M_init</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the current parameters.</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> state.x</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample the momentum.</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    p_dist <span class="op">=</span> <span class="fu">MvNormal</span>(<span class="fu">zeros</span>(LogDensityProblems.<span class="fu">dimension</span>(model)), M)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">rand</span>(rng, p_dist)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propose using a single leapfrog step.</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    x̃, p̃ <span class="op">=</span> <span class="fu">leapfrog_step</span>(model, x, p, ϵ, M)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accept or reject proposal.</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    logp <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x) <span class="op">+</span> <span class="fu">logpdf</span>(p_dist, p)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    logp̃ <span class="op">=</span> LogDensityProblems.<span class="fu">logdensity</span>(model, x̃) <span class="op">+</span> <span class="fu">logpdf</span>(p_dist, p̃)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    logα <span class="op">=</span> logp̃ <span class="op">-</span> logp</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    state_new <span class="op">=</span> <span class="cf">if</span> <span class="fu">log</span>(<span class="fu">rand</span>(rng)) <span class="op">&lt;</span> logα</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Accept.</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">MALAState</span>(x̃)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reject.</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">MALAState</span>(x)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the "sample" and the sampler state.</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> state_new.x, state_new</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fairly straight-forward.</p>
<p>Of course, we haven’t defined the <code>leapfrog_step</code> method yet, so let’s do that:</p>
<div id="22" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">leapfrog_step</span>(model, x, p, ϵ, M)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update momentum `p` using "position" `x`.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x <span class="op">=</span> <span class="fu">last</span>(LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model, x))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    p1 <span class="op">=</span> p <span class="op">+</span> (ϵ <span class="op">/</span> <span class="fl">2</span>) <span class="op">.*</span> ∇logγ_x</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the "position" `x` using momentum `p1`.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    x̃ <span class="op">=</span> x <span class="op">+</span> ϵ <span class="op">.*</span> (M <span class="op">\</span> p1)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update momentum `p1` using position `x̃`</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    ∇logγ_x̃ <span class="op">=</span> <span class="fu">last</span>(LogDensityProblems.<span class="fu">logdensity_and_gradient</span>(model, x̃))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> p1 <span class="op">+</span> (ϵ <span class="op">/</span> <span class="fl">2</span>) <span class="op">.*</span> ∇logγ_x̃</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flip momentum `p2`.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    p̃ <span class="op">=</span> <span class="op">-</span>p2</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x̃, p̃</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>leapfrog_step (generic function with 1 method)</code></pre>
</div>
</div>
<p>With all of this, we’re technically ready to sample!</p>
<div id="24" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>, <span class="bu">LinearAlgebra</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> <span class="fu">MALA</span>(<span class="fl">1</span>, I)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> <span class="fu">MALAState</span>(<span class="fu">zeros</span>(LogDensityProblems.<span class="fu">dimension</span>(model)))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>x_next, state_next <span class="op">=</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    rng,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    AbstractMCMC.<span class="fu">LogDensityModel</span>(model),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    sampler,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    state</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>([0.0, 0.0, 0.0], MALAState{Vector{Float64}}([0.0, 0.0, 0.0]))</code></pre>
</div>
</div>
<p>Great, it works!</p>
<p>And I promised we would get quite some functionality for free if we implemented <code>AbstractMCMC.step</code>, and so we can now simply call <code>sample</code> to perform standard MCMC sampling:</p>
<div id="26" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform 1000 iterations with our `MALA` sampler.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model_with_grad, sampler, <span class="fl">10_000</span>; initial_state<span class="op">=</span>state, progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate into a matrix.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>samples_matrix <span class="op">=</span> <span class="fu">stack</span>(samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×10000 Matrix{Float64}:
 -3.23624  -5.5006   -5.35189  -5.6636   …  -4.83312   -4.54927  -3.04396
  1.11399   1.67667   1.09081   0.33382      0.827862   1.42433  -0.925022
  2.94037   2.65295   5.07445   4.35065      5.91077    6.2872    6.34174</code></pre>
</div>
</div>
<div id="28" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the marginal means and standard deviations.</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hcat</span>(<span class="fu">mean</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>), <span class="fu">std</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×2 Matrix{Float64}:
 -5.01696     0.994233
  0.00283079  0.978684
  4.99908     1.009</code></pre>
</div>
</div>
<p>Let’s visualize the samples</p>
<div id="30" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StatsPlots</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">transpose</span>(samples_matrix[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">:</span><span class="kw">end</span>]), alpha<span class="op">=</span><span class="fl">0.5</span>, legend<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip660">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip660)" d="M0 1920 L2688 1920 L2688 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip661">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip660)" d="M151.747 1800.78 L2640.76 1800.78 L2640.76 47.2441 L151.747 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip662">
    <rect x="151" y="47" width="2490" height="1755"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="219.84,1800.78 219.84,47.2441 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="807.458,1800.78 807.458,47.2441 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1395.08,1800.78 1395.08,47.2441 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1982.69,1800.78 1982.69,47.2441 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2570.31,1800.78 2570.31,47.2441 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="219.84,1800.78 219.84,1781.88 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="807.458,1800.78 807.458,1781.88 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1395.08,1800.78 1395.08,1781.88 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1982.69,1800.78 1982.69,1781.88 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2570.31,1800.78 2570.31,1781.88 "></polyline>
<path clip-path="url(#clip660)" d="M219.84 1834 Q216.229 1834 214.4 1837.57 Q212.595 1841.11 212.595 1848.24 Q212.595 1855.34 214.4 1858.91 Q216.229 1862.45 219.84 1862.45 Q223.474 1862.45 225.28 1858.91 Q227.108 1855.34 227.108 1848.24 Q227.108 1841.11 225.28 1837.57 Q223.474 1834 219.84 1834 M219.84 1830.3 Q225.65 1830.3 228.706 1834.9 Q231.784 1839.49 231.784 1848.24 Q231.784 1856.96 228.706 1861.57 Q225.65 1866.15 219.84 1866.15 Q214.03 1866.15 210.951 1861.57 Q207.896 1856.96 207.896 1848.24 Q207.896 1839.49 210.951 1834.9 Q214.03 1830.3 219.84 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M771.15 1861.55 L787.47 1861.55 L787.47 1865.48 L765.525 1865.48 L765.525 1861.55 Q768.187 1858.79 772.771 1854.16 Q777.377 1849.51 778.558 1848.17 Q780.803 1845.65 781.683 1843.91 Q782.585 1842.15 782.585 1840.46 Q782.585 1837.71 780.641 1835.97 Q778.72 1834.23 775.618 1834.23 Q773.419 1834.23 770.965 1835 Q768.535 1835.76 765.757 1837.31 L765.757 1832.59 Q768.581 1831.46 771.035 1830.88 Q773.488 1830.3 775.525 1830.3 Q780.896 1830.3 784.09 1832.98 Q787.285 1835.67 787.285 1840.16 Q787.285 1842.29 786.474 1844.21 Q785.687 1846.11 783.581 1848.7 Q783.002 1849.37 779.9 1852.59 Q776.798 1855.78 771.15 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M797.331 1830.92 L815.687 1830.92 L815.687 1834.86 L801.613 1834.86 L801.613 1843.33 Q802.632 1842.98 803.65 1842.82 Q804.669 1842.64 805.687 1842.64 Q811.474 1842.64 814.854 1845.81 Q818.233 1848.98 818.233 1854.4 Q818.233 1859.97 814.761 1863.08 Q811.289 1866.15 804.97 1866.15 Q802.794 1866.15 800.525 1865.78 Q798.28 1865.41 795.872 1864.67 L795.872 1859.97 Q797.956 1861.11 800.178 1861.66 Q802.4 1862.22 804.877 1862.22 Q808.882 1862.22 811.22 1860.11 Q813.558 1858.01 813.558 1854.4 Q813.558 1850.78 811.22 1848.68 Q808.882 1846.57 804.877 1846.57 Q803.002 1846.57 801.127 1846.99 Q799.275 1847.4 797.331 1848.28 L797.331 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M837.446 1834 Q833.835 1834 832.007 1837.57 Q830.201 1841.11 830.201 1848.24 Q830.201 1855.34 832.007 1858.91 Q833.835 1862.45 837.446 1862.45 Q841.081 1862.45 842.886 1858.91 Q844.715 1855.34 844.715 1848.24 Q844.715 1841.11 842.886 1837.57 Q841.081 1834 837.446 1834 M837.446 1830.3 Q843.256 1830.3 846.312 1834.9 Q849.391 1839.49 849.391 1848.24 Q849.391 1856.96 846.312 1861.57 Q843.256 1866.15 837.446 1866.15 Q831.636 1866.15 828.557 1861.57 Q825.502 1856.96 825.502 1848.24 Q825.502 1839.49 828.557 1834.9 Q831.636 1830.3 837.446 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M1354.69 1830.92 L1373.05 1830.92 L1373.05 1834.86 L1358.98 1834.86 L1358.98 1843.33 Q1360 1842.98 1361.01 1842.82 Q1362.03 1842.64 1363.05 1842.64 Q1368.84 1842.64 1372.22 1845.81 Q1375.6 1848.98 1375.6 1854.4 Q1375.6 1859.97 1372.12 1863.08 Q1368.65 1866.15 1362.33 1866.15 Q1360.16 1866.15 1357.89 1865.78 Q1355.64 1865.41 1353.24 1864.67 L1353.24 1859.97 Q1355.32 1861.11 1357.54 1861.66 Q1359.76 1862.22 1362.24 1862.22 Q1366.25 1862.22 1368.58 1860.11 Q1370.92 1858.01 1370.92 1854.4 Q1370.92 1850.78 1368.58 1848.68 Q1366.25 1846.57 1362.24 1846.57 Q1360.37 1846.57 1358.49 1846.99 Q1356.64 1847.4 1354.69 1848.28 L1354.69 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M1394.81 1834 Q1391.2 1834 1389.37 1837.57 Q1387.56 1841.11 1387.56 1848.24 Q1387.56 1855.34 1389.37 1858.91 Q1391.2 1862.45 1394.81 1862.45 Q1398.44 1862.45 1400.25 1858.91 Q1402.08 1855.34 1402.08 1848.24 Q1402.08 1841.11 1400.25 1837.57 Q1398.44 1834 1394.81 1834 M1394.81 1830.3 Q1400.62 1830.3 1403.68 1834.9 Q1406.75 1839.49 1406.75 1848.24 Q1406.75 1856.96 1403.68 1861.57 Q1400.62 1866.15 1394.81 1866.15 Q1389 1866.15 1385.92 1861.57 Q1382.87 1856.96 1382.87 1848.24 Q1382.87 1839.49 1385.92 1834.9 Q1389 1830.3 1394.81 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M1424.97 1834 Q1421.36 1834 1419.53 1837.57 Q1417.73 1841.11 1417.73 1848.24 Q1417.73 1855.34 1419.53 1858.91 Q1421.36 1862.45 1424.97 1862.45 Q1428.61 1862.45 1430.41 1858.91 Q1432.24 1855.34 1432.24 1848.24 Q1432.24 1841.11 1430.41 1837.57 Q1428.61 1834 1424.97 1834 M1424.97 1830.3 Q1430.78 1830.3 1433.84 1834.9 Q1436.92 1839.49 1436.92 1848.24 Q1436.92 1856.96 1433.84 1861.57 Q1430.78 1866.15 1424.97 1866.15 Q1419.16 1866.15 1416.08 1861.57 Q1413.03 1856.96 1413.03 1848.24 Q1413.03 1839.49 1416.08 1834.9 Q1419.16 1830.3 1424.97 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M1940.97 1830.92 L1963.19 1830.92 L1963.19 1832.91 L1950.65 1865.48 L1945.76 1865.48 L1957.57 1834.86 L1940.97 1834.86 L1940.97 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M1972.36 1830.92 L1990.71 1830.92 L1990.71 1834.86 L1976.64 1834.86 L1976.64 1843.33 Q1977.66 1842.98 1978.68 1842.82 Q1979.7 1842.64 1980.72 1842.64 Q1986.5 1842.64 1989.88 1845.81 Q1993.26 1848.98 1993.26 1854.4 Q1993.26 1859.97 1989.79 1863.08 Q1986.32 1866.15 1980 1866.15 Q1977.82 1866.15 1975.55 1865.78 Q1973.31 1865.41 1970.9 1864.67 L1970.9 1859.97 Q1972.98 1861.11 1975.21 1861.66 Q1977.43 1862.22 1979.9 1862.22 Q1983.91 1862.22 1986.25 1860.11 Q1988.59 1858.01 1988.59 1854.4 Q1988.59 1850.78 1986.25 1848.68 Q1983.91 1846.57 1979.9 1846.57 Q1978.03 1846.57 1976.15 1846.99 Q1974.3 1847.4 1972.36 1848.28 L1972.36 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M2012.47 1834 Q2008.86 1834 2007.03 1837.57 Q2005.23 1841.11 2005.23 1848.24 Q2005.23 1855.34 2007.03 1858.91 Q2008.86 1862.45 2012.47 1862.45 Q2016.11 1862.45 2017.91 1858.91 Q2019.74 1855.34 2019.74 1848.24 Q2019.74 1841.11 2017.91 1837.57 Q2016.11 1834 2012.47 1834 M2012.47 1830.3 Q2018.28 1830.3 2021.34 1834.9 Q2024.42 1839.49 2024.42 1848.24 Q2024.42 1856.96 2021.34 1861.57 Q2018.28 1866.15 2012.47 1866.15 Q2006.66 1866.15 2003.59 1861.57 Q2000.53 1856.96 2000.53 1848.24 Q2000.53 1839.49 2003.59 1834.9 Q2006.66 1830.3 2012.47 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M2514.84 1861.55 L2522.48 1861.55 L2522.48 1835.18 L2514.17 1836.85 L2514.17 1832.59 L2522.43 1830.92 L2527.11 1830.92 L2527.11 1861.55 L2534.75 1861.55 L2534.75 1865.48 L2514.84 1865.48 L2514.84 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M2554.19 1834 Q2550.58 1834 2548.75 1837.57 Q2546.94 1841.11 2546.94 1848.24 Q2546.94 1855.34 2548.75 1858.91 Q2550.58 1862.45 2554.19 1862.45 Q2557.82 1862.45 2559.63 1858.91 Q2561.46 1855.34 2561.46 1848.24 Q2561.46 1841.11 2559.63 1837.57 Q2557.82 1834 2554.19 1834 M2554.19 1830.3 Q2560 1830.3 2563.06 1834.9 Q2566.13 1839.49 2566.13 1848.24 Q2566.13 1856.96 2563.06 1861.57 Q2560 1866.15 2554.19 1866.15 Q2548.38 1866.15 2545.3 1861.57 Q2542.25 1856.96 2542.25 1848.24 Q2542.25 1839.49 2545.3 1834.9 Q2548.38 1830.3 2554.19 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M2584.35 1834 Q2580.74 1834 2578.91 1837.57 Q2577.11 1841.11 2577.11 1848.24 Q2577.11 1855.34 2578.91 1858.91 Q2580.74 1862.45 2584.35 1862.45 Q2587.99 1862.45 2589.79 1858.91 Q2591.62 1855.34 2591.62 1848.24 Q2591.62 1841.11 2589.79 1837.57 Q2587.99 1834 2584.35 1834 M2584.35 1830.3 Q2590.16 1830.3 2593.22 1834.9 Q2596.3 1839.49 2596.3 1848.24 Q2596.3 1856.96 2593.22 1861.57 Q2590.16 1866.15 2584.35 1866.15 Q2578.54 1866.15 2575.46 1861.57 Q2572.41 1856.96 2572.41 1848.24 Q2572.41 1839.49 2575.46 1834.9 Q2578.54 1830.3 2584.35 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M2614.51 1834 Q2610.9 1834 2609.07 1837.57 Q2607.27 1841.11 2607.27 1848.24 Q2607.27 1855.34 2609.07 1858.91 Q2610.9 1862.45 2614.51 1862.45 Q2618.15 1862.45 2619.95 1858.91 Q2621.78 1855.34 2621.78 1848.24 Q2621.78 1841.11 2619.95 1837.57 Q2618.15 1834 2614.51 1834 M2614.51 1830.3 Q2620.32 1830.3 2623.38 1834.9 Q2626.46 1839.49 2626.46 1848.24 Q2626.46 1856.96 2623.38 1861.57 Q2620.32 1866.15 2614.51 1866.15 Q2608.7 1866.15 2605.62 1861.57 Q2602.57 1856.96 2602.57 1848.24 Q2602.57 1839.49 2605.62 1834.9 Q2608.7 1830.3 2614.51 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,1509.35 2640.76,1509.35 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,1213.47 2640.76,1213.47 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,917.585 2640.76,917.585 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,621.7 2640.76,621.7 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="151.747,325.816 2640.76,325.816 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1800.78 151.747,47.2441 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1509.35 170.644,1509.35 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,1213.47 170.644,1213.47 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,917.585 170.644,917.585 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,621.7 170.644,621.7 "></polyline>
<polyline clip-path="url(#clip660)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="151.747,325.816 170.644,325.816 "></polyline>
<path clip-path="url(#clip660)" d="M49.5521 1509.8 L79.2279 1509.8 L79.2279 1513.74 L49.5521 1513.74 L49.5521 1509.8 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M99.8991 1507.49 Q96.7509 1507.49 94.8991 1509.64 Q93.0704 1511.8 93.0704 1515.55 Q93.0704 1519.27 94.8991 1521.45 Q96.7509 1523.6 99.8991 1523.6 Q103.047 1523.6 104.876 1521.45 Q106.728 1519.27 106.728 1515.55 Q106.728 1511.8 104.876 1509.64 Q103.047 1507.49 99.8991 1507.49 M109.181 1492.84 L109.181 1497.1 Q107.422 1496.26 105.617 1495.82 Q103.834 1495.38 102.075 1495.38 Q97.4454 1495.38 94.9917 1498.51 Q92.5612 1501.63 92.2139 1507.95 Q93.5797 1505.94 95.6398 1504.87 Q97.7 1503.79 100.177 1503.79 Q105.385 1503.79 108.394 1506.96 Q111.427 1510.11 111.427 1515.55 Q111.427 1520.87 108.279 1524.09 Q105.131 1527.3 99.8991 1527.3 Q93.9037 1527.3 90.7325 1522.72 Q87.5612 1518.11 87.5612 1509.39 Q87.5612 1501.19 91.45 1496.33 Q95.3389 1491.45 101.89 1491.45 Q103.649 1491.45 105.431 1491.8 Q107.237 1492.14 109.181 1492.84 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M50.3623 1213.92 L80.0381 1213.92 L80.0381 1217.86 L50.3623 1217.86 L50.3623 1213.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M104.297 1212.11 Q107.654 1212.83 109.529 1215.1 Q111.427 1217.37 111.427 1220.7 Q111.427 1225.82 107.908 1228.62 Q104.39 1231.42 97.9083 1231.42 Q95.7324 1231.42 93.4176 1230.98 Q91.126 1230.56 88.6723 1229.71 L88.6723 1225.19 Q90.6167 1226.33 92.9315 1226.91 Q95.2463 1227.48 97.7695 1227.48 Q102.168 1227.48 104.459 1225.75 Q106.774 1224.01 106.774 1220.7 Q106.774 1217.65 104.621 1215.93 Q102.492 1214.2 98.6722 1214.2 L94.6445 1214.2 L94.6445 1210.36 L98.8574 1210.36 Q102.306 1210.36 104.135 1208.99 Q105.964 1207.6 105.964 1205.01 Q105.964 1202.35 104.066 1200.93 Q102.191 1199.5 98.6722 1199.5 Q96.7509 1199.5 94.5519 1199.92 Q92.3528 1200.33 89.7139 1201.21 L89.7139 1197.05 Q92.376 1196.3 94.6908 1195.93 Q97.0287 1195.56 99.0889 1195.56 Q104.413 1195.56 107.515 1197.99 Q110.617 1200.4 110.617 1204.52 Q110.617 1207.39 108.973 1209.38 Q107.33 1211.35 104.297 1212.11 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M99.4824 903.383 Q95.8713 903.383 94.0426 906.948 Q92.2371 910.49 92.2371 917.619 Q92.2371 924.726 94.0426 928.291 Q95.8713 931.832 99.4824 931.832 Q103.117 931.832 104.922 928.291 Q106.751 924.726 106.751 917.619 Q106.751 910.49 104.922 906.948 Q103.117 903.383 99.4824 903.383 M99.4824 899.68 Q105.293 899.68 108.348 904.286 Q111.427 908.869 111.427 917.619 Q111.427 926.346 108.348 930.953 Q105.293 935.536 99.4824 935.536 Q93.6723 935.536 90.5936 930.953 Q87.538 926.346 87.538 917.619 Q87.538 908.869 90.5936 904.286 Q93.6723 899.68 99.4824 899.68 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M104.297 620.346 Q107.654 621.064 109.529 623.332 Q111.427 625.601 111.427 628.934 Q111.427 634.05 107.908 636.851 Q104.39 639.652 97.9083 639.652 Q95.7324 639.652 93.4176 639.212 Q91.126 638.795 88.6723 637.939 L88.6723 633.425 Q90.6167 634.559 92.9315 635.138 Q95.2463 635.717 97.7695 635.717 Q102.168 635.717 104.459 633.981 Q106.774 632.244 106.774 628.934 Q106.774 625.879 104.621 624.166 Q102.492 622.43 98.6722 622.43 L94.6445 622.43 L94.6445 618.587 L98.8574 618.587 Q102.306 618.587 104.135 617.221 Q105.964 615.832 105.964 613.24 Q105.964 610.578 104.066 609.166 Q102.191 607.731 98.6722 607.731 Q96.7509 607.731 94.5519 608.147 Q92.3528 608.564 89.7139 609.444 L89.7139 605.277 Q92.376 604.536 94.6908 604.166 Q97.0287 603.795 99.0889 603.795 Q104.413 603.795 107.515 606.226 Q110.617 608.633 110.617 612.754 Q110.617 615.624 108.973 617.615 Q107.33 619.582 104.297 620.346 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip660)" d="M99.8991 323.953 Q96.7509 323.953 94.8991 326.106 Q93.0704 328.258 93.0704 332.008 Q93.0704 335.735 94.8991 337.911 Q96.7509 340.064 99.8991 340.064 Q103.047 340.064 104.876 337.911 Q106.728 335.735 106.728 332.008 Q106.728 328.258 104.876 326.106 Q103.047 323.953 99.8991 323.953 M109.181 309.3 L109.181 313.559 Q107.422 312.726 105.617 312.286 Q103.834 311.846 102.075 311.846 Q97.4454 311.846 94.9917 314.971 Q92.5612 318.096 92.2139 324.416 Q93.5797 322.402 95.6398 321.337 Q97.7 320.249 100.177 320.249 Q105.385 320.249 108.394 323.42 Q111.427 326.569 111.427 332.008 Q111.427 337.332 108.279 340.55 Q105.131 343.768 99.8991 343.768 Q93.9037 343.768 90.7325 339.184 Q87.5612 334.578 87.5612 325.851 Q87.5612 317.657 91.45 312.796 Q95.3389 307.911 101.89 307.911 Q103.649 307.911 105.431 308.259 Q107.237 308.606 109.181 309.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip662)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,1236.77 224.541,1421.75 226.891,1246.53 229.242,1241.74 231.592,1342.61 233.943,1490.29 236.293,1462.42 238.644,1407.51 240.994,1346.15 243.345,1559.17 245.695,1457.11 248.046,1446.43 250.396,1458.49 252.747,1390.29 255.097,1609.31 257.448,1393.63 259.798,1347.69 262.148,1438.38 264.499,1496.54 266.849,1329.81 269.2,1331.94 271.55,1519.66 273.901,1306.52 276.251,1404.86 278.602,1373.62 280.952,1427.88 283.303,1648.77 285.653,1531.4 288.004,1318.45 290.354,1243.24 292.705,1227.36 295.055,1376.77 297.406,1498.08 299.756,1535.41 302.107,1567.17 304.457,1455.49 306.807,1402.5 309.158,1399.72 311.508,1477.33 313.859,1345.9 316.209,1195.62 318.56,1341.34 320.91,1255.08 323.261,1202.24 325.611,1568.86 327.962,1424.96 330.312,1482.35 332.663,1255.46 335.013,1438.97 337.364,1312.75 339.714,1504.8 342.065,1403.05 344.415,1399.84 346.765,1429.79 349.116,1448.02 351.466,1528.54 353.817,1348.67 356.167,1388.03 358.518,1384.78 360.868,1339.38 363.219,1411.37 365.569,1408.77 367.92,1444.54 370.27,1420.23 372.621,1498.48 374.971,1425.45 377.322,1495.88 379.672,1494.36 382.023,1285.43 384.373,1451.94 386.724,1368.45 389.074,1393.83 391.424,1317.15 393.775,1375.67 396.125,1429.21 398.476,1344.37 400.826,1454.97 403.177,1407.35 405.527,1443.46 407.878,1402.41 410.228,1412.59 412.579,1396.71 414.929,1350.34 417.28,1447.71 419.63,1285.86 421.981,1357.18 424.331,1571.51 426.682,1441.5 429.032,1344.43 431.382,1426.66 433.733,1428.5 436.083,1471.92 438.434,1387.31 440.784,1418.69 443.135,1252.39 445.485,1273.66 447.836,1392.94 450.186,1457.91 452.537,1543.38 454.887,1387.2 457.238,1324.45 459.588,1456.78 461.939,1635.59 464.289,1363.43 466.64,1435.03 468.99,1354.44 471.341,1605.68 473.691,1527.8 476.041,1406.98 478.392,1369.25 480.742,1381.35 483.093,1179.38 485.443,1390.26 487.794,1484.33 490.144,1450.94 492.495,1305.63 494.845,1514.66 497.196,1507.64 499.546,1368.8 501.897,1399.41 504.247,1374.98 506.598,1654.05 508.948,1507.35 511.299,1356.56 513.649,1537.52 515.999,1415.17 518.35,1298.04 520.7,1313.83 523.051,1378.86 525.401,1500.85 527.752,1292.45 530.102,1480.72 532.453,1446.84 534.803,1462.13 537.154,1434.51 539.504,1291.57 541.855,1332.15 544.205,1294.48 546.556,1497.33 548.906,1367.32 551.257,1339.6 553.607,1371.73 555.958,1489.23 558.308,1491.1 560.658,1428.21 563.009,1318.51 565.359,1363.99 567.71,1575.86 570.06,1129.81 572.411,1358.2 574.761,1421.03 577.112,1372.29 579.462,1319.78 581.813,1492.65 584.163,1401.94 586.514,1406.15 588.864,1496.54 591.215,1423.94 593.565,1399.99 595.916,1331.78 598.266,1370.57 600.616,1430.94 602.967,1306.81 605.317,1421.62 607.668,1579.11 610.018,1442.8 612.369,1457.28 614.719,1355.32 617.07,1273.77 619.42,1434.37 621.771,1342.65 624.121,1402.13 626.472,1480.55 628.822,1478.7 631.173,1605.14 633.523,1402.74 635.874,1469.47 638.224,1425.44 640.575,1558.89 642.925,1443.61 645.275,1391.08 647.626,1448.48 649.976,1172.6 652.327,1495.65 654.677,1418.1 657.028,1446.27 659.378,1375.56 661.729,1289.58 664.079,1303.39 666.43,1360.45 668.78,1473.7 671.131,1320.99 673.481,1369.98 675.832,1536.66 678.182,1654.85 680.533,1564.91 682.883,1570.9 685.233,1518.13 687.584,1450.85 689.934,1464.27 692.285,1361.83 694.635,1507.88 696.986,1175.97 699.336,1460.98 701.687,1402.47 704.037,1247.7 706.388,1417.64 708.738,1287.79 711.089,1438 713.439,1615.99 715.79,1389.94 718.14,1375.82 720.491,1332.2 722.841,1344.77 725.192,1305.12 727.542,1557.67 729.892,1411.91 732.243,1232.17 734.593,1423.9 736.944,1496.08 739.294,1440.55 741.645,1462.59 743.995,1417.4 746.346,1332.69 748.696,1315.56 751.047,1491.95 753.397,1502.13 755.748,1532.28 758.098,1547.07 760.449,1421.14 762.799,1398.64 765.15,1415.64 767.5,1572.58 769.85,1366.32 772.201,1473.07 774.551,1333.09 776.902,1286.53 779.252,1470.17 781.603,1273.44 783.953,1400.85 786.304,1317.46 788.654,1490.24 791.005,1251.52 793.355,1279.44 795.706,1471.34 798.056,1572.45 800.407,1539.3 802.757,1413.36 805.108,1479.98 807.458,1442.04 809.809,1447.29 812.159,1485.16 814.509,1429.67 816.86,1214.59 819.21,1320.5 821.561,1311.26 823.911,1370.97 826.262,1414.85 828.612,1333.37 830.963,1455.06 833.313,1494.76 835.664,1516.75 838.014,1349.04 840.365,1238.29 842.715,1268.23 845.066,1461.58 847.416,1566.24 849.767,1306.62 852.117,1458.73 854.467,1390.54 856.818,1443.53 859.168,1385.02 861.519,1592.61 863.869,1403.06 866.22,1277.75 868.57,1357.92 870.921,1413.5 873.271,1494.58 875.622,1574.09 877.972,1531.77 880.323,1396.14 882.673,1497.98 885.024,1440.02 887.374,1422.21 889.725,1426.32 892.075,1227.19 894.426,1281.73 896.776,1415.86 899.126,1579.86 901.477,1330.74 903.827,1391.99 906.178,1386.72 908.528,1317.68 910.879,1456.51 913.229,1255.77 915.58,1458.88 917.93,1615.75 920.281,1435.92 922.631,1295.8 924.982,1419.94 927.332,1150.19 929.683,1264.1 932.033,1344.49 934.384,1279.21 936.734,1396.01 939.084,1439.53 941.435,1430.02 943.785,1422.51 946.136,1325.38 948.486,1494.93 950.837,1392.51 953.187,1538.85 955.538,1498.4 957.888,1735.66 960.239,1408.15 962.589,1550.63 964.94,1240.23 967.29,1501.56 969.641,1337.27 971.991,1483.83 974.342,1395.69 976.692,1401.38 979.043,1502.68 981.393,1451.37 983.743,1426.44 986.094,1403.55 988.444,1427.46 990.795,1484.84 993.145,1292.08 995.496,1307.87 997.846,1359.15 1000.2,1360.81 1002.55,1516.63 1004.9,1410.16 1007.25,1355.51 1009.6,1399.08 1011.95,1574.46 1014.3,1489.21 1016.65,1464.75 1019,1450.01 1021.35,1335.24 1023.7,1526.07 1026.05,1386.01 1028.4,1543.63 1030.75,1337.59 1033.1,1399.19 1035.45,1334.14 1037.8,1292.82 1040.15,1483.16 1042.51,1535.95 1044.86,1381.7 1047.21,1322.48 1049.56,1430.59 1051.91,1499.44 1054.26,1357.55 1056.61,1303.37 1058.96,1372.85 1061.31,1458.88 1063.66,1490.86 1066.01,1456.16 1068.36,1387.17 1070.71,1398.34 1073.06,1547.82 1075.41,1536.39 1077.76,1360.65 1080.11,1332.15 1082.46,1541.64 1084.81,1488.35 1087.16,1261.76 1089.51,1325.8 1091.87,1313.32 1094.22,1390.95 1096.57,1468.56 1098.92,1466.8 1101.27,1488.74 1103.62,1384.87 1105.97,1464.57 1108.32,1295.5 1110.67,1463.86 1113.02,1441.53 1115.37,1359.37 1117.72,1451.2 1120.07,1484.4 1122.42,1503.17 1124.77,1408.58 1127.12,1564.96 1129.47,1431.17 1131.82,1611.84 1134.17,1385.81 1136.52,1281.7 1138.87,1512.27 1141.23,1314.69 1143.58,1445.15 1145.93,1417.89 1148.28,1573.19 1150.63,1485.76 1152.98,1486.1 1155.33,1350.07 1157.68,1596.44 1160.03,1394.9 1162.38,1508.8 1164.73,1400.69 1167.08,1374.74 1169.43,1455.63 1171.78,1344.17 1174.13,1377.54 1176.48,1283.73 1178.83,1395.94 1181.18,1298.78 1183.53,1431.93 1185.88,1450.61 1188.23,1552.41 1190.59,1306.74 1192.94,1391.99 1195.29,1289.84 1197.64,1217.07 1199.99,1518.15 1202.34,1277.96 1204.69,1511.38 1207.04,1450.77 1209.39,1381.12 1211.74,1515.32 1214.09,1478 1216.44,1234.22 1218.79,1488.83 1221.14,1422.78 1223.49,1394.53 1225.84,1297.63 1228.19,1403.28 1230.54,1342.07 1232.89,1300.56 1235.24,1412.97 1237.59,1400.42 1239.94,1555.54 1242.3,1331.49 1244.65,1404.86 1247,1444.32 1249.35,1506.62 1251.7,1353.37 1254.05,1691.17 1256.4,1489.14 1258.75,1323.15 1261.1,1289.38 1263.45,1436.01 1265.8,1429.73 1268.15,1335.83 1270.5,1440.07 1272.85,1340.09 1275.2,1396.78 1277.55,1331.54 1279.9,1423.34 1282.25,1292.99 1284.6,1255.7 1286.95,1563.78 1289.3,1409.23 1291.66,1383.83 1294.01,1321.23 1296.36,1450 1298.71,1340.63 1301.06,1361.13 1303.41,1533.4 1305.76,1353.47 1308.11,1383.7 1310.46,1423.53 1312.81,1589.61 1315.16,1263.24 1317.51,1331.03 1319.86,1457.8 1322.21,1397.18 1324.56,1400.81 1326.91,1411.08 1329.26,1415.4 1331.61,1515.73 1333.96,1310.37 1336.31,1405.51 1338.66,1406.76 1341.02,1517.72 1343.37,1383.28 1345.72,1470.08 1348.07,1437.15 1350.42,1353.85 1352.77,1450.38 1355.12,1466.01 1357.47,1301.55 1359.82,1406.93 1362.17,1467.31 1364.52,1521.55 1366.87,1374.68 1369.22,1355.67 1371.57,1338.95 1373.92,1448.48 1376.27,1420.84 1378.62,1385.06 1380.97,1288.28 1383.32,1544.36 1385.67,1421.19 1388.02,1409.85 1390.38,1389.86 1392.73,1392.13 1395.08,1479.43 1397.43,1384.21 1399.78,1295.87 1402.13,1440.76 1404.48,1328.88 1406.83,1461.29 1409.18,1491.32 1411.53,1384.17 1413.88,1524.95 1416.23,1457.28 1418.58,1555.06 1420.93,1426.58 1423.28,1399.33 1425.63,1239.87 1427.98,1530.62 1430.33,1331.09 1432.68,1472.65 1435.03,1450.38 1437.38,1320.78 1439.74,1349.74 1442.09,1515.25 1444.44,1545.04 1446.79,1401.52 1449.14,1534.06 1451.49,1379 1453.84,1494.89 1456.19,1398.39 1458.54,1426.73 1460.89,1456.95 1463.24,1538.32 1465.59,1561.55 1467.94,1432.69 1470.29,1429.63 1472.64,1286.46 1474.99,1314.12 1477.34,1498.98 1479.69,1335.35 1482.04,1307.47 1484.39,1464.44 1486.74,1428.15 1489.1,1751.15 1491.45,1440.32 1493.8,1463.83 1496.15,1392.86 1498.5,1262.22 1500.85,1419.09 1503.2,1394.6 1505.55,1443.14 1507.9,1431.28 1510.25,1370.8 1512.6,1308.43 1514.95,1572.14 1517.3,1251.63 1519.65,1400.77 1522,1362.15 1524.35,1468.09 1526.7,1401.56 1529.05,1722.37 1531.4,1430.9 1533.75,1540.63 1536.1,1459 1538.45,1426.8 1540.81,1460.84 1543.16,1619.15 1545.51,1626.99 1547.86,1443.78 1550.21,1266.94 1552.56,1379.08 1554.91,1210.88 1557.26,1288.09 1559.61,1373.07 1561.96,1435.01 1564.31,1587.96 1566.66,1474.67 1569.01,1292.11 1571.36,1438.64 1573.71,1490.26 1576.06,1652.3 1578.41,1471.27 1580.76,1376.78 1583.11,1477.16 1585.46,1489.05 1587.81,1426.99 1590.17,1371.24 1592.52,1510.1 1594.87,1442.41 1597.22,1469.86 1599.57,1501.86 1601.92,1440.47 1604.27,1330.8 1606.62,1401.63 1608.97,1318.18 1611.32,1204.47 1613.67,1460.66 1616.02,1407.38 1618.37,1378.45 1620.72,1572.44 1623.07,1431.9 1625.42,1200.66 1627.77,1287.74 1630.12,1333.3 1632.47,1445.64 1634.82,1498.87 1637.17,1528.62 1639.53,1512.1 1641.88,1609.21 1644.23,1489.68 1646.58,1398.07 1648.93,1438.35 1651.28,1554.7 1653.63,1448.05 1655.98,1206.84 1658.33,1341.43 1660.68,1321.88 1663.03,1304.51 1665.38,1497.09 1667.73,1415.38 1670.08,1409.48 1672.43,1355.76 1674.78,1493.71 1677.13,1469.65 1679.48,1402.41 1681.83,1406.81 1684.18,1493.16 1686.53,1323.96 1688.89,1439.12 1691.24,1353.39 1693.59,1473.74 1695.94,1382.79 1698.29,1336.43 1700.64,1408.1 1702.99,1705.79 1705.34,1473.9 1707.69,1537.79 1710.04,1263.01 1712.39,1563.63 1714.74,1328.7 1717.09,1505.13 1719.44,1507.87 1721.79,1591.91 1724.14,1334.22 1726.49,1446.23 1728.84,1414.98 1731.19,1421.49 1733.54,1347.3 1735.89,1225.59 1738.25,1510.65 1740.6,1548.89 1742.95,1448.66 1745.3,1537.19 1747.65,1541.12 1750,1506.5 1752.35,1366.94 1754.7,1456.36 1757.05,1507.32 1759.4,1228.05 1761.75,1312.82 1764.1,1514.74 1766.45,1441.52 1768.8,1267.32 1771.15,1294.92 1773.5,1473.4 1775.85,1438.67 1778.2,1553.44 1780.55,1477.79 1782.9,1342.87 1785.25,1442.95 1787.6,1284.01 1789.96,1415.55 1792.31,1440.93 1794.66,1274.22 1797.01,1632.46 1799.36,1370.65 1801.71,1438.13 1804.06,1423.82 1806.41,1338.68 1808.76,1269.65 1811.11,1439.17 1813.46,1430.62 1815.81,1295.33 1818.16,1449.77 1820.51,1349.16 1822.86,1426.4 1825.21,1323.37 1827.56,1293.03 1829.91,1220.45 1832.26,1471.53 1834.61,1417.38 1836.96,1509.85 1839.32,1406.85 1841.67,1500.52 1844.02,1455.63 1846.37,1423.6 1848.72,1427.53 1851.07,1382.37 1853.42,1518 1855.77,1410.2 1858.12,1180.38 1860.47,1637.45 1862.82,1479.73 1865.17,1383.37 1867.52,1343.79 1869.87,1395.02 1872.22,1333.12 1874.57,1481.69 1876.92,1466.88 1879.27,1460.26 1881.62,1359.79 1883.97,1313.44 1886.32,1476.75 1888.68,1266.39 1891.03,1631.34 1893.38,1402.42 1895.73,1340.6 1898.08,1385.53 1900.43,1432 1902.78,1472.33 1905.13,1430.11 1907.48,1447.06 1909.83,1453.6 1912.18,1537.24 1914.53,1391.4 1916.88,1326.85 1919.23,1601.33 1921.58,1347.24 1923.93,1234.39 1926.28,1428.58 1928.63,1281.07 1930.98,1366.76 1933.33,1528.12 1935.68,1338.83 1938.04,1432.66 1940.39,1534.19 1942.74,1601.8 1945.09,1488.32 1947.44,1237.31 1949.79,1269.89 1952.14,1450.52 1954.49,1332.36 1956.84,1465.47 1959.19,1552.77 1961.54,1526.76 1963.89,1545.67 1966.24,1375.36 1968.59,1321.52 1970.94,1412.21 1973.29,1305.15 1975.64,1394.69 1977.99,1416.54 1980.34,1542.24 1982.69,1432.08 1985.04,1370.52 1987.4,1547.4 1989.75,1488.4 1992.1,1376.99 1994.45,1401.6 1996.8,1693.53 1999.15,1510.42 2001.5,1471.33 2003.85,1423.17 2006.2,1162.57 2008.55,1421.76 2010.9,1495.16 2013.25,1357.45 2015.6,1338.01 2017.95,1522.46 2020.3,1458.37 2022.65,1341.97 2025,1524.51 2027.35,1452.39 2029.7,1500.43 2032.05,1115.09 2034.4,1279.58 2036.76,1399.81 2039.11,1367.59 2041.46,1425.99 2043.81,1380.66 2046.16,1498.3 2048.51,1559.95 2050.86,1181.7 2053.21,1247.86 2055.56,1506.93 2057.91,1335.33 2060.26,1406.87 2062.61,1369.63 2064.96,1450.26 2067.31,1460.99 2069.66,1404.98 2072.01,1410.36 2074.36,1309.82 2076.71,1317.93 2079.06,1309.67 2081.41,1578.66 2083.76,1262.49 2086.11,1496.07 2088.47,1421.41 2090.82,1313.46 2093.17,1434.88 2095.52,1521.07 2097.87,1198.11 2100.22,1379.07 2102.57,1257.61 2104.92,1423.89 2107.27,1331.36 2109.62,1317.3 2111.97,1303.2 2114.32,1526.5 2116.67,1391.17 2119.02,1335.12 2121.37,1387.31 2123.72,1409.9 2126.07,1376.47 2128.42,1482.63 2130.77,1383.07 2133.12,1321.27 2135.47,1312.55 2137.83,1296.29 2140.18,1409.18 2142.53,1502.26 2144.88,1260.14 2147.23,1513.44 2149.58,1324.82 2151.93,1466.24 2154.28,1449.14 2156.63,1412.19 2158.98,1619.51 2161.33,1559.88 2163.68,1588.29 2166.03,1440.37 2168.38,1467.28 2170.73,1309.31 2173.08,1457.38 2175.43,1471.08 2177.78,1308.57 2180.13,1275.09 2182.48,1406.62 2184.83,1412.61 2187.19,1431.6 2189.54,1398.92 2191.89,1387.42 2194.24,1314.38 2196.59,1432.12 2198.94,1518.84 2201.29,1320.66 2203.64,1436.81 2205.99,1291.46 2208.34,1261.48 2210.69,1505.48 2213.04,1527.55 2215.39,1389.02 2217.74,1378.82 2220.09,1380.3 2222.44,1374.28 2224.79,1424.11 2227.14,1294.7 2229.49,1372.63 2231.84,1394.42 2234.19,1351.31 2236.55,1483.11 2238.9,1474.93 2241.25,1408.9 2243.6,1335.04 2245.95,1630.76 2248.3,1327.77 2250.65,1402.79 2253,1315.15 2255.35,1293.77 2257.7,1469.18 2260.05,1489.25 2262.4,1424.33 2264.75,1445.58 2267.1,1346.71 2269.45,1417.72 2271.8,1351.67 2274.15,1420.43 2276.5,1435.51 2278.85,1535.77 2281.2,1614.59 2283.55,1421.73 2285.91,1422.55 2288.26,1498.19 2290.61,1394.22 2292.96,1290.94 2295.31,1443.98 2297.66,1568.85 2300.01,1548.71 2302.36,1384.14 2304.71,1396.19 2307.06,1462.28 2309.41,1586.49 2311.76,1315.98 2314.11,1552.24 2316.46,1277.37 2318.81,1457.39 2321.16,1353.59 2323.51,1240.54 2325.86,1205.47 2328.21,1313.48 2330.56,1317.28 2332.91,1221.2 2335.27,1556.38 2337.62,1127.78 2339.97,1234.57 2342.32,1315.86 2344.67,1495.46 2347.02,1354.77 2349.37,1398.69 2351.72,1565.85 2354.07,1229.94 2356.42,1309.5 2358.77,1399.91 2361.12,1446.31 2363.47,1381.35 2365.82,1520.91 2368.17,1357.83 2370.52,1292.95 2372.87,1430.58 2375.22,1339.42 2377.57,1426.53 2379.92,1531.19 2382.27,1384.23 2384.62,1426.07 2386.98,1362.13 2389.33,1440.94 2391.68,1477.16 2394.03,1591.8 2396.38,1383.96 2398.73,1377.21 2401.08,1240.34 2403.43,1319.54 2405.78,1293.86 2408.13,1398.73 2410.48,1375.6 2412.83,1305.69 2415.18,1448.9 2417.53,1402.69 2419.88,1495.67 2422.23,1380.93 2424.58,1224.17 2426.93,1387.94 2429.28,1357.86 2431.63,1417.58 2433.98,1575.88 2436.34,1492.54 2438.69,1465.4 2441.04,1340.35 2443.39,1422.4 2445.74,1434.28 2448.09,1546.27 2450.44,1581.08 2452.79,1414.1 2455.14,1228.4 2457.49,1569.29 2459.84,1296.86 2462.19,1426.72 2464.54,1484.69 2466.89,1431.46 2469.24,1281.9 2471.59,1570.22 2473.94,1300.9 2476.29,1389.61 2478.64,1536.78 2480.99,1438.98 2483.34,1589.81 2485.7,1280.77 2488.05,1354.5 2490.4,1189.71 2492.75,1386.8 2495.1,1354.27 2497.45,1343.53 2499.8,1539.16 2502.15,1439.79 2504.5,1479.38 2506.85,1326.95 2509.2,1576.91 2511.55,1367.22 2513.9,1531.22 2516.25,1280.47 2518.6,1395.4 2520.95,1410.8 2523.3,1622.6 2525.65,1428.42 2528,1168.62 2530.35,1381.88 2532.7,1334.59 2535.06,1377.59 2537.41,1383.58 2539.76,1596.87 2542.11,1326.73 2544.46,1505.25 2546.81,1472.01 2549.16,1509.52 2551.51,1319.06 2553.86,1383.8 2556.21,1436.69 2558.56,1442.18 2560.91,1318.13 2563.26,1227.86 2565.61,1518.97 2567.96,1489.7 2570.31,1392.58 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,807.714 224.541,840.81 226.891,808.824 229.242,779.49 231.592,815.057 233.943,698.053 236.293,859.427 238.644,907.891 240.994,1069.25 243.345,865.699 245.695,872.904 248.046,934.929 250.396,988.576 252.747,847.5 255.097,899.257 257.448,951.58 259.798,1005.66 262.148,973.074 264.499,921.327 266.849,869.63 269.2,802.621 271.55,943.779 273.901,898.992 276.251,841.997 278.602,949.252 280.952,1026.75 283.303,935.231 285.653,1014.87 288.004,888.565 290.354,957.683 292.705,876.926 295.055,877.361 297.406,901.477 299.756,903.495 302.107,764.835 304.457,812.501 306.807,961.79 309.158,861.799 311.508,769.739 313.859,876.457 316.209,928.307 318.56,819.803 320.91,784.191 323.261,964.849 325.611,901.415 327.962,882.62 330.312,856.536 332.663,739.719 335.013,1066.49 337.364,929.474 339.714,1027.88 342.065,791.87 344.415,985.087 346.765,881.317 349.116,1002.71 351.466,795.351 353.817,1118.58 356.167,832.308 358.518,869.136 360.868,867.639 363.219,1203.87 365.569,931.231 367.92,1013.45 370.27,836.934 372.621,1039.59 374.971,823.906 377.322,980.999 379.672,944.432 382.023,881.777 384.373,862.546 386.724,884.129 389.074,954.913 391.424,897.006 393.775,901.489 396.125,868.174 398.476,758.3 400.826,889.514 403.177,923.454 405.527,1115.14 407.878,896.157 410.228,852.828 412.579,981.288 414.929,971.697 417.28,920.856 419.63,1074.43 421.981,848.426 424.331,805.906 426.682,887.898 429.032,910.841 431.382,879.076 433.733,964.531 436.083,966.107 438.434,1033.84 440.784,937.209 443.135,1032.48 445.485,793.831 447.836,837.908 450.186,918.061 452.537,983.224 454.887,994.788 457.238,722.353 459.588,1076.92 461.939,827.039 464.289,893.336 466.64,707.492 468.99,1010.96 471.341,829.079 473.691,847.374 476.041,787.421 478.392,910.022 480.742,920.979 483.093,1055.02 485.443,778.299 487.794,1042.22 490.144,928.248 492.495,698.515 494.845,904.893 497.196,823.318 499.546,1000.21 501.897,858.29 504.247,1009.84 506.598,1026.11 508.948,1064.67 511.299,894.384 513.649,967.446 515.999,813.723 518.35,971.593 520.7,1028.34 523.051,892.651 525.401,823.944 527.752,935.335 530.102,928.202 532.453,1112.06 534.803,868.823 537.154,893.422 539.504,898.419 541.855,903.017 544.205,864.351 546.556,910.801 548.906,939.284 551.257,941.881 553.607,928.036 555.958,947.039 558.308,1004.88 560.658,982.459 563.009,957.861 565.359,1013.82 567.71,1078.84 570.06,844.665 572.411,810.718 574.761,1051.34 577.112,983.111 579.462,942.404 581.813,1025.93 584.163,993.216 586.514,950.447 588.864,1009.94 591.215,1174.66 593.565,944.446 595.916,820.814 598.266,1014.57 600.616,875.152 602.967,821.171 605.317,958.35 607.668,975.121 610.018,983.916 612.369,1035.44 614.719,911.446 617.07,892.298 619.42,963.687 621.771,996.031 624.121,1015.2 626.472,862.314 628.822,982.181 631.173,841.935 633.523,753.317 635.874,836.052 638.224,880.415 640.575,977.978 642.925,947.552 645.275,895.165 647.626,781.791 649.976,960.985 652.327,813.86 654.677,815.631 657.028,919.956 659.378,926.706 661.729,961.959 664.079,847.634 666.43,921.529 668.78,997.752 671.131,763.982 673.481,711.053 675.832,790.891 678.182,1076.97 680.533,692.222 682.883,739.285 685.233,1064.49 687.584,1036.18 689.934,821.006 692.285,1116.55 694.635,766.433 696.986,970.739 699.336,857.478 701.687,997.717 704.037,819.777 706.388,846.302 708.738,965.684 711.089,858.817 713.439,1027.89 715.79,897.777 718.14,910.45 720.491,1040.87 722.841,999.939 725.192,882.741 727.542,847.636 729.892,982.234 732.243,926.427 734.593,848.316 736.944,1096.27 739.294,745.498 741.645,895.706 743.995,930.324 746.346,966.073 748.696,945.72 751.047,1130.88 753.397,896.202 755.748,829.732 758.098,892.967 760.449,862.751 762.799,1053.33 765.15,961.261 767.5,978.277 769.85,985.716 772.201,902.46 774.551,948.752 776.902,950.191 779.252,953.949 781.603,801.518 783.953,786.245 786.304,907.785 788.654,737.011 791.005,1138.16 793.355,1073.23 795.706,1017.83 798.056,845.074 800.407,792.67 802.757,828.495 805.108,974.028 807.458,913.37 809.809,933.224 812.159,1010.63 814.509,814.265 816.86,949.556 819.21,798.038 821.561,1064.78 823.911,887.183 826.262,905.986 828.612,914.538 830.963,802.874 833.313,994.539 835.664,848.75 838.014,1014.86 840.365,787.473 842.715,770.016 845.066,972.601 847.416,868.439 849.767,1025.2 852.117,762.996 854.467,767.696 856.818,719.223 859.168,844.536 861.519,903.44 863.869,1030.93 866.22,970.78 868.57,983.715 870.921,1138.45 873.271,1056.6 875.622,926.602 877.972,878.916 880.323,1047.56 882.673,941.299 885.024,684.457 887.374,731.514 889.725,973.149 892.075,849.109 894.426,1094.78 896.776,1045.38 899.126,830.872 901.477,1067.16 903.827,979.068 906.178,829.008 908.528,894.592 910.879,920.864 913.229,996.441 915.58,927.021 917.93,885.74 920.281,851.513 922.631,938.951 924.982,833.493 927.332,922.038 929.683,1072.78 932.033,858.5 934.384,1013.83 936.734,890.047 939.084,822.97 941.435,934.982 943.785,809.596 946.136,853.207 948.486,1012.25 950.837,881.757 953.187,1019.15 955.538,973.344 957.888,1078.05 960.239,1010.7 962.589,957.649 964.94,1035.59 967.29,884.636 969.641,1059 971.991,866.493 974.342,853.172 976.692,945.88 979.043,1034.91 981.393,812.944 983.743,941.595 986.094,807.994 988.444,1042.15 990.795,1011.35 993.145,884.229 995.496,749.316 997.846,1040.27 1000.2,1112.96 1002.55,798.759 1004.9,683.359 1007.25,881.853 1009.6,836.993 1011.95,933.499 1014.3,791.903 1016.65,870.158 1019,836.703 1021.35,1001.22 1023.7,916.309 1026.05,984.681 1028.4,898.728 1030.75,1075.8 1033.1,970.96 1035.45,1046.91 1037.8,978.041 1040.15,1032.14 1042.51,1104.74 1044.86,1073.61 1047.21,965.642 1049.56,991.557 1051.91,937.736 1054.26,944.099 1056.61,1065.5 1058.96,809.016 1061.31,714.682 1063.66,974.488 1066.01,785.205 1068.36,1152.09 1070.71,1021.76 1073.06,820.806 1075.41,766.736 1077.76,821.031 1080.11,843.253 1082.46,971.168 1084.81,980.671 1087.16,949.356 1089.51,1037.79 1091.87,869.744 1094.22,1154.13 1096.57,862.439 1098.92,870.609 1101.27,886.705 1103.62,984.313 1105.97,858.363 1108.32,1031.32 1110.67,898.7 1113.02,791.49 1115.37,962.143 1117.72,1024.11 1120.07,856.517 1122.42,913.895 1124.77,845.45 1127.12,1077.58 1129.47,1012.77 1131.82,868.863 1134.17,857.292 1136.52,895.579 1138.87,985.677 1141.23,1029.27 1143.58,1041.7 1145.93,938.48 1148.28,1088.15 1150.63,927.515 1152.98,938.573 1155.33,1020.66 1157.68,990.366 1160.03,856.317 1162.38,837.011 1164.73,828.899 1167.08,792.002 1169.43,1040.56 1171.78,1104.54 1174.13,865.403 1176.48,983.926 1178.83,814.947 1181.18,799.937 1183.53,1042.86 1185.88,940.018 1188.23,825.599 1190.59,810.027 1192.94,768.293 1195.29,896.454 1197.64,848.413 1199.99,918.79 1202.34,796.32 1204.69,988.638 1207.04,790.952 1209.39,968.815 1211.74,923.431 1214.09,940.499 1216.44,838.309 1218.79,953.116 1221.14,862.44 1223.49,776.711 1225.84,828.439 1228.19,902.607 1230.54,972.215 1232.89,1019.85 1235.24,1028.39 1237.59,851.08 1239.94,1056.3 1242.3,768.65 1244.65,961.903 1247,999.359 1249.35,946.211 1251.7,938.616 1254.05,894.388 1256.4,779.039 1258.75,1011.18 1261.1,945.565 1263.45,882.146 1265.8,1032.78 1268.15,1047.47 1270.5,960.103 1272.85,961.361 1275.2,899.329 1277.55,893.201 1279.9,850.1 1282.25,896.62 1284.6,1034.83 1286.95,968.879 1289.3,802.897 1291.66,938.553 1294.01,830.551 1296.36,763.361 1298.71,833.425 1301.06,784.931 1303.41,883.552 1305.76,1000.68 1308.11,851.252 1310.46,901.671 1312.81,892.73 1315.16,930.426 1317.51,953.726 1319.86,905.097 1322.21,864.127 1324.56,861.159 1326.91,986.074 1329.26,945.731 1331.61,988.776 1333.96,899.032 1336.31,928.871 1338.66,895.449 1341.02,738.168 1343.37,841.353 1345.72,837.731 1348.07,1147.92 1350.42,799.045 1352.77,840.575 1355.12,1035.63 1357.47,1007.87 1359.82,1202.4 1362.17,919.423 1364.52,870.633 1366.87,858.244 1369.22,874.58 1371.57,993.893 1373.92,922.128 1376.27,714.106 1378.62,807.74 1380.97,907.868 1383.32,767.715 1385.67,925.426 1388.02,830.318 1390.38,871.293 1392.73,973.211 1395.08,970.097 1397.43,1101.26 1399.78,925.549 1402.13,941.885 1404.48,839.484 1406.83,770.275 1409.18,846.389 1411.53,1050.08 1413.88,1008.73 1416.23,994.049 1418.58,834.779 1420.93,938.017 1423.28,846.361 1425.63,810.106 1427.98,980.115 1430.33,858.792 1432.68,944.739 1435.03,1007.72 1437.38,766.534 1439.74,876.136 1442.09,777.208 1444.44,865.415 1446.79,1123.43 1449.14,942.811 1451.49,964.809 1453.84,927.021 1456.19,919.774 1458.54,948.205 1460.89,1015.29 1463.24,1015.66 1465.59,867.004 1467.94,902.331 1470.29,850.493 1472.64,1119.29 1474.99,820.922 1477.34,992.487 1479.69,857.651 1482.04,700.851 1484.39,769.316 1486.74,1021.81 1489.1,800.795 1491.45,953.013 1493.8,905.797 1496.15,816.196 1498.5,935.782 1500.85,1069.96 1503.2,925.896 1505.55,884.795 1507.9,884.666 1510.25,1045.72 1512.6,825.467 1514.95,921.06 1517.3,985.987 1519.65,746.118 1522,1024.58 1524.35,809.115 1526.7,1036.47 1529.05,905.741 1531.4,1092.85 1533.75,858.51 1536.1,1002.26 1538.45,1023.24 1540.81,744.837 1543.16,1000.21 1545.51,906.096 1547.86,917.197 1550.21,976.374 1552.56,974.514 1554.91,965.712 1557.26,1002.01 1559.61,1060.59 1561.96,905.614 1564.31,860.565 1566.66,1021.27 1569.01,917.741 1571.36,884.602 1573.71,991.35 1576.06,819.625 1578.41,879.022 1580.76,952.998 1583.11,836.686 1585.46,939.465 1587.81,1083.95 1590.17,798.59 1592.52,804.393 1594.87,795.305 1597.22,984.482 1599.57,991.214 1601.92,895.236 1604.27,757.075 1606.62,937.961 1608.97,936.502 1611.32,982.262 1613.67,1022.62 1616.02,851.217 1618.37,972.75 1620.72,1152.54 1623.07,969.535 1625.42,929.445 1627.77,884.32 1630.12,1040.72 1632.47,905.149 1634.82,965.745 1637.17,817.509 1639.53,928.365 1641.88,937.728 1644.23,664.211 1646.58,981.168 1648.93,997.824 1651.28,1004.97 1653.63,929.931 1655.98,794.497 1658.33,932.887 1660.68,1037.42 1663.03,846.222 1665.38,856.316 1667.73,776.049 1670.08,1000.48 1672.43,871.192 1674.78,758.578 1677.13,857.265 1679.48,863.656 1681.83,672.402 1684.18,965.976 1686.53,787.308 1688.89,913.525 1691.24,1035.2 1693.59,916.589 1695.94,910.724 1698.29,1085.17 1700.64,729.894 1702.99,1162.59 1705.34,825.483 1707.69,911.213 1710.04,1093.05 1712.39,841.799 1714.74,790.462 1717.09,903.582 1719.44,946.095 1721.79,694.129 1724.14,746.346 1726.49,1005.58 1728.84,826.617 1731.19,900.445 1733.54,903.152 1735.89,915.292 1738.25,882.713 1740.6,883.204 1742.95,933.972 1745.3,970.401 1747.65,951.245 1750,827.807 1752.35,1010.25 1754.7,955.361 1757.05,842.657 1759.4,858.262 1761.75,1051.27 1764.1,835.092 1766.45,929.85 1768.8,898.764 1771.15,995.324 1773.5,958.853 1775.85,783.849 1778.2,881.569 1780.55,1096.71 1782.9,719.374 1785.25,780.94 1787.6,1007.57 1789.96,890.393 1792.31,756.89 1794.66,741.236 1797.01,934.152 1799.36,1019.77 1801.71,927.884 1804.06,961.534 1806.41,622.615 1808.76,997.817 1811.11,872.26 1813.46,846.586 1815.81,1057.06 1818.16,1133.16 1820.51,822.612 1822.86,976.774 1825.21,1104.53 1827.56,1043.13 1829.91,918.49 1832.26,1018.75 1834.61,949.309 1836.96,901.591 1839.32,1029.12 1841.67,912.77 1844.02,836.499 1846.37,878.588 1848.72,916.006 1851.07,803.603 1853.42,903.295 1855.77,776.959 1858.12,989.614 1860.47,803.665 1862.82,930.26 1865.17,1035.74 1867.52,1038.83 1869.87,874.133 1872.22,766.232 1874.57,1109.36 1876.92,881.968 1879.27,959.315 1881.62,832.662 1883.97,827.366 1886.32,926.501 1888.68,957.945 1891.03,858.234 1893.38,964.337 1895.73,861.952 1898.08,760.423 1900.43,820.937 1902.78,1020.56 1905.13,818.833 1907.48,873.797 1909.83,998.341 1912.18,913.053 1914.53,868.004 1916.88,1077.65 1919.23,895.134 1921.58,824.453 1923.93,831.805 1926.28,974.776 1928.63,730.767 1930.98,883.914 1933.33,861.566 1935.68,904.179 1938.04,830.637 1940.39,1032.46 1942.74,1148.94 1945.09,906.293 1947.44,989.692 1949.79,915.148 1952.14,1031.45 1954.49,869.077 1956.84,847.439 1959.19,933.903 1961.54,1045.49 1963.89,857.053 1966.24,1055.62 1968.59,765.798 1970.94,892.018 1973.29,916.239 1975.64,861.05 1977.99,1079.87 1980.34,1053.36 1982.69,836.006 1985.04,792.268 1987.4,964.809 1989.75,852.049 1992.1,1142.77 1994.45,857.774 1996.8,850.546 1999.15,863.591 2001.5,870.656 2003.85,1019.94 2006.2,955.714 2008.55,965.169 2010.9,1084.38 2013.25,713.452 2015.6,1096.24 2017.95,943.327 2020.3,856.73 2022.65,746.186 2025,1088.27 2027.35,941.567 2029.7,594.768 2032.05,820.278 2034.4,1017.83 2036.76,987.449 2039.11,866.008 2041.46,923.563 2043.81,944.151 2046.16,923.862 2048.51,906.686 2050.86,1001.64 2053.21,905.818 2055.56,1054.39 2057.91,987.222 2060.26,880.03 2062.61,915.391 2064.96,929.73 2067.31,809.059 2069.66,1088.86 2072.01,771.2 2074.36,670.015 2076.71,1043 2079.06,1059.87 2081.41,871.268 2083.76,712.191 2086.11,914.169 2088.47,843.102 2090.82,887.047 2093.17,970.383 2095.52,864.55 2097.87,779.067 2100.22,995 2102.57,913.543 2104.92,975.126 2107.27,855.294 2109.62,776.014 2111.97,842.705 2114.32,865.492 2116.67,1000.87 2119.02,815.187 2121.37,889.419 2123.72,873.079 2126.07,768.376 2128.42,1002.94 2130.77,774.998 2133.12,837.541 2135.47,752.714 2137.83,1109.58 2140.18,824.836 2142.53,1043.77 2144.88,999.785 2147.23,962.714 2149.58,1035.32 2151.93,939.997 2154.28,948.785 2156.63,922.444 2158.98,830.875 2161.33,764.315 2163.68,770.875 2166.03,942.028 2168.38,737.716 2170.73,1017.98 2173.08,969.337 2175.43,845.411 2177.78,996.53 2180.13,977.005 2182.48,945.461 2184.83,1013.04 2187.19,811.852 2189.54,950.245 2191.89,933.154 2194.24,935.79 2196.59,927.621 2198.94,903.866 2201.29,814.695 2203.64,1023.54 2205.99,850.817 2208.34,1037.49 2210.69,819.81 2213.04,941.29 2215.39,974.351 2217.74,887.624 2220.09,986.137 2222.44,876.054 2224.79,720.077 2227.14,1029.77 2229.49,947.081 2231.84,1023.5 2234.19,905.867 2236.55,1106.52 2238.9,845.927 2241.25,891.177 2243.6,811.751 2245.95,794.956 2248.3,837.843 2250.65,899.754 2253,937.993 2255.35,882.931 2257.7,976.235 2260.05,917.763 2262.4,770.5 2264.75,893.227 2267.1,1034.39 2269.45,1043.16 2271.8,736.308 2274.15,910.477 2276.5,961.741 2278.85,913.333 2281.2,920.621 2283.55,678.949 2285.91,854.393 2288.26,1013.46 2290.61,931.995 2292.96,751.449 2295.31,951.343 2297.66,927.168 2300.01,777.047 2302.36,864.943 2304.71,1024.39 2307.06,984.661 2309.41,836.986 2311.76,939.943 2314.11,953.758 2316.46,795.362 2318.81,1027.76 2321.16,882.779 2323.51,805.425 2325.86,941.884 2328.21,915.321 2330.56,771.429 2332.91,778.004 2335.27,949.254 2337.62,888.937 2339.97,999.213 2342.32,852.569 2344.67,914.419 2347.02,997.419 2349.37,852.412 2351.72,871.778 2354.07,1010.47 2356.42,1036.94 2358.77,964.619 2361.12,1001.17 2363.47,899.462 2365.82,789.379 2368.17,817.461 2370.52,929.398 2372.87,954.33 2375.22,956.907 2377.57,902.823 2379.92,1002.36 2382.27,939.621 2384.62,864.924 2386.98,936.288 2389.33,817.971 2391.68,1002.76 2394.03,912.408 2396.38,981.857 2398.73,944.585 2401.08,886.51 2403.43,719.793 2405.78,836.956 2408.13,854.504 2410.48,796.656 2412.83,944.541 2415.18,851.093 2417.53,1017.35 2419.88,1003.27 2422.23,919.056 2424.58,890.757 2426.93,919.085 2429.28,808.018 2431.63,919.216 2433.98,1007.44 2436.34,1133.88 2438.69,895.471 2441.04,918.972 2443.39,864.736 2445.74,877.156 2448.09,1068.64 2450.44,939.651 2452.79,802.143 2455.14,794.593 2457.49,854.963 2459.84,1029.6 2462.19,1106.57 2464.54,1170.46 2466.89,903.598 2469.24,1015.3 2471.59,941.325 2473.94,888.383 2476.29,904.937 2478.64,782.174 2480.99,860.969 2483.34,917.499 2485.7,828.405 2488.05,1022.35 2490.4,881.426 2492.75,890.012 2495.1,833.107 2497.45,985.384 2499.8,876.053 2502.15,978.474 2504.5,1042.94 2506.85,864.722 2509.2,1109.4 2511.55,780.687 2513.9,898.227 2516.25,893.404 2518.6,775.688 2520.95,817.513 2523.3,920.305 2525.65,975.005 2528,955.964 2530.35,950.752 2532.7,997.936 2535.06,1061.97 2537.41,1025.54 2539.76,1078.3 2542.11,807.888 2544.46,928.992 2546.81,623.313 2549.16,941.663 2551.51,996.731 2553.86,899.546 2556.21,946.132 2558.56,900.646 2560.91,796.926 2563.26,1050.49 2565.61,967.266 2567.96,811.291 2570.31,916.579 "></polyline>
<polyline clip-path="url(#clip662)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:0.5; fill:none" points="222.19,627.582 224.541,524.614 226.891,431.37 229.242,319 231.592,319.431 233.943,424.323 236.293,411.659 238.644,425.709 240.994,424.725 243.345,485.426 245.695,369.768 248.046,475.377 250.396,463.362 252.747,392.467 255.097,433.863 257.448,515.158 259.798,397.329 262.148,574.41 264.499,336.947 266.849,497.344 269.2,485.676 271.55,401.321 273.901,548.844 276.251,373.989 278.602,656.557 280.952,374.33 283.303,458.209 285.653,561.042 288.004,278.599 290.354,399.661 292.705,609.302 295.055,490.749 297.406,411.303 299.756,440.661 302.107,408.461 304.457,401.864 306.807,500.122 309.158,345.509 311.508,411.884 313.859,349.182 316.209,366.491 318.56,476.185 320.91,390.783 323.261,410.409 325.611,178.962 327.962,335.327 330.312,178.778 332.663,283.537 335.013,498.329 337.364,278.259 339.714,365.914 342.065,429.027 344.415,280.676 346.765,500.193 349.116,439.695 351.466,271.56 353.817,514.739 356.167,363.833 358.518,407.434 360.868,424.588 363.219,386.361 365.569,291.961 367.92,439.535 370.27,434.391 372.621,503.79 374.971,381.781 377.322,281.087 379.672,351.218 382.023,643.065 384.373,631.825 386.724,277.556 389.074,372.323 391.424,445.701 393.775,227.236 396.125,533.965 398.476,510.392 400.826,475.551 403.177,311.878 405.527,545.38 407.878,386.052 410.228,470.405 412.579,539.366 414.929,459.451 417.28,210.682 419.63,398.101 421.981,381.533 424.331,382.459 426.682,96.8724 429.032,445.771 431.382,363.928 433.733,320.412 436.083,378.245 438.434,353.601 440.784,375.353 443.135,553.894 445.485,314.932 447.836,502.104 450.186,416.173 452.537,384.87 454.887,383.64 457.238,416.582 459.588,405.023 461.939,341.284 464.289,387.386 466.64,424.234 468.99,602.437 471.341,463.316 473.691,469.794 476.041,219.173 478.392,392.09 480.742,304.591 483.093,453.226 485.443,472.929 487.794,284.436 490.144,292.591 492.495,393.665 494.845,243.626 497.196,473.281 499.546,427.937 501.897,488.249 504.247,453.329 506.598,495.217 508.948,462.033 511.299,478.663 513.649,540.697 515.999,403.847 518.35,305.94 520.7,357.6 523.051,505.775 525.401,408.356 527.752,514.653 530.102,464.734 532.453,475.354 534.803,546.195 537.154,382.062 539.504,408.601 541.855,454.628 544.205,531.158 546.556,294.314 548.906,388.996 551.257,433.971 553.607,569.708 555.958,246.245 558.308,399.071 560.658,589.759 563.009,555.828 565.359,538.4 567.71,448.705 570.06,418.546 572.411,389.24 574.761,345.875 577.112,421.366 579.462,282.972 581.813,406.736 584.163,330.256 586.514,468.033 588.864,451.46 591.215,427.859 593.565,310.393 595.916,418.856 598.266,649.183 600.616,370.976 602.967,541.234 605.317,432.533 607.668,565.358 610.018,303.659 612.369,610.862 614.719,527.635 617.07,371.236 619.42,342.507 621.771,525.879 624.121,600.55 626.472,348.816 628.822,485.508 631.173,477.521 633.523,527.886 635.874,454.468 638.224,477.711 640.575,516.7 642.925,468.637 645.275,495.885 647.626,447.48 649.976,498.916 652.327,502.206 654.677,553.78 657.028,291.07 659.378,314.8 661.729,405.329 664.079,395.647 666.43,302.014 668.78,358.226 671.131,590.938 673.481,584.893 675.832,482.923 678.182,328.649 680.533,518.721 682.883,511.661 685.233,591.033 687.584,484.283 689.934,467.191 692.285,392.264 694.635,410.08 696.986,659.155 699.336,612.489 701.687,564.439 704.037,588.736 706.388,424.548 708.738,470.259 711.089,527.351 713.439,477.171 715.79,494.446 718.14,370.738 720.491,523.913 722.841,408.56 725.192,632.165 727.542,362.854 729.892,547.476 732.243,250.025 734.593,323.928 736.944,676.81 739.294,412.433 741.645,519.438 743.995,488.813 746.346,518.907 748.696,401.008 751.047,389.031 753.397,217.07 755.748,372.35 758.098,332.577 760.449,400.807 762.799,591.195 765.15,515.153 767.5,192.951 769.85,276.944 772.201,244.664 774.551,404.825 776.902,501.684 779.252,370.715 781.603,412.621 783.953,411.226 786.304,634.275 788.654,545.691 791.005,397.652 793.355,390.348 795.706,324.125 798.056,368.727 800.407,477.391 802.757,240.874 805.108,451.121 807.458,516.536 809.809,558.001 812.159,330.256 814.509,422.946 816.86,509.393 819.21,358.893 821.561,548.258 823.911,421.63 826.262,373.518 828.612,492.118 830.963,596.662 833.313,563.014 835.664,357.998 838.014,615.409 840.365,580.912 842.715,542.368 845.066,428.305 847.416,545.632 849.767,290.2 852.117,373.08 854.467,397.239 856.818,419.048 859.168,399.837 861.519,402.381 863.869,403.99 866.22,340.363 868.57,424.66 870.921,450.789 873.271,613.219 875.622,315.717 877.972,461.586 880.323,361.677 882.673,550.291 885.024,223.511 887.374,317.463 889.725,391.728 892.075,446.161 894.426,537.441 896.776,473.414 899.126,437.201 901.477,522.653 903.827,455.853 906.178,426.907 908.528,303.828 910.879,405.005 913.229,439.781 915.58,510.599 917.93,537.009 920.281,502.116 922.631,458.014 924.982,426.195 927.332,448.606 929.683,373.25 932.033,398.669 934.384,431.469 936.734,398.608 939.084,457.337 941.435,374.839 943.785,372.766 946.136,266.103 948.486,364.562 950.837,283.122 953.187,465.226 955.538,397.007 957.888,481.278 960.239,211.351 962.589,400.162 964.94,493.396 967.29,329.028 969.641,380.207 971.991,467.663 974.342,408.392 976.692,529.809 979.043,529.195 981.393,248.902 983.743,373.62 986.094,461.55 988.444,518.342 990.795,395.651 993.145,570.54 995.496,284.667 997.846,524.68 1000.2,463.116 1002.55,331.113 1004.9,414.975 1007.25,379.801 1009.6,378.525 1011.95,404.969 1014.3,530.82 1016.65,284.66 1019,230.286 1021.35,436.675 1023.7,356.502 1026.05,475.29 1028.4,554.899 1030.75,323.562 1033.1,265.41 1035.45,334.051 1037.8,364.899 1040.15,295.98 1042.51,460.435 1044.86,645.09 1047.21,274.282 1049.56,442.202 1051.91,380.385 1054.26,325.617 1056.61,383.55 1058.96,314.64 1061.31,437.868 1063.66,300.144 1066.01,398.194 1068.36,492.525 1070.71,433.343 1073.06,318.46 1075.41,325.464 1077.76,524.894 1080.11,613.844 1082.46,629.085 1084.81,487.984 1087.16,516.88 1089.51,550.698 1091.87,383.583 1094.22,428.744 1096.57,336.892 1098.92,342.775 1101.27,402.446 1103.62,535.83 1105.97,346.593 1108.32,554.06 1110.67,354.499 1113.02,451.978 1115.37,505.509 1117.72,645.772 1120.07,209.042 1122.42,417.58 1124.77,345.014 1127.12,318.444 1129.47,572.778 1131.82,331.759 1134.17,445.441 1136.52,397.086 1138.87,549.366 1141.23,361.954 1143.58,478.497 1145.93,504.432 1148.28,501.921 1150.63,326.28 1152.98,209.177 1155.33,287.671 1157.68,373.492 1160.03,356.566 1162.38,396.12 1164.73,305.592 1167.08,259.346 1169.43,545.87 1171.78,493.592 1174.13,602.975 1176.48,392.218 1178.83,321.612 1181.18,495.961 1183.53,311.053 1185.88,445.254 1188.23,536.648 1190.59,328.411 1192.94,526.322 1195.29,335.264 1197.64,355.973 1199.99,400.152 1202.34,470.422 1204.69,411.767 1207.04,567.619 1209.39,631.665 1211.74,602.277 1214.09,383.473 1216.44,477.442 1218.79,448.449 1221.14,384.941 1223.49,210.925 1225.84,479.71 1228.19,341.713 1230.54,431.489 1232.89,550.496 1235.24,363.591 1237.59,447.995 1239.94,405.685 1242.3,552.167 1244.65,289.345 1247,380.054 1249.35,530.042 1251.7,453.284 1254.05,564.573 1256.4,618.936 1258.75,586.309 1261.1,587.665 1263.45,429.696 1265.8,422.873 1268.15,408.846 1270.5,347.758 1272.85,245.244 1275.2,555.641 1277.55,425.19 1279.9,319.374 1282.25,394.854 1284.6,198.904 1286.95,526.746 1289.3,432.638 1291.66,444.882 1294.01,601.843 1296.36,504.247 1298.71,448.547 1301.06,462.069 1303.41,375.622 1305.76,380.369 1308.11,311.096 1310.46,338.101 1312.81,581.826 1315.16,299.871 1317.51,407.444 1319.86,510.235 1322.21,419.456 1324.56,271.612 1326.91,386.328 1329.26,479.635 1331.61,382.263 1333.96,349.343 1336.31,356.89 1338.66,484.075 1341.02,555.639 1343.37,388.322 1345.72,503.701 1348.07,313.714 1350.42,529.993 1352.77,403.137 1355.12,655.859 1357.47,262.144 1359.82,457.816 1362.17,223.067 1364.52,262.313 1366.87,487.625 1369.22,342.158 1371.57,462.429 1373.92,357.274 1376.27,464.941 1378.62,313.046 1380.97,410.465 1383.32,569.097 1385.67,561.956 1388.02,473.603 1390.38,406.864 1392.73,325.807 1395.08,323.358 1397.43,576.321 1399.78,395.372 1402.13,378.907 1404.48,417.297 1406.83,216.401 1409.18,487.746 1411.53,470.425 1413.88,470.423 1416.23,493.855 1418.58,386.586 1420.93,472.135 1423.28,458.09 1425.63,467.297 1427.98,444.158 1430.33,333.339 1432.68,419.814 1435.03,474.99 1437.38,353.735 1439.74,457.588 1442.09,405.205 1444.44,456.29 1446.79,239.642 1449.14,537.13 1451.49,448.265 1453.84,348.224 1456.19,539.977 1458.54,345.375 1460.89,411.905 1463.24,601.909 1465.59,574.663 1467.94,623.615 1470.29,537.64 1472.64,422.088 1474.99,511.513 1477.34,343.199 1479.69,466.407 1482.04,396.607 1484.39,444.821 1486.74,450.81 1489.1,436.426 1491.45,438.298 1493.8,332.503 1496.15,211.964 1498.5,451.242 1500.85,391.233 1503.2,378.576 1505.55,550.799 1507.9,473.788 1510.25,345.527 1512.6,596.165 1514.95,488.404 1517.3,454.005 1519.65,468.481 1522,431.952 1524.35,559.852 1526.7,481.817 1529.05,306.086 1531.4,515.694 1533.75,247.099 1536.1,410.045 1538.45,298.305 1540.81,462.966 1543.16,361.61 1545.51,364.624 1547.86,437.906 1550.21,506.905 1552.56,205.995 1554.91,334.004 1557.26,401.347 1559.61,453.918 1561.96,614.878 1564.31,438.066 1566.66,551.356 1569.01,421.603 1571.36,439.767 1573.71,409.251 1576.06,538.026 1578.41,479.591 1580.76,447.511 1583.11,372.31 1585.46,456.801 1587.81,461.428 1590.17,487.658 1592.52,412.77 1594.87,523.513 1597.22,323.954 1599.57,434.142 1601.92,541.518 1604.27,372.151 1606.62,292.6 1608.97,566.559 1611.32,281.068 1613.67,324.105 1616.02,401.374 1618.37,212.161 1620.72,483.689 1623.07,321.251 1625.42,438.996 1627.77,421.179 1630.12,361.822 1632.47,456.598 1634.82,570.285 1637.17,397.561 1639.53,430.332 1641.88,367.503 1644.23,384.566 1646.58,442.452 1648.93,335.797 1651.28,649.083 1653.63,322.637 1655.98,399.966 1658.33,650.981 1660.68,355.051 1663.03,422.723 1665.38,442.304 1667.73,532.198 1670.08,436.749 1672.43,231.821 1674.78,266.748 1677.13,438.297 1679.48,386.489 1681.83,402.02 1684.18,252.402 1686.53,493.388 1688.89,274.616 1691.24,481.125 1693.59,309.92 1695.94,524.415 1698.29,380.543 1700.64,427.747 1702.99,500.504 1705.34,575.145 1707.69,236.937 1710.04,449.256 1712.39,425.138 1714.74,329.192 1717.09,439.738 1719.44,271.051 1721.79,668.51 1724.14,306.753 1726.49,497.837 1728.84,321.151 1731.19,517.037 1733.54,545.994 1735.89,522.845 1738.25,640.274 1740.6,629.342 1742.95,185.137 1745.3,361.234 1747.65,483.097 1750,300.914 1752.35,322.594 1754.7,369.198 1757.05,422.398 1759.4,398.459 1761.75,354.919 1764.1,493.525 1766.45,377.366 1768.8,552.043 1771.15,356.779 1773.5,440.685 1775.85,521.429 1778.2,363.039 1780.55,410.914 1782.9,421.499 1785.25,311.503 1787.6,375.425 1789.96,486.603 1792.31,438.302 1794.66,507.58 1797.01,590.617 1799.36,474.515 1801.71,424.615 1804.06,348.468 1806.41,428.377 1808.76,394.962 1811.11,509.155 1813.46,248.904 1815.81,355.122 1818.16,572.738 1820.51,452.73 1822.86,479.698 1825.21,412.683 1827.56,357.088 1829.91,542.453 1832.26,700.815 1834.61,371.241 1836.96,295.624 1839.32,568.336 1841.67,604.718 1844.02,482.571 1846.37,538.344 1848.72,460.454 1851.07,474.49 1853.42,398.591 1855.77,404.718 1858.12,373.974 1860.47,395.175 1862.82,274.589 1865.17,506.049 1867.52,455.321 1869.87,494.61 1872.22,433.184 1874.57,359.391 1876.92,363.429 1879.27,311.326 1881.62,429.108 1883.97,437.371 1886.32,307.432 1888.68,442.228 1891.03,427.142 1893.38,547.012 1895.73,357.877 1898.08,345.439 1900.43,593.964 1902.78,356.929 1905.13,636.714 1907.48,531.425 1909.83,500.669 1912.18,420.576 1914.53,338.505 1916.88,340.554 1919.23,344.509 1921.58,557.288 1923.93,460.236 1926.28,352.955 1928.63,324.952 1930.98,347.076 1933.33,398.604 1935.68,443.029 1938.04,372.077 1940.39,401.071 1942.74,460.522 1945.09,427.142 1947.44,423.187 1949.79,598.883 1952.14,335.374 1954.49,509.756 1956.84,706.528 1959.19,429.584 1961.54,518.574 1963.89,357.081 1966.24,502.4 1968.59,333.561 1970.94,559.779 1973.29,621.854 1975.64,462.412 1977.99,461.135 1980.34,540.511 1982.69,518.909 1985.04,559.294 1987.4,484.937 1989.75,441.147 1992.1,489.801 1994.45,388.345 1996.8,413.401 1999.15,346.911 2001.5,300.653 2003.85,557.914 2006.2,403.339 2008.55,534.299 2010.9,474.218 2013.25,506.948 2015.6,490.402 2017.95,333.883 2020.3,547.948 2022.65,503.402 2025,429.304 2027.35,497.671 2029.7,560.326 2032.05,430.659 2034.4,283.717 2036.76,571.812 2039.11,493.361 2041.46,223.811 2043.81,556.599 2046.16,495.54 2048.51,352.601 2050.86,411.358 2053.21,351.203 2055.56,552.203 2057.91,310.011 2060.26,385.548 2062.61,519.583 2064.96,250.752 2067.31,408.348 2069.66,396.283 2072.01,406.55 2074.36,332.374 2076.71,409.844 2079.06,265.541 2081.41,354.102 2083.76,359.374 2086.11,458.719 2088.47,334.166 2090.82,442.648 2093.17,578.822 2095.52,449.633 2097.87,395.977 2100.22,694.574 2102.57,295.623 2104.92,442.776 2107.27,316.332 2109.62,478.991 2111.97,532.014 2114.32,525.486 2116.67,450.312 2119.02,402.028 2121.37,489.061 2123.72,494.737 2126.07,442.944 2128.42,396.483 2130.77,308.407 2133.12,367.575 2135.47,413.355 2137.83,402.689 2140.18,488.108 2142.53,532.324 2144.88,559.207 2147.23,480.128 2149.58,328.837 2151.93,300.806 2154.28,560.039 2156.63,387.377 2158.98,421.433 2161.33,424.886 2163.68,370.317 2166.03,232.055 2168.38,361.35 2170.73,427.97 2173.08,444.425 2175.43,262.955 2177.78,686.569 2180.13,523.726 2182.48,523.261 2184.83,318.121 2187.19,366.044 2189.54,216.471 2191.89,546.076 2194.24,421.615 2196.59,365.123 2198.94,306.994 2201.29,506.21 2203.64,411.259 2205.99,380.389 2208.34,586.225 2210.69,361.672 2213.04,505.183 2215.39,463.969 2217.74,477.164 2220.09,576.367 2222.44,411.469 2224.79,434.831 2227.14,323.222 2229.49,490.309 2231.84,362.354 2234.19,574.83 2236.55,285.888 2238.9,226.217 2241.25,579.949 2243.6,303.627 2245.95,420.85 2248.3,442.232 2250.65,329.156 2253,385.177 2255.35,501.271 2257.7,499.205 2260.05,401.653 2262.4,412.498 2264.75,442.351 2267.1,315.46 2269.45,614.007 2271.8,503.562 2274.15,459.806 2276.5,347.652 2278.85,272.339 2281.2,556.786 2283.55,455.54 2285.91,276.12 2288.26,454.19 2290.61,479.922 2292.96,509.206 2295.31,423.626 2297.66,471.851 2300.01,454.861 2302.36,372.389 2304.71,380.026 2307.06,453.224 2309.41,323.948 2311.76,484.615 2314.11,569.821 2316.46,289.811 2318.81,468.599 2321.16,494.625 2323.51,355.476 2325.86,390.333 2328.21,498.637 2330.56,371.018 2332.91,544.347 2335.27,363.604 2337.62,577.909 2339.97,537.268 2342.32,530.841 2344.67,362.241 2347.02,614.704 2349.37,377.498 2351.72,193.685 2354.07,402.988 2356.42,510.32 2358.77,371.306 2361.12,437.579 2363.47,399.444 2365.82,556.879 2368.17,511.447 2370.52,519.455 2372.87,475.698 2375.22,297.739 2377.57,505.716 2379.92,527.047 2382.27,437.328 2384.62,454.339 2386.98,347.2 2389.33,376.577 2391.68,472.73 2394.03,475.19 2396.38,607.506 2398.73,541.324 2401.08,354.865 2403.43,464.231 2405.78,163.201 2408.13,433.43 2410.48,444.922 2412.83,477.109 2415.18,383.839 2417.53,355.452 2419.88,485.965 2422.23,392.45 2424.58,446.742 2426.93,510.652 2429.28,432.316 2431.63,433.876 2433.98,369.696 2436.34,278.499 2438.69,316.533 2441.04,538.059 2443.39,387.623 2445.74,510.63 2448.09,383.842 2450.44,419.262 2452.79,331.689 2455.14,371.387 2457.49,576.814 2459.84,380.531 2462.19,418.463 2464.54,525.571 2466.89,459.307 2469.24,303.495 2471.59,574.913 2473.94,447.213 2476.29,330.324 2478.64,511.091 2480.99,484.637 2483.34,287.848 2485.7,167.232 2488.05,419.378 2490.4,565.77 2492.75,478.899 2495.1,520.845 2497.45,526.307 2499.8,564.026 2502.15,213.531 2504.5,297.789 2506.85,259.224 2509.2,487.012 2511.55,450.757 2513.9,448.097 2516.25,322.254 2518.6,486.371 2520.95,346.716 2523.3,624.697 2525.65,471.637 2528,467.972 2530.35,465.665 2532.7,490.453 2535.06,430.571 2537.41,514.555 2539.76,321.64 2542.11,261.877 2544.46,572.486 2546.81,474.133 2549.16,595.718 2551.51,240.997 2553.86,345.385 2556.21,525.504 2558.56,542.59 2560.91,313.56 2563.26,315.95 2565.61,537.326 2567.96,455.975 2570.31,307.708 "></polyline>
</svg>
</div>
</div>
<p>Look at that! Things are working; amazin’.</p>
<p>We can also exploit <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a>’s parallel sampling capabilities:</p>
<div id="32" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run separate 4 chains for 10 000 iterations using threads to parallelize.</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>num_chains <span class="op">=</span> <span class="fl">4</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    model_with_grad,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    sampler,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MCMCThreads</span>(),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="fl">10_000</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    num_chains;</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note we need to provide an initial state for every chain.</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    initial_state<span class="op">=</span><span class="fu">fill</span>(state, num_chains),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">=</span><span class="cn">false</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>samples_array <span class="op">=</span> <span class="fu">stack</span>(<span class="fu">map</span>(stack, samples))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>┌ Warning: Only a single thread available: MCMC chains are not sampled in parallel
└ @ AbstractMCMC ~/.julia/packages/AbstractMCMC/YrmkI/src/sample.jl:310</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×10000×4 Array{Float64, 3}:
[:, :, 1] =
 -3.66697   -4.33252   -3.95824   -3.95824   …  -5.64903  -6.63343  -6.63343
 -0.183524   0.656812  -0.828014  -0.828014      1.16122   1.71518   1.71518
  3.40631    3.53617    3.7214     3.7214        4.02248   4.23901   4.23901

[:, :, 2] =
 -2.01698   -4.02336   -4.64995  -4.84499  …  -5.10658  -5.95699  -3.43375
 -0.567006   0.275127   1.11063  -0.02263      1.15419   1.42845   0.62161
  3.25544    6.12435    4.24892   5.33345      7.37157   6.01352   4.79487

[:, :, 3] =
 -1.77167   -3.65619  -3.35329  -4.0049     …  -4.69027  -5.04785  -5.04785
  0.478021  -1.00956  -0.70041   0.0299617      1.59595   1.14085   1.14085
  3.50395    2.20662   3.64028   3.75003        4.89347   5.12656   5.12656

[:, :, 4] =
 -1.63777   -3.69867  -5.19033   …  -4.9237    -4.9237    -6.13818
 -0.841367   1.84015   0.497377      0.121808   0.121808   0.845159
  3.88489    2.50463   5.28038       4.46713    4.46713    5.24404</code></pre>
</div>
</div>
<p>But the fact that we have to provide the <code>AbstractMCMC.sample</code> call, etc. with an <code>initial_state</code> to get started is a bit annoying. We can avoid this by also defining a <code>AbstractMCMC.step</code> <em>without</em> the <code>state</code> argument:</p>
<div id="34" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> AbstractMCMC.<span class="fu">step</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    rng<span class="op">::</span><span class="dt">Random.AbstractRNG</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    model_wrapper<span class="op">::</span><span class="dt">AbstractMCMC.LogDensityModel</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span><span class="dt">MALA</span>;</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: No state provided!</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">...</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_wrapper.logdensity</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's just create the initial state by sampling using  a Gaussian.</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">randn</span>(rng, LogDensityProblems.<span class="fu">dimension</span>(model))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x, <span class="fu">MALAState</span>(x)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Equipped with this, we no longer need to provide the <code>initial_state</code> everywhere:</p>
<div id="36" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model_with_grad, sampler, <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>samples_matrix <span class="op">=</span> <span class="fu">stack</span>(samples)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hcat</span>(<span class="fu">mean</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>), <span class="fu">std</span>(samples_matrix; dims<span class="op">=</span><span class="fl">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3×2 Matrix{Float64}:
 -5.01377     0.986505
 -0.00127702  0.996484
  5.00914     1.01181</code></pre>
</div>
</div>
</section>
<section id="using-our-sampler-with-turing.jl" class="level2">
<h2 class="anchored" data-anchor-id="using-our-sampler-with-turing.jl">Using our sampler with Turing.jl</h2>
<p>As we promised, all of this hassle of implementing our <code>MALA</code> sampler in a way that uses <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> and <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> gets us something more than <em>just</em> an “automatic” implementation of <code>AbstractMCMC.sample</code>.</p>
<p>It also enables use with Turing.jl through the <code>externalsampler</code>, but we need to do one final thing first: we need to tell Turing.jl how to extract a vector of parameters from the “sample” returned in our implementation of <code>AbstractMCMC.step</code>. In our case, the “sample” is just a <code>Vector{&lt;:Real}</code>, so we just need the following line:</p>
<div id="38" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Turing.jl.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Turing</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Overload the `getparams` method for our "sample" type, which is just a vector.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>Turing.Inference.<span class="fu">getparams</span>(<span class="op">::</span><span class="dt">Turing.Model</span>, x<span class="op">::</span><span class="dt">AbstractVector{&lt;:Real}</span>) <span class="op">=</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And with that, we’re good to go!</p>
<div id="40" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Our previous model defined as a Turing.jl model.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="fu">mvnormal_model</span>() <span class="op">=</span> x <span class="op">~</span> <span class="fu">MvNormal</span>([<span class="op">-</span><span class="fl">5</span>., <span class="fl">0</span>., <span class="fl">5</span>.], I)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate our model.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>turing_model <span class="op">=</span> <span class="fu">mvnormal_model</span>()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Call `sample` but now we're passing in a Turing.jl `model` and wrapping</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># our `MALA` sampler in the `externalsampler` to tell Turing.jl that the sampler</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># expects something that implements LogDensityProblems.jl.</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×4×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 2.51 seconds
Compute duration  = 2.51 seconds
parameters        = x[1], x[2], x[3]
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

        x[1]   -5.0226    0.9932    0.0168   3489.2835   5413.9484    0.9999   ⋯
        x[2]   -0.0060    0.9979    0.0172   3368.1120   5115.8969    1.0008   ⋯
        x[3]    5.0010    0.9893    0.0174   3231.8574   5135.2029    1.0009   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

        x[1]   -6.9205   -5.7038   -5.0239   -4.3432   -3.0744
        x[2]   -1.9333   -0.6824   -0.0067    0.6620    1.9655
        x[3]    3.0288    4.3427    5.0114    5.6627    6.9142
</pre>
</div>
</div>
</div>
<p>Pretty neat, eh?</p>
<section id="models-with-constrained-parameters" class="level3">
<h3 class="anchored" data-anchor-id="models-with-constrained-parameters">Models with constrained parameters</h3>
<p>One thing we’ve sort of glossed over in all of the above is that MALA, at least how we’ve implemented it, requires <span class="math inline">\(x\)</span> to live in <span class="math inline">\(\mathbb{R}^d\)</span> for some <span class="math inline">\(d &gt; 0\)</span>. If some of the parameters were in fact constrained, e.g.&nbsp;we were working with a <code>Beta</code> distribution which has support on the interval <span class="math inline">\((0, 1)\)</span>, <em>not</em> on <span class="math inline">\(\mathbb{R}^d\)</span>, we could easily end up outside of the valid range <span class="math inline">\((0, 1)\)</span>.</p>
<div id="42" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="fu">beta_model</span>() <span class="op">=</span> x <span class="op">~</span> <span class="fu">Beta</span>(<span class="fl">3</span>, <span class="fl">3</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>turing_model <span class="op">=</span> <span class="fu">beta_model</span>()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×2×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 1.65 seconds
Compute duration  = 1.65 seconds
parameters        = x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold">  ess_bulk </span> <span class="ansi-bold">  ess_tail </span> <span class="ansi-bold">    rhat </span>  ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg">   Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>  ⋯

           x    0.4988    0.1905    0.0029   4077.5612   5660.5719    1.0005   ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

           x    0.1443    0.3542    0.4995    0.6426    0.8504
</pre>
</div>
</div>
</div>
<p>Yep, that still works, but only because Turing.jl actually <em>transforms</em> the <code>turing_model</code> from constrained to unconstrained, so that the <code>sampler</code> provided to <code>externalsampler</code> is actually always working in unconstrained space! This is not always desirable, so we can turn this off:</p>
<div id="44" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(turing_model, <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">false</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×2×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 0.23 seconds
Compute duration  = 0.23 seconds
parameters        = x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

           x    0.5076    0.1487    0.0154    79.1492    27.7623    1.0543     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

           x    0.2133    0.3984    0.4998    0.6277    0.7829
</pre>
</div>
</div>
</div>
<p>The fun thing is that this still sort of works because</p>
<div id="46" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logpdf</span>(<span class="fu">Beta</span>(<span class="fl">3</span>, <span class="fl">3</span>), <span class="fl">10.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-Inf</code></pre>
</div>
</div>
<p>and so the samples that fall outside of the range are always rejected. But do notice how much worse all the diagnostics are, e.g.&nbsp;<code>ess_tail</code> is very poor compared to when we use <code>unconstrained=true</code>. Moreover, in more complex cases this won’t just result in a “nice” <code>-Inf</code> log-density value, but instead will error:</p>
<div id="48" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">demo</span>()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    σ² <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Normal</span>(), lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we end up with negative values for `σ²`, the `Normal` will error.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, σ²)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">demo</span>(), <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">false</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre>DomainError with Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}}(-0.12248726985105662,1.0,0.0):
Normal: the condition σ &gt;= zero(σ) is not satisfied.
Stacktrace:
  [1] <span class="ansi-bold">#371</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [2] <span class="ansi-bold">check_args</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">utils.jl:89</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [3] <span class="ansi-bold">#Normal#370</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [4] <span class="ansi-bold">Normal</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:36</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [5] <span class="ansi-bold">Normal</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Distributions/ji8PW/src/univariate/continuous/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">normal.jl:42</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [6] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">compiler.jl:579</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [7] <span class="ansi-bold">demo</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">__model__</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">__varinfo__</span>::DynamicPPL.TypedVarInfo<span class="ansi-bright-black-fg">{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}, Vector{Set{DynamicPPL.Selector}}}}, ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}</span>, <span class="ansi-bright-black-fg">__context__</span>::DynamicPPL.DefaultContext<span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:442</span>
  [8] <span class="ansi-bold">_evaluate!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:963</span><span class="ansi-bright-black-fg"> [inlined]</span>
  [9] <span class="ansi-bold">evaluate_threadunsafe!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:936</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [10] <span class="ansi-bold">evaluate!!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">model.jl:889</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [11] <span class="ansi-bold">logdensity</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">logdensityfunction.jl:94</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [12] <span class="ansi-bold">Fix1</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">./</span><span style="text-decoration:underline" class="ansi-bright-black-fg">operators.jl:1118</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [13] <span class="ansi-bold">vector_mode_dual_eval!</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">f</span>::Base.Fix1<span class="ansi-bright-black-fg">{typeof(LogDensityProblems.logdensity), LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}}</span>, <span class="ansi-bright-black-fg">cfg</span>::ForwardDiff.GradientConfig<span class="ansi-bright-black-fg">{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}</span>, <span class="ansi-bright-black-fg">x</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-cyan-fg">ForwardDiff</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">apiutils.jl:24</span>
 [14] <span class="ansi-bold">vector_mode_gradient!</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">result</span>::DiffResults.MutableDiffResult<span class="ansi-bright-black-fg">{1, Float64, Tuple{Vector{Float64}}}</span>, <span class="ansi-bright-black-fg">f</span>::Base.Fix1<span class="ansi-bright-black-fg">{typeof(LogDensityProblems.logdensity), LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}}</span>, <span class="ansi-bright-black-fg">x</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">cfg</span>::ForwardDiff.GradientConfig<span class="ansi-bright-black-fg">{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-cyan-fg">ForwardDiff</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">gradient.jl:96</span>
 [15] <span class="ansi-bold">gradient!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">gradient.jl:37</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [16] <span class="ansi-bold">gradient!</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/ForwardDiff/PcZ48/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">gradient.jl:35</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [17] <span class="ansi-bold">logdensity_and_gradient</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/LogDensityProblemsAD/rBlLq/ext/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">LogDensityProblemsADForwardDiffExt.jl:118</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [18] <span class="ansi-bold">leapfrog_step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">model</span>::LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity<span class="ansi-bright-black-fg">{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}</span>, <span class="ansi-bright-black-fg">x</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">p</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">ϵ</span>::Int64, <span class="ansi-bright-black-fg">M</span>::UniformScaling<span class="ansi-bright-black-fg">{Bool}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:291</span>
 [19] <span class="ansi-bold">step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model_wrapper</span>::AbstractMCMC.LogDensityModel<span class="ansi-bright-black-fg">{LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}}</span>, <span class="ansi-bright-black-fg">sampler</span>::MALA<span class="ansi-bright-black-fg">{Int64, UniformScaling{Bool}}</span>, <span class="ansi-bright-black-fg">state</span>::MALAState<span class="ansi-bright-black-fg">{Vector{Float64}}</span>; <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">Main.Notebook</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:262</span>
 [20] <span class="ansi-bold">step</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:244</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [21] <span class="ansi-bold">#step#108</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:90</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [22] <span class="ansi-bold">step</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler_wrapper</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">state</span>::Turing.Inference.TuringState<span class="ansi-bright-black-fg">{MALAState{Vector{Float64}}, LogDensityProblemsADForwardDiffExt.ForwardDiffLogDensity{LogDensityFunction{DynamicPPL.TypedVarInfo{@NamedTuple{σ²::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:σ², typeof(identity)}, Int64}, Vector{Truncated{Normal{Float64}, Continuous, Float64, Float64, Nothing}}, Vector{AbstractPPL.VarName{:σ², typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}, x::DynamicPPL.Metadata{Dict{AbstractPPL.VarName{:x, typeof(identity)}, Int64}, Vector{Normal{Float64}}, Vector{AbstractPPL.VarName{:x, typeof(identity)}}, Vector{Float64}, Vector{Set{DynamicPPL.Selector}}}}, Float64}, DynamicPPL.Model{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, DynamicPPL.DefaultContext}, ForwardDiff.Chunk{2}, ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, ForwardDiff.GradientConfig{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2, Vector{ForwardDiff.Dual{ForwardDiff.Tag{DynamicPPL.DynamicPPLTag, Float64}, Float64, 2}}}}}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-green-fg">Turing.Inference</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">abstractmcmc.jl:79</span>
 [23] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sample.jl:176</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [24] <span class="ansi-bold">macro expansion</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">logging.jl:16</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [25] <span class="ansi-bold">mcmcsample</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">N</span>::Int64; <span class="ansi-bright-black-fg">progress</span>::Bool, <span class="ansi-bright-black-fg">progressname</span>::String, <span class="ansi-bright-black-fg">callback</span>::Nothing, <span class="ansi-bright-black-fg">discard_initial</span>::Int64, <span class="ansi-bright-black-fg">thinning</span>::Int64, <span class="ansi-bright-black-fg">chain_type</span>::Type, <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-yellow-fg">AbstractMCMC</span> <span class="ansi-bright-black-fg">~/.julia/packages/AbstractMCMC/YrmkI/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sample.jl:120</span>
 [26] <span class="ansi-bold">sample</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">rng</span>::TaskLocalRNG, <span class="ansi-bright-black-fg">model</span>::DynamicPPL.Model<span class="ansi-bright-black-fg">{typeof(demo), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}</span>, <span class="ansi-bright-black-fg">sampler</span>::DynamicPPL.Sampler<span class="ansi-bright-black-fg">{Turing.Inference.ExternalSampler{MALA{Int64, UniformScaling{Bool}}, AutoForwardDiff{nothing, Nothing}, false}}</span>, <span class="ansi-bright-black-fg">N</span>::Int64; <span class="ansi-bright-black-fg">chain_type</span>::Type, <span class="ansi-bright-black-fg">resume_from</span>::Nothing, <span class="ansi-bright-black-fg">initial_state</span>::Nothing, <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{progress::Bool}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-magenta-fg">DynamicPPL</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sampler.jl:93</span>
 [27] <span class="ansi-bold">sample</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/DynamicPPL/E4kDs/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">sampler.jl:83</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [28] <span class="ansi-bold">#sample#4</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:263</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [29] <span class="ansi-bold">sample</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:256</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [30] <span class="ansi-bold">#sample#3</span>
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/.julia/packages/Turing/aAIq7/src/mcmc/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">Inference.jl:253</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [31] top-level scope
<span class="ansi-bright-black-fg">    @</span> <span class="ansi-bright-black-fg">~/work/docs/docs/tutorials/docs-17-implementing-samplers/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">index.qmd:444</span></pre>
</div>
</div>
</div>
<p>As expected, we run into a <code>DomainError</code> at some point, while if we set <code>unconstrained=true</code>, letting Turing.jl transform the model to a unconstrained form behind the scenes, everything works as expected:</p>
<div id="50" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">demo</span>(), <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">true</span>), <span class="fl">10_000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×3×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 0.56 seconds
Compute duration  = 0.56 seconds
parameters        = σ², x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

          σ²    1.1505    0.6762    0.1169    41.6830   146.8782    1.1415     ⋯
           x    1.8162    3.0288    0.6438    31.5274        NaN    1.2937     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

          σ²    0.0813    0.5236    1.0732    1.9068    2.1750
           x   -1.9365   -0.2253    0.2236    6.3846    6.3846
</pre>
</div>
</div>
</div>
<p>Neat!</p>
<p>Similarly, which automatic differentiation backend one should use can be specified through the <code>adtype</code> keyword argument too. For example, if we want to use <a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a> instead of the default <a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a>:</p>
<div id="52" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ReverseDiff</span>: ReverseDiff</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify that we want to use `AutoReverseDiff`.</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">demo</span>(),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">externalsampler</span>(sampler; unconstrained<span class="op">=</span><span class="cn">true</span>, adtype<span class="op">=</span><span class="fu">AutoReverseDiff</span>()),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="fl">10_000</span>;</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">=</span><span class="cn">false</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chains MCMC chain (10000×3×1 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 1
Samples per chain = 10000
Wall duration     = 2.97 seconds
Compute duration  = 2.97 seconds
parameters        = σ², x
internals         = lp

Summary Statistics
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    mean </span> <span class="ansi-bold">     std </span> <span class="ansi-bold">    mcse </span> <span class="ansi-bold"> ess_bulk </span> <span class="ansi-bold"> ess_tail </span> <span class="ansi-bold">    rhat </span> <span class="ansi-bold"> e</span> ⋯
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg">  Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg">  </span> ⋯

          σ²   13.2887    0.0000    0.0000        NaN        NaN       NaN     ⋯
           x   -0.8748    0.0000    0.0000        NaN        NaN       NaN     ⋯
<span class="ansi-cyan-fg">                                                                1 column omitted</span>

Quantiles
 <span class="ansi-bold"> parameters </span> <span class="ansi-bold">    2.5% </span> <span class="ansi-bold">   25.0% </span> <span class="ansi-bold">   50.0% </span> <span class="ansi-bold">   75.0% </span> <span class="ansi-bold">   97.5% </span>
 <span class="ansi-bright-black-fg">     Symbol </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span> <span class="ansi-bright-black-fg"> Float64 </span>

          σ²   13.2887   13.2887   13.2887   13.2887   13.2887
           x   -0.8748   -0.8748   -0.8748   -0.8748   -0.8748
</pre>
</div>
</div>
</div>
<p>Double-neat.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>At this point it’s worth maybe reminding ourselves what we did and also <em>why</em> we did it:</p>
<ol type="1">
<li>We define our models in the <a href="https://github.com/tpapp/LogDensityProblems.jl">LogDensityProblems.jl</a> interface because it makes the sampler agnostic to how the underlying model is implemented.</li>
<li>We implement our sampler in the <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> interface, which just means that our sampler is a subtype of <code>AbstractMCMC.AbstractSampler</code> and we implement the MCMC transition in <code>AbstractMCMC.step</code>.</li>
<li><ol type="1">
<li>and (2) makes it so our sampler can be used with a wide range of model implementations, amongst them being models implemented in both Turing.jl and Stan. This gives you, the inference implementer, a large collection of models to test your inference method on, in addition to allowing users of Turing.jl and Stan to try out your inference method with minimal effort.</li>
</ol></li>
</ol>


</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There is no such thing as a proper interface in Julia (at least not officially), and so we use the word “interface” here to mean a few minimal methods that needs to be implemented by any type that we treat as a target model.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/turinglang\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="pagination-link" aria-label="Variational Inference">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Variational Inference</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Turing is created by <a href="http://mlg.eng.cam.ac.uk/hong/" target="_blank">Hong Ge</a>, and lovingly maintained by the <a href="https://github.com/TuringLang/Turing.jl/graphs/contributors" target="_blank">core team</a> of volunteers. <br> The contents of this website are © 2024 under the terms of the <a href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE" target="_blank">MIT License</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-17-implementing-samplers/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/TuringLang">
      <i class="bi bi-twitter" role="img" aria-label="Turing Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/TuringLang/Turing.jl">
      <i class="bi bi-github" role="img" aria-label="Turing GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>